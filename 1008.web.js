/*! For license information please see 1008.web.js.LICENSE.txt */
"use strict";(self.webpackChunk_wixc3_stylable_playground_feature=self.webpackChunk_wixc3_stylable_playground_feature||[]).push([[1008],{61008:(t,e,n)=>{n.r(e),n.d(e,{AbstractUserDataWriter:()=>pm,Bytes:()=>lf,CACHE_SIZE_UNLIMITED:()=>$d,CollectionReference:()=>Pd,DocumentReference:()=>Ld,DocumentSnapshot:()=>jf,FieldPath:()=>cf,FieldValue:()=>df,Firestore:()=>zd,FirestoreError:()=>Ls,GeoPoint:()=>ff,LoadBundleTask:()=>jd,Query:()=>Vd,QueryConstraint:()=>Yf,QueryDocumentSnapshot:()=>$f,QuerySnapshot:()=>zf,SnapshotMetadata:()=>Gf,Timestamp:()=>Xs,Transaction:()=>Pm,WriteBatch:()=>vm,_DatabaseId:()=>yr,_DocumentKey:()=>br,_EmptyAppCheckTokenProvider:()=>js,_EmptyAuthCredentialsProvider:()=>Os,_FieldPath:()=>ir,_cast:()=>Nd,_debugAssert:()=>ks,_isBase64Available:()=>ar,_logWarn:()=>Ds,_setIndexConfiguration:()=>jm,_validateIsNotUsedTogether:()=>_d,addDoc:()=>km,arrayRemove:()=>Bm,arrayUnion:()=>Um,clearIndexedDbPersistence:()=>tf,collection:()=>Od,collectionGroup:()=>Fd,connectFirestoreEmulator:()=>Rd,deleteDoc:()=>Cm,deleteField:()=>Fm,disableNetwork:()=>sf,doc:()=>qd,documentId:()=>hf,enableIndexedDbPersistence:()=>Xd,enableMultiTabIndexedDbPersistence:()=>Jd,enableNetwork:()=>nf,endAt:()=>hm,endBefore:()=>cm,ensureFirestoreConfigured:()=>Hd,executeWrite:()=>Lm,getDoc:()=>bm,getDocFromCache:()=>Em,getDocFromServer:()=>Sm,getDocs:()=>_m,getDocsFromCache:()=>Am,getDocsFromServer:()=>Dm,getFirestore:()=>Wd,increment:()=>Km,initializeFirestore:()=>Qd,limit:()=>sm,limitToLast:()=>rm,loadBundle:()=>of,namedQuery:()=>af,onSnapshot:()=>Mm,onSnapshotsInSync:()=>Rm,orderBy:()=>em,query:()=>Xf,queryEqual:()=>Bd,refEqual:()=>Ud,runTransaction:()=>Om,serverTimestamp:()=>qm,setDoc:()=>xm,setLogLevel:()=>Ss,snapshotEqual:()=>Wf,startAfter:()=>am,startAt:()=>om,terminate:()=>rf,updateDoc:()=>Nm,waitForPendingWrites:()=>ef,where:()=>Zf,writeBatch:()=>Gm});var s,r=n(37034),i=n(46387),o=n(68207),a=n(83395),u="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},c={},h=h||{},l=u||self;function d(){}function f(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function m(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var g="closure_uid_"+(1e9*Math.random()>>>0),p=0;function y(t,e,n){return t.call.apply(t.bind,arguments)}function w(t,e,n){if(!t)throw Error();if(2<arguments.length){var s=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,s),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function v(t,e,n){return(v=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?y:w).apply(null,arguments)}function I(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function b(t,e){function n(){}n.prototype=e.prototype,t.Z=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.Vb=function(t,n,s){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return e.prototype[n].apply(t,r)}}function T(){this.s=this.s,this.o=this.o}var E={};T.prototype.s=!1,T.prototype.na=function(){if(!this.s&&(this.s=!0,this.M(),0)){var t=function(t){return Object.prototype.hasOwnProperty.call(t,g)&&t[g]||(t[g]=++p)}(this);delete E[t]}},T.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const S=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},_=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){const s=t.length,r="string"==typeof t?t.split(""):t;for(let i=0;i<s;i++)i in r&&e.call(n,r[i],i,t)};function A(t){return Array.prototype.concat.apply([],arguments)}function D(t){const e=t.length;if(0<e){const n=Array(e);for(let s=0;s<e;s++)n[s]=t[s];return n}return[]}function x(t){return/^[\s\xa0]*$/.test(t)}var N,C=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function k(t,e){return-1!=t.indexOf(e)}function M(t,e){return t<e?-1:t>e?1:0}t:{var R=l.navigator;if(R){var L=R.userAgent;if(L){N=L;break t}}N=""}function V(t,e,n){for(const s in t)e.call(n,t[s],s,t)}function P(t){const e={};for(const n in t)e[n]=t[n];return e}var O="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function F(t,e){let n,s;for(let e=1;e<arguments.length;e++){for(n in s=arguments[e],s)t[n]=s[n];for(let e=0;e<O.length;e++)n=O[e],Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=s[n])}}function q(t){return q[" "](t),t}q[" "]=d;var U,B,K=k(N,"Opera"),G=k(N,"Trident")||k(N,"MSIE"),j=k(N,"Edge"),$=j||G,z=k(N,"Gecko")&&!(k(N.toLowerCase(),"webkit")&&!k(N,"Edge"))&&!(k(N,"Trident")||k(N,"MSIE"))&&!k(N,"Edge"),Q=k(N.toLowerCase(),"webkit")&&!k(N,"Edge");function W(){var t=l.document;return t?t.documentMode:void 0}t:{var H="",Y=(B=N,z?/rv:([^\);]+)(\)|;)/.exec(B):j?/Edge\/([\d\.]+)/.exec(B):G?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(B):Q?/WebKit\/(\S+)/.exec(B):K?/(?:Version)[ \/]?(\S+)/.exec(B):void 0);if(Y&&(H=Y?Y[1]:""),G){var X=W();if(null!=X&&X>parseFloat(H)){U=String(X);break t}}U=H}var J,Z={};function tt(){return t=Z,Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=function(){let t=0;const e=C(String(U)).split("."),n=C("9").split("."),s=Math.max(e.length,n.length);for(let o=0;0==t&&o<s;o++){var r=e[o]||"",i=n[o]||"";do{if(r=/(\d*)(\D*)(.*)/.exec(r)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],0==r[0].length&&0==i[0].length)break;t=M(0==r[1].length?0:parseInt(r[1],10),0==i[1].length?0:parseInt(i[1],10))||M(0==r[2].length,0==i[2].length)||M(r[2],i[2]),r=r[3],i=i[3]}while(0==t)}return 0<=t}();var t}l.document&&G?J=W()||parseInt(U,10)||void 0:J=void 0;var et=J,nt=function(){if(!l.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{l.addEventListener("test",d,e),l.removeEventListener("test",d,e)}catch(t){}return t}();function st(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}function rt(t,e){if(st.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,s=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(z){t:{try{q(e.nodeName);var r=!0;break t}catch(t){}r=!1}r||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,s?(this.clientX=void 0!==s.clientX?s.clientX:s.pageX,this.clientY=void 0!==s.clientY?s.clientY:s.pageY,this.screenX=s.screenX||0,this.screenY=s.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:it[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&rt.Z.h.call(this)}}st.prototype.h=function(){this.defaultPrevented=!0},b(rt,st);var it={2:"touch",3:"pen",4:"mouse"};rt.prototype.h=function(){rt.Z.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var ot="closure_listenable_"+(1e6*Math.random()|0),at=0;function ut(t,e,n,s,r){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!s,this.ia=r,this.key=++at,this.ca=this.fa=!1}function ct(t){t.ca=!0,t.listener=null,t.proxy=null,t.src=null,t.ia=null}function ht(t){this.src=t,this.g={},this.h=0}function lt(t,e){var n=e.type;if(n in t.g){var s,r=t.g[n],i=S(r,e);(s=0<=i)&&Array.prototype.splice.call(r,i,1),s&&(ct(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function dt(t,e,n,s){for(var r=0;r<t.length;++r){var i=t[r];if(!i.ca&&i.listener==e&&i.capture==!!n&&i.ia==s)return r}return-1}ht.prototype.add=function(t,e,n,s,r){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=dt(t,e,s,r);return-1<o?(e=t[o],n||(e.fa=!1)):((e=new ut(e,this.src,i,!!s,r)).fa=n,t.push(e)),e};var ft="closure_lm_"+(1e6*Math.random()|0),mt={};function gt(t,e,n,s,r){if(s&&s.once)return yt(t,e,n,s,r);if(Array.isArray(e)){for(var i=0;i<e.length;i++)gt(t,e[i],n,s,r);return null}return n=St(n),t&&t[ot]?t.N(e,n,m(s)?!!s.capture:!!s,r):pt(t,e,n,!1,s,r)}function pt(t,e,n,s,r,i){if(!e)throw Error("Invalid event type");var o=m(r)?!!r.capture:!!r,a=Tt(t);if(a||(t[ft]=a=new ht(t)),(n=a.add(e,n,s,o,i)).proxy)return n;if(s=function(){var t=bt;return function e(n){return t.call(e.src,e.listener,n)}}(),n.proxy=s,s.src=t,s.listener=n,t.addEventListener)nt||(r=o),void 0===r&&(r=!1),t.addEventListener(e.toString(),s,r);else if(t.attachEvent)t.attachEvent(It(e.toString()),s);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(s)}return n}function yt(t,e,n,s,r){if(Array.isArray(e)){for(var i=0;i<e.length;i++)yt(t,e[i],n,s,r);return null}return n=St(n),t&&t[ot]?t.O(e,n,m(s)?!!s.capture:!!s,r):pt(t,e,n,!0,s,r)}function wt(t,e,n,s,r){if(Array.isArray(e))for(var i=0;i<e.length;i++)wt(t,e[i],n,s,r);else s=m(s)?!!s.capture:!!s,n=St(n),t&&t[ot]?(t=t.i,(e=String(e).toString())in t.g&&-1<(n=dt(i=t.g[e],n,s,r))&&(ct(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--))):t&&(t=Tt(t))&&(e=t.g[e.toString()],t=-1,e&&(t=dt(e,n,s,r)),(n=-1<t?e[t]:null)&&vt(n))}function vt(t){if("number"!=typeof t&&t&&!t.ca){var e=t.src;if(e&&e[ot])lt(e.i,t);else{var n=t.type,s=t.proxy;e.removeEventListener?e.removeEventListener(n,s,t.capture):e.detachEvent?e.detachEvent(It(n),s):e.addListener&&e.removeListener&&e.removeListener(s),(n=Tt(e))?(lt(n,t),0==n.h&&(n.src=null,e[ft]=null)):ct(t)}}}function It(t){return t in mt?mt[t]:mt[t]="on"+t}function bt(t,e){if(t.ca)t=!0;else{e=new rt(e,this);var n=t.listener,s=t.ia||t.src;t.fa&&vt(t),t=n.call(s,e)}return t}function Tt(t){return(t=t[ft])instanceof ht?t:null}var Et="__closure_events_fn_"+(1e9*Math.random()>>>0);function St(t){return"function"==typeof t?t:(t[Et]||(t[Et]=function(e){return t.handleEvent(e)}),t[Et])}function _t(){T.call(this),this.i=new ht(this),this.P=this,this.I=null}function At(t,e){var n,s=t.I;if(s)for(n=[];s;s=s.I)n.push(s);if(t=t.P,s=e.type||e,"string"==typeof e)e=new st(e,t);else if(e instanceof st)e.target=e.target||t;else{var r=e;F(e=new st(s,t),r)}if(r=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];r=Dt(o,s,!0,e)&&r}if(r=Dt(o=e.g=t,s,!0,e)&&r,r=Dt(o,s,!1,e)&&r,n)for(i=0;i<n.length;i++)r=Dt(o=e.g=n[i],s,!1,e)&&r}function Dt(t,e,n,s){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var r=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.ca&&o.capture==n){var a=o.listener,u=o.ia||o.src;o.fa&&lt(t.i,o),r=!1!==a.call(u,s)&&r}}return r&&!s.defaultPrevented}b(_t,T),_t.prototype[ot]=!0,_t.prototype.removeEventListener=function(t,e,n,s){wt(this,t,e,n,s)},_t.prototype.M=function(){if(_t.Z.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],s=0;s<n.length;s++)ct(n[s]);delete e.g[t],e.h--}}this.I=null},_t.prototype.N=function(t,e,n,s){return this.i.add(String(t),e,!1,n,s)},_t.prototype.O=function(t,e,n,s){return this.i.add(String(t),e,!0,n,s)};var xt=l.JSON.stringify;function Nt(){var t=Pt;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var Ct,kt=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new Mt),(t=>t.reset()));class Mt{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Rt(t){l.setTimeout((()=>{throw t}),0)}function Lt(t,e){Ct||function(){var t=l.Promise.resolve(void 0);Ct=function(){t.then(Ot)}}(),Vt||(Ct(),Vt=!0),Pt.add(t,e)}var Vt=!1,Pt=new class{constructor(){this.h=this.g=null}add(t,e){const n=kt.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}};function Ot(){for(var t;t=Nt();){try{t.h.call(t.g)}catch(t){Rt(t)}var e=kt;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}Vt=!1}function Ft(t,e){_t.call(this),this.h=t||1,this.g=e||l,this.j=v(this.kb,this),this.l=Date.now()}function qt(t){t.da=!1,t.S&&(t.g.clearTimeout(t.S),t.S=null)}function Ut(t,e,n){if("function"==typeof t)n&&(t=v(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=v(t.handleEvent,t)}return 2147483647<Number(e)?-1:l.setTimeout(t,e||0)}function Bt(t){t.g=Ut((()=>{t.g=null,t.i&&(t.i=!1,Bt(t))}),t.j);const e=t.h;t.h=null,t.m.apply(null,e)}b(Ft,_t),(s=Ft.prototype).da=!1,s.S=null,s.kb=function(){if(this.da){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-t):(this.S&&(this.g.clearTimeout(this.S),this.S=null),At(this,"tick"),this.da&&(qt(this),this.start()))}},s.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},s.M=function(){Ft.Z.M.call(this),qt(this),delete this.g};class Kt extends T{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:Bt(this)}M(){super.M(),this.g&&(l.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Gt(t){T.call(this),this.h=t,this.g={}}b(Gt,T);var jt=[];function $t(t,e,n,s){Array.isArray(n)||(n&&(jt[0]=n.toString()),n=jt);for(var r=0;r<n.length;r++){var i=gt(e,n[r],s||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function zt(t){V(t.g,(function(t,e){this.g.hasOwnProperty(e)&&vt(t)}),t),t.g={}}function Qt(){this.g=!0}function Wt(t,e,n,s){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var s=n[t];if(!(2>s.length)){var r=s[1];if(Array.isArray(r)&&!(1>r.length)){var i=r[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<r.length;o++)r[o]=""}}}return xt(n)}catch(t){return e}}(t,n)+(s?" "+s:"")}))}Gt.prototype.M=function(){Gt.Z.M.call(this),zt(this)},Gt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Qt.prototype.Aa=function(){this.g=!1},Qt.prototype.info=function(){};var Ht={},Yt=null;function Xt(){return Yt=Yt||new _t}function Jt(t){st.call(this,Ht.Ma,t)}function Zt(t){const e=Xt();At(e,new Jt(e,t))}function te(t,e){st.call(this,Ht.STAT_EVENT,t),this.stat=e}function ee(t){const e=Xt();At(e,new te(e,t))}function ne(t,e){st.call(this,Ht.Na,t),this.size=e}function se(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return l.setTimeout((function(){t()}),e)}Ht.Ma="serverreachability",b(Jt,st),Ht.STAT_EVENT="statevent",b(te,st),Ht.Na="timingevent",b(ne,st);var re={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},ie={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function oe(){}function ae(t){return t.h||(t.h=t.i())}function ue(){}oe.prototype.h=null;var ce,he={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function le(){st.call(this,"d")}function de(){st.call(this,"c")}function fe(){}function me(t,e,n,s){this.l=t,this.j=e,this.m=n,this.X=s||1,this.V=new Gt(this),this.P=pe,t=$?125:void 0,this.W=new Ft(t),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new ge}function ge(){this.i=null,this.g="",this.h=!1}b(le,st),b(de,st),b(fe,oe),fe.prototype.g=function(){return new XMLHttpRequest},fe.prototype.i=function(){return{}},ce=new fe;var pe=45e3,ye={},we={};function ve(t,e,n){t.K=1,t.v=Ke(Pe(e)),t.s=n,t.U=!0,Ie(t,null)}function Ie(t,e){t.F=Date.now(),Se(t),t.A=Pe(t.v);var n=t.A,s=t.X;Array.isArray(s)||(s=[String(s)]),en(n.h,"t",s),t.C=0,n=t.l.H,t.h=new ge,t.g=ns(t.l,n?e:null,!t.s),0<t.O&&(t.L=new Kt(v(t.Ia,t,t.g),t.O)),$t(t.V,t.g,"readystatechange",t.gb),e=t.H?P(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ea(t.A,t.u,t.s,e)):(t.u="GET",t.g.ea(t.A,t.u,null,e)),Zt(1),function(t,e,n,s,r,i){t.info((function(){if(t.g)if(i)for(var o="",a=i.split("&"),u=0;u<a.length;u++){var c=a[u].split("=");if(1<c.length){var h=c[0];c=c[1];var l=h.split("_");o=2<=l.length&&"type"==l[1]?o+(h+"=")+c+"&":o+(h+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+s+") [attempt "+r+"]: "+e+"\n"+n+"\n"+o}))}(t.j,t.u,t.A,t.m,t.X,t.s)}function be(t){return!!t.g&&"GET"==t.u&&2!=t.K&&t.l.Ba}function Te(t,e,n){let s,r=!0;for(;!t.I&&t.C<n.length;){if(s=Ee(t,n),s==we){4==e&&(t.o=4,ee(14),r=!1),Wt(t.j,t.m,null,"[Incomplete Response]");break}if(s==ye){t.o=4,ee(15),Wt(t.j,t.m,n,"[Invalid Chunk]"),r=!1;break}Wt(t.j,t.m,s,null),Ne(t,s)}be(t)&&s!=we&&s!=ye&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,ee(16),r=!1),t.i=t.i&&r,r?0<n.length&&!t.aa&&(t.aa=!0,(e=t.l).g==t&&e.$&&!e.L&&(e.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),Wn(e),e.L=!0,ee(11))):(Wt(t.j,t.m,n,"[Invalid Chunked Response]"),xe(t),De(t))}function Ee(t,e){var n=t.C,s=e.indexOf("\n",n);return-1==s?we:(n=Number(e.substring(n,s)),isNaN(n)?ye:(s+=1)+n>e.length?we:(e=e.substr(s,n),t.C=s+n,e))}function Se(t){t.Y=Date.now()+t.P,_e(t,t.P)}function _e(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=se(v(t.eb,t),e)}function Ae(t){t.B&&(l.clearTimeout(t.B),t.B=null)}function De(t){0==t.l.G||t.I||Xn(t.l,t)}function xe(t){Ae(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,qt(t.W),zt(t.V),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function Ne(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||un(n.i,t)))if(n.I=t.N,!t.J&&un(n.i,t)&&3==n.G){try{var s=n.Ca.g.parse(e)}catch(t){s=null}if(Array.isArray(s)&&3==s.length){var r=s;if(0==r[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;Yn(n),qn(n)}Qn(n),ee(18)}}else n.ta=r[1],0<n.ta-n.U&&37500>r[2]&&n.N&&0==n.A&&!n.v&&(n.v=se(v(n.ab,n),6e3));if(1>=an(n.i)&&n.ka){try{n.ka()}catch(t){}n.ka=void 0}}else Zn(n,11)}else if((t.J||n.g==t)&&Yn(n),!x(e))for(r=n.Ca.g.parse(e),e=0;e<r.length;e++){let c=r[e];if(n.U=c[0],c=c[1],2==n.G)if("c"==c[0]){n.J=c[1],n.la=c[2];const e=c[3];null!=e&&(n.ma=e,n.h.info("VER="+n.ma));const r=c[4];null!=r&&(n.za=r,n.h.info("SVER="+n.za));const h=c[5];null!=h&&"number"==typeof h&&0<h&&(s=1.5*h,n.K=s,n.h.info("backChannelRequestTimeoutMs_="+s)),s=n;const l=t.g;if(l){const t=l.g?l.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var i=s.i;!i.g&&(k(t,"spdy")||k(t,"quic")||k(t,"h2"))&&(i.j=i.l,i.g=new Set,i.h&&(cn(i,i.h),i.h=null))}if(s.D){const t=l.g?l.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(s.sa=t,Be(s.F,s.D,t))}}n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-t.F,n.h.info("Handshake RTT: "+n.O+"ms"));var o=t;if((s=n).oa=es(s,s.H?s.la:null,s.W),o.J){hn(s.i,o);var a=o,u=s.K;u&&a.setTimeout(u),a.B&&(Ae(a),Se(a)),s.g=o}else zn(s);0<n.l.length&&Kn(n)}else"stop"!=c[0]&&"close"!=c[0]||Zn(n,7);else 3==n.G&&("stop"==c[0]||"close"==c[0]?"stop"==c[0]?Zn(n,7):Fn(n):"noop"!=c[0]&&n.j&&n.j.wa(c),n.A=0)}Zt(4)}catch(t){}}function Ce(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(f(t)||"string"==typeof t)_(t,e,void 0);else{if(t.T&&"function"==typeof t.T)var n=t.T();else if(t.R&&"function"==typeof t.R)n=void 0;else if(f(t)||"string"==typeof t){n=[];for(var s=t.length,r=0;r<s;r++)n.push(r)}else for(r in n=[],s=0,t)n[s++]=r;s=function(t){if(t.R&&"function"==typeof t.R)return t.R();if("string"==typeof t)return t.split("");if(f(t)){for(var e=[],n=t.length,s=0;s<n;s++)e.push(t[s]);return e}for(s in e=[],n=0,t)e[n++]=t[s];return e}(t),r=s.length;for(var i=0;i<r;i++)e.call(void 0,s[i],n&&n[i],t)}}function ke(t,e){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var s=0;s<n;s+=2)this.set(arguments[s],arguments[s+1])}else if(t)if(t instanceof ke)for(n=t.T(),s=0;s<n.length;s++)this.set(n[s],t.get(n[s]));else for(s in t)this.set(s,t[s])}function Me(t){if(t.i!=t.g.length){for(var e=0,n=0;e<t.g.length;){var s=t.g[e];Re(t.h,s)&&(t.g[n++]=s),e++}t.g.length=n}if(t.i!=t.g.length){var r={};for(n=e=0;e<t.g.length;)Re(r,s=t.g[e])||(t.g[n++]=s,r[s]=1),e++;t.g.length=n}}function Re(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(s=me.prototype).setTimeout=function(t){this.P=t},s.gb=function(t){t=t.target;const e=this.L;e&&3==Rn(t)?e.l():this.Ia(t)},s.Ia=function(t){try{if(t==this.g)t:{const h=Rn(this.g);var e=this.g.Da();const d=this.g.ba();if(!(3>h)&&(3!=h||$||this.g&&(this.h.h||this.g.ga()||Ln(this.g)))){this.I||4!=h||7==e||Zt(8==e||0>=d?3:2),Ae(this);var n=this.g.ba();this.N=n;e:if(be(this)){var s=Ln(this.g);t="";var r=s.length,i=4==Rn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){xe(this),De(this);var o="";break e}this.h.i=new l.TextDecoder}for(e=0;e<r;e++)this.h.h=!0,t+=this.h.i.decode(s[e],{stream:i&&e==r-1});s.splice(0,r),this.h.g+=t,this.C=0,o=this.h.g}else o=this.g.ga();if(this.i=200==n,function(t,e,n,s,r,i,o){t.info((function(){return"XMLHTTP RESP ("+s+") [ attempt "+r+"]: "+e+"\n"+n+"\n"+i+" "+o}))}(this.j,this.u,this.A,this.m,this.X,h,n),this.i){if(this.$&&!this.J){e:{if(this.g){var a,u=this.g;if((a=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!x(a)){var c=a;break e}}c=null}if(!(n=c)){this.i=!1,this.o=3,ee(12),xe(this),De(this);break t}Wt(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Ne(this,n)}this.U?(Te(this,h,o),$&&this.i&&3==h&&($t(this.V,this.W,"tick",this.fb),this.W.start())):(Wt(this.j,this.m,o,null),Ne(this,o)),4==h&&xe(this),this.i&&!this.I&&(4==h?Xn(this.l,this):(this.i=!1,Se(this)))}else 400==n&&0<o.indexOf("Unknown SID")?(this.o=3,ee(12)):(this.o=0,ee(13)),xe(this),De(this)}}}catch(t){}},s.fb=function(){if(this.g){var t=Rn(this.g),e=this.g.ga();this.C<e.length&&(Ae(this),Te(this,t,e),this.i&&4!=t&&Se(this))}},s.cancel=function(){this.I=!0,xe(this)},s.eb=function(){this.B=null;const t=Date.now();0<=t-this.Y?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.j,this.A),2!=this.K&&(Zt(3),ee(17)),xe(this),this.o=2,De(this)):_e(this,this.Y-t)},(s=ke.prototype).R=function(){Me(this);for(var t=[],e=0;e<this.g.length;e++)t.push(this.h[this.g[e]]);return t},s.T=function(){return Me(this),this.g.concat()},s.get=function(t,e){return Re(this.h,t)?this.h[t]:e},s.set=function(t,e){Re(this.h,t)||(this.i++,this.g.push(t)),this.h[t]=e},s.forEach=function(t,e){for(var n=this.T(),s=0;s<n.length;s++){var r=n[s],i=this.get(r);t.call(e,i,r,this)}};var Le=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Ve(t,e){if(this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,t instanceof Ve){this.g=void 0!==e?e:t.g,Oe(this,t.j),this.s=t.s,Fe(this,t.i),qe(this,t.m),this.l=t.l,e=t.h;var n=new Xe;n.i=e.i,e.g&&(n.g=new ke(e.g),n.h=e.h),Ue(this,n),this.o=t.o}else t&&(n=String(t).match(Le))?(this.g=!!e,Oe(this,n[1]||"",!0),this.s=Ge(n[2]||""),Fe(this,n[3]||"",!0),qe(this,n[4]),this.l=Ge(n[5]||"",!0),Ue(this,n[6]||"",!0),this.o=Ge(n[7]||"")):(this.g=!!e,this.h=new Xe(null,this.g))}function Pe(t){return new Ve(t)}function Oe(t,e,n){t.j=n?Ge(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function Fe(t,e,n){t.i=n?Ge(e,!0):e}function qe(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function Ue(t,e,n){e instanceof Xe?(t.h=e,function(t,e){e&&!t.j&&(Je(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(Ze(this,e),en(this,n,t))}),t)),t.j=e}(t.h,t.g)):(n||(e=je(e,He)),t.h=new Xe(e,t.g))}function Be(t,e,n){t.h.set(e,n)}function Ke(t){return Be(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function Ge(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function je(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,$e),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function $e(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}Ve.prototype.toString=function(){var t=[],e=this.j;e&&t.push(je(e,ze,!0),":");var n=this.i;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push(je(e,ze,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&t.push("/"),t.push(je(n,"/"==n.charAt(0)?We:Qe,!0))),(n=this.h.toString())&&t.push("?",n),(n=this.o)&&t.push("#",je(n,Ye)),t.join("")};var ze=/[#\/\?@]/g,Qe=/[#\?:]/g,We=/[#\?]/g,He=/[#\?@]/g,Ye=/#/g;function Xe(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function Je(t){t.g||(t.g=new ke,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var s=t[n].indexOf("="),r=null;if(0<=s){var i=t[n].substring(0,s);r=t[n].substring(s+1)}else i=t[n];e(i,r?decodeURIComponent(r.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function Ze(t,e){Je(t),e=nn(t,e),Re(t.g.h,e)&&(t.i=null,t.h-=t.g.get(e).length,Re((t=t.g).h,e)&&(delete t.h[e],t.i--,t.g.length>2*t.i&&Me(t)))}function tn(t,e){return Je(t),e=nn(t,e),Re(t.g.h,e)}function en(t,e,n){Ze(t,e),0<n.length&&(t.i=null,t.g.set(nn(t,e),D(n)),t.h+=n.length)}function nn(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}function sn(t){this.l=t||rn,t=l.PerformanceNavigationTiming?0<(t=l.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(l.g&&l.g.Ea&&l.g.Ea()&&l.g.Ea().Zb),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}(s=Xe.prototype).add=function(t,e){Je(this),this.i=null,t=nn(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},s.forEach=function(t,e){Je(this),this.g.forEach((function(n,s){_(n,(function(n){t.call(e,n,s,this)}),this)}),this)},s.T=function(){Je(this);for(var t=this.g.R(),e=this.g.T(),n=[],s=0;s<e.length;s++)for(var r=t[s],i=0;i<r.length;i++)n.push(e[s]);return n},s.R=function(t){Je(this);var e=[];if("string"==typeof t)tn(this,t)&&(e=A(e,this.g.get(nn(this,t))));else{t=this.g.R();for(var n=0;n<t.length;n++)e=A(e,t[n])}return e},s.set=function(t,e){return Je(this),this.i=null,tn(this,t=nn(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},s.get=function(t,e){return t&&0<(t=this.R(t)).length?String(t[0]):e},s.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var t=[],e=this.g.T(),n=0;n<e.length;n++){var s=e[n],r=encodeURIComponent(String(s));s=this.R(s);for(var i=0;i<s.length;i++){var o=r;""!==s[i]&&(o+="="+encodeURIComponent(String(s[i]))),t.push(o)}}return this.i=t.join("&")};var rn=10;function on(t){return!!t.h||!!t.g&&t.g.size>=t.j}function an(t){return t.h?1:t.g?t.g.size:0}function un(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function cn(t,e){t.g?t.g.add(e):t.h=e}function hn(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function ln(t){if(null!=t.h)return t.i.concat(t.h.D);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}return D(t.i)}function dn(){}function fn(){this.g=new dn}function mn(t,e,n){const s=n||"";try{Ce(t,(function(t,n){let r=t;m(t)&&(r=xt(t)),e.push(s+n+"="+encodeURIComponent(r))}))}catch(t){throw e.push(s+"type="+encodeURIComponent("_badmap")),t}}function gn(t,e,n,s,r){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,r(s)}catch(t){}}function pn(t){this.l=t.$b||null,this.j=t.ib||!1}function yn(t,e){_t.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=wn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}sn.prototype.cancel=function(){if(this.i=ln(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},dn.prototype.stringify=function(t){return l.JSON.stringify(t,void 0)},dn.prototype.parse=function(t){return l.JSON.parse(t,void 0)},b(pn,oe),pn.prototype.g=function(){return new yn(this.l,this.j)},pn.prototype.i=function(t){return function(){return t}}({}),b(yn,_t);var wn=0;function vn(t){t.j.read().then(t.Sa.bind(t)).catch(t.ha.bind(t))}function In(t){t.readyState=4,t.l=null,t.j=null,t.A=null,bn(t)}function bn(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(s=yn.prototype).open=function(t,e){if(this.readyState!=wn)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,bn(this)},s.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||l).fetch(new Request(this.B,e)).then(this.Va.bind(this),this.ha.bind(this))},s.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,In(this)),this.readyState=wn},s.Va=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,bn(this)),this.g&&(this.readyState=3,bn(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==l.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;vn(this)}else t.text().then(this.Ua.bind(this),this.ha.bind(this))},s.Sa=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?In(this):bn(this),3==this.readyState&&vn(this)}},s.Ua=function(t){this.g&&(this.response=this.responseText=t,In(this))},s.Ta=function(t){this.g&&(this.response=t,In(this))},s.ha=function(){this.g&&In(this)},s.setRequestHeader=function(t,e){this.v.append(t,e)},s.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},s.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(yn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var Tn=l.JSON.parse;function En(t){_t.call(this),this.headers=new ke,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=Sn,this.K=this.L=!1}b(En,_t);var Sn="",_n=/^https?$/i,An=["POST","PUT"];function Dn(t){return"content-type"==t.toLowerCase()}function xn(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Nn(t),kn(t)}function Nn(t){t.D||(t.D=!0,At(t,"complete"),At(t,"error"))}function Cn(t){if(t.h&&void 0!==h&&(!t.C[1]||4!=Rn(t)||2!=t.ba()))if(t.v&&4==Rn(t))Ut(t.Fa,0,t);else if(At(t,"readystatechange"),4==Rn(t)){t.h=!1;try{const a=t.ba();t:switch(a){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var s;if(s=0===a){var r=String(t.H).match(Le)[1]||null;if(!r&&l.self&&l.self.location){var i=l.self.location.protocol;r=i.substr(0,i.length-1)}s=!_n.test(r?r.toLowerCase():"")}n=s}if(n)At(t,"complete"),At(t,"success");else{t.m=6;try{var o=2<Rn(t)?t.g.statusText:""}catch(t){o=""}t.j=o+" ["+t.ba()+"]",Nn(t)}}finally{kn(t)}}}function kn(t,e){if(t.g){Mn(t);const n=t.g,s=t.C[0]?d:null;t.g=null,t.C=null,e||At(t,"ready");try{n.onreadystatechange=s}catch(t){}}}function Mn(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(l.clearTimeout(t.A),t.A=null)}function Rn(t){return t.g?t.g.readyState:0}function Ln(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case Sn:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function Vn(t,e,n){t:{for(s in n){var s=!1;break t}s=!0}s||(n=function(t){let e="";return V(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):Be(t,e,n))}function Pn(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function On(t){this.za=0,this.l=[],this.h=new Qt,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=Pn("failFast",!1,t),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=Pn("baseRetryDelayMs",5e3,t),this.$a=Pn("retryDelaySeedMs",1e4,t),this.Ya=Pn("forwardChannelMaxRetries",2,t),this.ra=Pn("forwardChannelRequestTimeoutMs",2e4,t),this.qa=t&&t.xmlHttpFactory||void 0,this.Ba=t&&t.Yb||!1,this.K=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.J="",this.i=new sn(t&&t.concurrentRequestLimit),this.Ca=new fn,this.ja=t&&t.fastHandshake||!1,this.Ra=t&&t.Wb||!1,t&&t.Aa&&this.h.Aa(),t&&t.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&t&&t.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!t||!1!==t.Xb}function Fn(t){if(Un(t),3==t.G){var e=t.V++,n=Pe(t.F);Be(n,"SID",t.J),Be(n,"RID",e),Be(n,"TYPE","terminate"),jn(t,n),(e=new me(t,t.h,e,void 0)).K=2,e.v=Ke(Pe(n)),n=!1,l.navigator&&l.navigator.sendBeacon&&(n=l.navigator.sendBeacon(e.v.toString(),"")),!n&&l.Image&&((new Image).src=e.v,n=!0),n||(e.g=ns(e.l,null),e.g.ea(e.v)),e.F=Date.now(),Se(e)}ts(t)}function qn(t){t.g&&(Wn(t),t.g.cancel(),t.g=null)}function Un(t){qn(t),t.u&&(l.clearTimeout(t.u),t.u=null),Yn(t),t.i.cancel(),t.m&&("number"==typeof t.m&&l.clearTimeout(t.m),t.m=null)}function Bn(t,e){t.l.push(new class{constructor(t,e){this.h=t,this.g=e}}(t.Za++,e)),3==t.G&&Kn(t)}function Kn(t){on(t.i)||t.m||(t.m=!0,Lt(t.Ha,t),t.C=0)}function Gn(t,e){var n;n=e?e.m:t.V++;const s=Pe(t.F);Be(s,"SID",t.J),Be(s,"RID",n),Be(s,"AID",t.U),jn(t,s),t.o&&t.s&&Vn(s,t.o,t.s),n=new me(t,t.h,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.l=e.D.concat(t.l)),e=$n(t,n,1e3),n.setTimeout(Math.round(.5*t.ra)+Math.round(.5*t.ra*Math.random())),cn(t.i,n),ve(n,s,e)}function jn(t,e){t.j&&Ce({},(function(t,n){Be(e,n,t)}))}function $n(t,e,n){n=Math.min(t.l.length,n);var s=t.j?v(t.j.Oa,t.j,t):null;t:{var r=t.l;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=r[0].h,t.push("ofs="+e)):e=0:t.push("ofs="+e);let i=!0;for(let o=0;o<n;o++){let n=r[o].h;const a=r[o].g;if(n-=e,0>n)e=Math.max(0,r[o].h-100),i=!1;else try{mn(a,t,"req"+n+"_")}catch(t){s&&s(a)}}if(i){s=t.join("&");break t}}}return t=t.l.splice(0,n),e.D=t,s}function zn(t){t.g||t.u||(t.Y=1,Lt(t.Ga,t),t.A=0)}function Qn(t){return!(t.g||t.u||3<=t.A||(t.Y++,t.u=se(v(t.Ga,t),Jn(t,t.A)),t.A++,0))}function Wn(t){null!=t.B&&(l.clearTimeout(t.B),t.B=null)}function Hn(t){t.g=new me(t,t.h,"rpc",t.Y),null===t.o&&(t.g.H=t.s),t.g.O=0;var e=Pe(t.oa);Be(e,"RID","rpc"),Be(e,"SID",t.J),Be(e,"CI",t.N?"0":"1"),Be(e,"AID",t.U),jn(t,e),Be(e,"TYPE","xmlhttp"),t.o&&t.s&&Vn(e,t.o,t.s),t.K&&t.g.setTimeout(t.K);var n=t.g;t=t.la,n.K=1,n.v=Ke(Pe(e)),n.s=null,n.U=!0,Ie(n,t)}function Yn(t){null!=t.v&&(l.clearTimeout(t.v),t.v=null)}function Xn(t,e){var n=null;if(t.g==e){Yn(t),Wn(t),t.g=null;var s=2}else{if(!un(t.i,e))return;n=e.D,hn(t.i,e),s=1}if(t.I=e.N,0!=t.G)if(e.i)if(1==s){n=e.s?e.s.length:0,e=Date.now()-e.F;var r=t.C;At(s=Xt(),new ne(s,n,e,r)),Kn(t)}else zn(t);else if(3==(r=e.o)||0==r&&0<t.I||!(1==s&&function(t,e){return!(an(t.i)>=t.i.j-(t.m?1:0)||(t.m?(t.l=e.D.concat(t.l),0):1==t.G||2==t.G||t.C>=(t.Xa?0:t.Ya)||(t.m=se(v(t.Ha,t,e),Jn(t,t.C)),t.C++,0)))}(t,e)||2==s&&Qn(t)))switch(n&&0<n.length&&(e=t.i,e.i=e.i.concat(n)),r){case 1:Zn(t,5);break;case 4:Zn(t,10);break;case 3:Zn(t,6);break;default:Zn(t,2)}}function Jn(t,e){let n=t.Pa+Math.floor(Math.random()*t.$a);return t.j||(n*=2),n*e}function Zn(t,e){if(t.h.info("Error code "+e),2==e){var n=null;t.j&&(n=null);var s=v(t.jb,t);n||(n=new Ve("//www.google.com/images/cleardot.gif"),l.location&&"http"==l.location.protocol||Oe(n,"https"),Ke(n)),function(t,e){const n=new Qt;if(l.Image){const s=new Image;s.onload=I(gn,n,s,"TestLoadImage: loaded",!0,e),s.onerror=I(gn,n,s,"TestLoadImage: error",!1,e),s.onabort=I(gn,n,s,"TestLoadImage: abort",!1,e),s.ontimeout=I(gn,n,s,"TestLoadImage: timeout",!1,e),l.setTimeout((function(){s.ontimeout&&s.ontimeout()}),1e4),s.src=t}else e(!1)}(n.toString(),s)}else ee(2);t.G=0,t.j&&t.j.va(e),ts(t),Un(t)}function ts(t){t.G=0,t.I=-1,t.j&&(0==ln(t.i).length&&0==t.l.length||(t.i.i.length=0,D(t.l),t.l.length=0),t.j.ua())}function es(t,e,n){let s=function(t){return t instanceof Ve?Pe(t):new Ve(t,void 0)}(n);if(""!=s.i)e&&Fe(s,e+"."+s.i),qe(s,s.m);else{const t=l.location;s=function(t,e,n,s){var r=new Ve(null,void 0);return t&&Oe(r,t),e&&Fe(r,e),n&&qe(r,n),s&&(r.l=s),r}(t.protocol,e?e+"."+t.hostname:t.hostname,+t.port,n)}return t.aa&&V(t.aa,(function(t,e){Be(s,e,t)})),e=t.D,n=t.sa,e&&n&&Be(s,e,n),Be(s,"VER",t.ma),jn(t,s),s}function ns(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Ba&&!t.qa?new En(new pn({ib:!0})):new En(t.qa)).L=t.H,e}function ss(){}function rs(){if(G&&!(10<=Number(et)))throw Error("Environmental error: no available transport.")}function is(t,e){_t.call(this),this.g=new On(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.P=t,(t=e&&e.httpHeadersOverwriteParam)&&!x(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!x(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&e in(t=this.h)&&delete t[e]),this.j=new us(this)}function os(t){le.call(this);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function as(){de.call(this),this.status=1}function us(t){this.g=t}(s=En.prototype).ea=function(t,e,n,s){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():ce.g(),this.C=this.u?ae(this.u):ae(ce),this.g.onreadystatechange=v(this.Fa,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void xn(this,t)}t=n||"";const r=new ke(this.headers);s&&Ce(s,(function(t,e){r.set(e,t)})),s=function(t){t:{var e=Dn;const n=t.length,s="string"==typeof t?t.split(""):t;for(let r=0;r<n;r++)if(r in s&&e.call(void 0,s[r],r,t)){e=r;break t}e=-1}return 0>e?null:"string"==typeof t?t.charAt(e):t[e]}(r.T()),n=l.FormData&&t instanceof l.FormData,!(0<=S(An,e))||s||n||r.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),r.forEach((function(t,e){this.g.setRequestHeader(e,t)}),this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Mn(this),0<this.B&&((this.K=function(t){return G&&tt()&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=v(this.pa,this)):this.A=Ut(this.pa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){xn(this,t)}},s.pa=function(){void 0!==h&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,At(this,"timeout"),this.abort(8))},s.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,At(this,"complete"),At(this,"abort"),kn(this))},s.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),kn(this,!0)),En.Z.M.call(this)},s.Fa=function(){this.s||(this.F||this.v||this.l?Cn(this):this.cb())},s.cb=function(){Cn(this)},s.ba=function(){try{return 2<Rn(this)?this.g.status:-1}catch(t){return-1}},s.ga=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},s.Qa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),Tn(e)}},s.Da=function(){return this.m},s.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(s=On.prototype).ma=8,s.G=1,s.hb=function(t){try{this.h.info("Origin Trials invoked: "+t)}catch(t){}},s.Ha=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.V=Math.floor(1e5*Math.random()),t=this.V++;const r=new me(this,this.h,t,void 0);let i=this.s;if(this.P&&(i?(i=P(i),F(i,this.P)):i=this.P),null===this.o&&(r.H=i),this.ja)t:{for(var e=0,n=0;n<this.l.length;n++){var s=this.l[n];if(void 0===(s="__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s.length:void 0))break;if(4096<(e+=s)){e=n;break t}if(4096===e||n===this.l.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=$n(this,r,e),Be(n=Pe(this.F),"RID",t),Be(n,"CVER",22),this.D&&Be(n,"X-HTTP-Session-Id",this.D),jn(this,n),this.o&&i&&Vn(n,this.o,i),cn(this.i,r),this.Ra&&Be(n,"TYPE","init"),this.ja?(Be(n,"$req",e),Be(n,"SID","null"),r.$=!0,ve(r,n,null)):ve(r,n,e),this.G=2}}else 3==this.G&&(t?Gn(this,t):0==this.l.length||on(this.i)||Gn(this))},s.Ga=function(){if(this.u=null,Hn(this),this.$&&!(this.L||null==this.g||0>=this.O)){var t=2*this.O;this.h.info("BP detection timer enabled: "+t),this.B=se(v(this.bb,this),t)}},s.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,ee(10),qn(this),Hn(this))},s.ab=function(){null!=this.v&&(this.v=null,qn(this),Qn(this),ee(19))},s.jb=function(t){t?(this.h.info("Successfully pinged google.com"),ee(2)):(this.h.info("Failed to ping google.com"),ee(1))},(s=ss.prototype).xa=function(){},s.wa=function(){},s.va=function(){},s.ua=function(){},s.Oa=function(){},rs.prototype.g=function(t,e){return new is(t,e)},b(is,_t),is.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;t.Wa&&(t.h.info("Origin Trials enabled."),Lt(v(t.hb,t,e))),ee(0),t.W=e,t.aa=n||{},t.N=t.X,t.F=es(t,null,t.W),Kn(t)},is.prototype.close=function(){Fn(this.g)},is.prototype.u=function(t){if("string"==typeof t){var e={};e.__data__=t,Bn(this.g,e)}else this.v?((e={}).__data__=xt(t),Bn(this.g,e)):Bn(this.g,t)},is.prototype.M=function(){this.g.j=null,delete this.j,Fn(this.g),delete this.g,is.Z.M.call(this)},b(os,le),b(as,de),b(us,ss),us.prototype.xa=function(){At(this.g,"a")},us.prototype.wa=function(t){At(this.g,new os(t))},us.prototype.va=function(t){At(this.g,new as(t))},us.prototype.ua=function(){At(this.g,"b")},rs.prototype.createWebChannel=rs.prototype.g,is.prototype.send=is.prototype.u,is.prototype.open=is.prototype.m,is.prototype.close=is.prototype.close,re.NO_ERROR=0,re.TIMEOUT=8,re.HTTP_ERROR=6,ie.COMPLETE="complete",ue.EventType=he,he.OPEN="a",he.CLOSE="b",he.ERROR="c",he.MESSAGE="d",_t.prototype.listen=_t.prototype.N,En.prototype.listenOnce=En.prototype.O,En.prototype.getLastError=En.prototype.La,En.prototype.getLastErrorCode=En.prototype.Da,En.prototype.getStatus=En.prototype.ba,En.prototype.getResponseJson=En.prototype.Qa,En.prototype.getResponseText=En.prototype.ga,En.prototype.send=En.prototype.ea;var cs=c.createWebChannelTransport=function(){return new rs},hs=c.getStatEventTarget=function(){return Xt()},ls=c.ErrorCode=re,ds=c.EventType=ie,fs=c.Event=Ht,ms=c.Stat={rb:0,ub:1,vb:2,Ob:3,Tb:4,Qb:5,Rb:6,Pb:7,Nb:8,Sb:9,PROXY:10,NOPROXY:11,Lb:12,Hb:13,Ib:14,Gb:15,Jb:16,Kb:17,nb:18,mb:19,ob:20},gs=c.FetchXmlHttpFactory=pn,ps=c.WebChannel=ue,ys=c.XhrIo=En,ws=n(34406);const vs="@firebase/firestore";class Is{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}Is.UNAUTHENTICATED=new Is(null),Is.GOOGLE_CREDENTIALS=new Is("google-credentials-uid"),Is.FIRST_PARTY=new Is("first-party-uid"),Is.MOCK_USER=new Is("mock-user");let bs="9.8.0";const Ts=new o.Yd("@firebase/firestore");function Es(){return Ts.logLevel}function Ss(t){Ts.setLogLevel(t)}function _s(t,...e){if(Ts.logLevel<=o.in.DEBUG){const n=e.map(xs);Ts.debug(`Firestore (${bs}): ${t}`,...n)}}function As(t,...e){if(Ts.logLevel<=o.in.ERROR){const n=e.map(xs);Ts.error(`Firestore (${bs}): ${t}`,...n)}}function Ds(t,...e){if(Ts.logLevel<=o.in.WARN){const n=e.map(xs);Ts.warn(`Firestore (${bs}): ${t}`,...n)}}function xs(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function Ns(t="Unexpected state"){const e=`FIRESTORE (${bs}) INTERNAL ASSERTION FAILED: `+t;throw As(e),new Error(e)}function Cs(t,e){t||Ns()}function ks(t,e){t||Ns()}function Ms(t,e){return t}const Rs={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Ls extends a.ZR{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Vs{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class Ps{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Os{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(Is.UNAUTHENTICATED)))}shutdown(){}}class Fs{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class qs{constructor(t){this.t=t,this.currentUser=Is.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const s=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let r=new Vs;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new Vs,t.enqueueRetryable((()=>s(this.currentUser)))};const i=()=>{const e=r;t.enqueueRetryable((async()=>{await e.promise,await s(this.currentUser)}))},o=t=>{_s("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(_s("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new Vs)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(_s("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Cs("string"==typeof e.accessToken),new Ps(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return Cs(null===t||"string"==typeof t),new Is(t)}}class Us{constructor(t,e,n){this.type="FirstParty",this.user=Is.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",e);const s=t.auth.getAuthHeaderValueForFirstParty([]);s&&this.headers.set("Authorization",s),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class Bs{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new Us(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable((()=>e(Is.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class Ks{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Gs{constructor(t){this.g=t,this.forceRefresh=!1,this.appCheck=null,this.p=null}start(t,e){const n=t=>{null!=t.error&&_s("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.p;return this.p=t.token,_s("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const s=t=>{_s("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.g.onInit((t=>s(t))),setTimeout((()=>{if(!this.appCheck){const t=this.g.getImmediate({optional:!0});t?s(t):_s("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(Cs("string"==typeof t.token),this.p=t.token,new Ks(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class js{getToken(){return Promise.resolve(new Ks(""))}invalidateToken(){}start(t,e){}shutdown(){}}class $s{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.I(t),this.T=t=>e.writeSequenceNumber(t))}I(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.T&&this.T(t),t}}function zs(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}$s.A=-1;class Qs{static R(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const s=zs(40);for(let r=0;r<s.length;++r)n.length<20&&s[r]<e&&(n+=t.charAt(s[r]%t.length))}return n}}function Ws(t,e){return t<e?-1:t>e?1:0}function Hs(t,e,n){return t.length===e.length&&t.every(((t,s)=>n(t,e[s])))}function Ys(t){return t+"\0"}class Xs{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new Ls(Rs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new Ls(Rs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Ls(Rs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new Ls(Rs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return Xs.fromMillis(Date.now())}static fromDate(t){return Xs.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new Xs(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?Ws(this.nanoseconds,t.nanoseconds):Ws(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Js{constructor(t){this.timestamp=t}static fromTimestamp(t){return new Js(t)}static min(){return new Js(new Xs(0,0))}static max(){return new Js(new Xs(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function Zs(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function tr(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function er(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class nr{constructor(t,e,n){void 0===e?e=0:e>t.length&&Ns(),void 0===n?n=t.length-e:n>t.length-e&&Ns(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===nr.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof nr?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let s=0;s<n;s++){const n=t.get(s),r=e.get(s);if(n<r)return-1;if(n>r)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class sr extends nr{construct(t,e,n){return new sr(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new sr(e)}static emptyPath(){return new sr([])}}const rr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class ir extends nr{construct(t,e,n){return new ir(t,e,n)}static isValidIdentifier(t){return rr.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),ir.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new ir(["__name__"])}static fromServerFormat(t){const e=[];let n="",s=0;const r=()=>{if(0===n.length)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;s<t.length;){const e=t[s];if("\\"===e){if(s+1===t.length)throw new Ls(Rs.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[s+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new Ls(Rs.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,s+=2}else"`"===e?(i=!i,s++):"."!==e||i?(n+=e,s++):(r(),s++)}if(r(),i)throw new Ls(Rs.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new ir(e)}static emptyPath(){return new ir([])}}class or{constructor(t){this.fields=t,t.sort(ir.comparator)}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Hs(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}function ar(){return"undefined"!=typeof atob}class ur{constructor(t){this.binaryString=t}static fromBase64String(t){const e=atob(t);return new ur(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new ur(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return Ws(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}ur.EMPTY_BYTE_STRING=new ur("");const cr=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function hr(t){if(Cs(!!t),"string"==typeof t){let e=0;const n=cr.exec(t);if(Cs(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const s=new Date(t);return{seconds:Math.floor(s.getTime()/1e3),nanos:e}}return{seconds:lr(t.seconds),nanos:lr(t.nanos)}}function lr(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function dr(t){return"string"==typeof t?ur.fromBase64String(t):ur.fromUint8Array(t)}function fr(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function mr(t){const e=t.mapValue.fields.__previous_value__;return fr(e)?mr(e):e}function gr(t){const e=hr(t.mapValue.fields.__local_write_time__.timestampValue);return new Xs(e.seconds,e.nanos)}class pr{constructor(t,e,n,s,r,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=s,this.ssl=r,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class yr{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new yr("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof yr&&t.projectId===this.projectId&&t.database===this.database}}function wr(t){return null==t}function vr(t){return 0===t&&1/t==-1/0}function Ir(t){return"number"==typeof t&&Number.isInteger(t)&&!vr(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}class br{constructor(t){this.path=t}static fromPath(t){return new br(sr.fromString(t))}static fromName(t){return new br(sr.fromString(t).popFirst(5))}static empty(){return new br(sr.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===sr.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return sr.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new br(new sr(t.slice()))}}const Tr={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Er={nullValue:"NULL_VALUE"};function Sr(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?fr(t)?4:Fr(t)?9007199254740991:10:Ns()}function _r(t,e){if(t===e)return!0;const n=Sr(t);if(n!==Sr(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return gr(t).isEqual(gr(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=hr(t.timestampValue),s=hr(e.timestampValue);return n.seconds===s.seconds&&n.nanos===s.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return dr(t.bytesValue).isEqual(dr(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return lr(t.geoPointValue.latitude)===lr(e.geoPointValue.latitude)&&lr(t.geoPointValue.longitude)===lr(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return lr(t.integerValue)===lr(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=lr(t.doubleValue),s=lr(e.doubleValue);return n===s?vr(n)===vr(s):isNaN(n)&&isNaN(s)}return!1}(t,e);case 9:return Hs(t.arrayValue.values||[],e.arrayValue.values||[],_r);case 10:return function(t,e){const n=t.mapValue.fields||{},s=e.mapValue.fields||{};if(Zs(n)!==Zs(s))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===s[t]||!_r(n[t],s[t])))return!1;return!0}(t,e);default:return Ns()}}function Ar(t,e){return void 0!==(t.values||[]).find((t=>_r(t,e)))}function Dr(t,e){if(t===e)return 0;const n=Sr(t),s=Sr(e);if(n!==s)return Ws(n,s);switch(n){case 0:case 9007199254740991:return 0;case 1:return Ws(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=lr(t.integerValue||t.doubleValue),s=lr(e.integerValue||e.doubleValue);return n<s?-1:n>s?1:n===s?0:isNaN(n)?isNaN(s)?0:-1:1}(t,e);case 3:return xr(t.timestampValue,e.timestampValue);case 4:return xr(gr(t),gr(e));case 5:return Ws(t.stringValue,e.stringValue);case 6:return function(t,e){const n=dr(t),s=dr(e);return n.compareTo(s)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),s=e.split("/");for(let t=0;t<n.length&&t<s.length;t++){const e=Ws(n[t],s[t]);if(0!==e)return e}return Ws(n.length,s.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=Ws(lr(t.latitude),lr(e.latitude));return 0!==n?n:Ws(lr(t.longitude),lr(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],s=e.values||[];for(let t=0;t<n.length&&t<s.length;++t){const e=Dr(n[t],s[t]);if(e)return e}return Ws(n.length,s.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){if(t===Tr.mapValue&&e===Tr.mapValue)return 0;if(t===Tr.mapValue)return 1;if(e===Tr.mapValue)return-1;const n=t.fields||{},s=Object.keys(n),r=e.fields||{},i=Object.keys(r);s.sort(),i.sort();for(let t=0;t<s.length&&t<i.length;++t){const e=Ws(s[t],i[t]);if(0!==e)return e;const o=Dr(n[s[t]],r[i[t]]);if(0!==o)return o}return Ws(s.length,i.length)}(t.mapValue,e.mapValue);default:throw Ns()}}function xr(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return Ws(t,e);const n=hr(t),s=hr(e),r=Ws(n.seconds,s.seconds);return 0!==r?r:Ws(n.nanos,s.nanos)}function Nr(t){return Cr(t)}function Cr(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=hr(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?dr(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,br.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const s of t.values||[])n?n=!1:e+=",",e+=Cr(s);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",s=!0;for(const r of e)s?s=!1:n+=",",n+=`${r}:${Cr(t.fields[r])}`;return n+"}"}(t.mapValue):Ns();var e,n}function kr(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function Mr(t){return!!t&&"integerValue"in t}function Rr(t){return!!t&&"arrayValue"in t}function Lr(t){return!!t&&"nullValue"in t}function Vr(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Pr(t){return!!t&&"mapValue"in t}function Or(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return tr(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=Or(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=Or(t.arrayValue.values[n]);return e}return Object.assign({},t)}function Fr(t){return"__max__"===(((t.mapValue||{}).fields||{}).__type__||{}).stringValue}function qr(t){return"nullValue"in t?Er:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?kr(yr.empty(),br.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?{mapValue:{}}:Ns()}function Ur(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?kr(yr.empty(),br.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?{mapValue:{}}:"mapValue"in t?Tr:Ns()}function Br(t,e){const n=Dr(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function Kr(t,e){const n=Dr(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class Gr{constructor(t){this.value=t}static empty(){return new Gr({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!Pr(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=Or(e)}setAll(t){let e=ir.emptyPath(),n={},s=[];t.forEach(((t,r)=>{if(!e.isImmediateParentOf(r)){const t=this.getFieldsMap(e);this.applyChanges(t,n,s),n={},s=[],e=r.popLast()}t?n[r.lastSegment()]=Or(t):s.push(r.lastSegment())}));const r=this.getFieldsMap(e);this.applyChanges(r,n,s)}delete(t){const e=this.field(t.popLast());Pr(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return _r(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let s=e.mapValue.fields[t.get(n)];Pr(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=s),e=s}return e.mapValue.fields}applyChanges(t,e,n){tr(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new Gr(Or(this.value))}}function jr(t){const e=[];return tr(t.fields,((t,n)=>{const s=new ir([t]);if(Pr(n)){const t=jr(n.mapValue).fields;if(0===t.length)e.push(s);else for(const n of t)e.push(s.child(n))}else e.push(s)})),new or(e)}class $r{constructor(t,e,n,s,r,i){this.key=t,this.documentType=e,this.version=n,this.readTime=s,this.data=r,this.documentState=i}static newInvalidDocument(t){return new $r(t,0,Js.min(),Js.min(),Gr.empty(),0)}static newFoundDocument(t,e,n){return new $r(t,1,e,Js.min(),n,0)}static newNoDocument(t,e){return new $r(t,2,e,Js.min(),Gr.empty(),0)}static newUnknownDocument(t,e){return new $r(t,3,e,Js.min(),Gr.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Gr.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Gr.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof $r&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new $r(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class zr{constructor(t,e,n,s){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=s}}function Qr(t){return t.fields.find((t=>2===t.kind))}function Wr(t){return t.fields.filter((t=>2!==t.kind))}zr.UNKNOWN_ID=-1;class Hr{constructor(t,e){this.fieldPath=t,this.kind=e}}class Yr{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new Yr(0,Zr.min())}}function Xr(t,e){const n=t.toTimestamp().seconds,s=t.toTimestamp().nanoseconds+1,r=Js.fromTimestamp(1e9===s?new Xs(n+1,0):new Xs(n,s));return new Zr(r,br.empty(),e)}function Jr(t){return new Zr(t.readTime,t.key,-1)}class Zr{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new Zr(Js.min(),br.empty(),-1)}static max(){return new Zr(Js.max(),br.empty(),-1)}}function ti(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=br.comparator(t.documentKey,e.documentKey),0!==n?n:Ws(t.largestBatchId,e.largestBatchId))}class ei{constructor(t,e){this.comparator=t,this.root=e||si.EMPTY}insert(t,e){return new ei(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,si.BLACK,null,null))}remove(t){return new ei(this.comparator,this.root.remove(t,this.comparator).copy(null,null,si.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const s=this.comparator(t,n.key);if(0===s)return e+n.left.size;s<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new ni(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new ni(this.root,t,this.comparator,!1)}getReverseIterator(){return new ni(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new ni(this.root,t,this.comparator,!0)}}class ni{constructor(t,e,n,s){this.isReverse=s,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?n(t.key,e):1,e&&s&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(0===r){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class si{constructor(t,e,n,s,r){this.key=t,this.value=e,this.color=null!=n?n:si.RED,this.left=null!=s?s:si.EMPTY,this.right=null!=r?r:si.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,s,r){return new si(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=s?s:this.left,null!=r?r:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let s=this;const r=n(t,s.key);return s=r<0?s.copy(null,null,null,s.left.insert(t,e,n),null):0===r?s.copy(null,e,null,null,null):s.copy(null,null,null,null,s.right.insert(t,e,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return si.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,s=this;if(e(t,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(t,e),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),0===e(t,s.key)){if(s.right.isEmpty())return si.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(t,e))}return s.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,si.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,si.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Ns();if(this.right.isRed())throw Ns();const t=this.left.check();if(t!==this.right.check())throw Ns();return t+(this.isRed()?0:1)}}si.EMPTY=null,si.RED=!0,si.BLACK=!1,si.EMPTY=new class{constructor(){this.size=0}get key(){throw Ns()}get value(){throw Ns()}get color(){throw Ns()}get left(){throw Ns()}get right(){throw Ns()}copy(t,e,n,s,r){return this}insert(t,e,n){return new si(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class ri{constructor(t){this.comparator=t,this.data=new ei(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const s=n.getNext();if(this.comparator(s.key,t[1])>=0)return;e(s.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new ii(this.data.getIterator())}getIteratorFrom(t){return new ii(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof ri))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(0!==this.comparator(t,s))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new ri(this.comparator);return e.data=t,e}}class ii{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function oi(t){return t.hasNext()?t.getNext():void 0}class ai{constructor(t,e=null,n=[],s=[],r=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=s,this.limit=r,this.startAt=i,this.endAt=o,this.P=null}}function ui(t,e=null,n=[],s=[],r=null,i=null,o=null){return new ai(t,e,n,s,r,i,o)}function ci(t){const e=Ms(t);if(null===e.P){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>{return(e=t).field.canonicalString()+e.op.toString()+Nr(e.value);var e})).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),wr(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>Nr(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>Nr(t))).join(",")),e.P=t}return e.P}function hi(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!Ai(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let r=0;r<t.filters.length;r++)if(n=t.filters[r],s=e.filters[r],n.op!==s.op||!n.field.isEqual(s.field)||!_r(n.value,s.value))return!1;var n,s;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!xi(t.startAt,e.startAt)&&xi(t.endAt,e.endAt)}function li(t){return br.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function di(t,e){return t.filters.filter((t=>t instanceof gi&&t.field.isEqual(e)))}function fi(t,e,n){let s=Er,r=!0;for(const n of di(t,e)){let t=Er,e=!0;switch(n.op){case"<":case"<=":t=qr(n.value);break;case"==":case"in":case">=":t=n.value;break;case">":t=n.value,e=!1;break;case"!=":case"not-in":t=Er}Br({value:s,inclusive:r},{value:t,inclusive:e})<0&&(s=t,r=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];Br({value:s,inclusive:r},{value:t,inclusive:n.inclusive})<0&&(s=t,r=n.inclusive);break}return{value:s,inclusive:r}}function mi(t,e,n){let s=Tr,r=!0;for(const n of di(t,e)){let t=Tr,e=!0;switch(n.op){case">=":case">":t=Ur(n.value),e=!1;break;case"==":case"in":case"<=":t=n.value;break;case"<":t=n.value,e=!1;break;case"!=":case"not-in":t=Tr}Kr({value:s,inclusive:r},{value:t,inclusive:e})>0&&(s=t,r=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];Kr({value:s,inclusive:r},{value:t,inclusive:n.inclusive})>0&&(s=t,r=n.inclusive);break}return{value:s,inclusive:r}}class gi extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.V(t,e,n):new pi(t,e,n):"array-contains"===e?new Ii(t,n):"in"===e?new bi(t,n):"not-in"===e?new Ti(t,n):"array-contains-any"===e?new Ei(t,n):new gi(t,e,n)}static V(t,e,n){return"in"===e?new yi(t,n):new wi(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.v(Dr(e,this.value)):null!==e&&Sr(this.value)===Sr(e)&&this.v(Dr(e,this.value))}v(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return Ns()}}S(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class pi extends gi{constructor(t,e,n){super(t,e,n),this.key=br.fromName(n.referenceValue)}matches(t){const e=br.comparator(t.key,this.key);return this.v(e)}}class yi extends gi{constructor(t,e){super(t,"in",e),this.keys=vi(0,e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class wi extends gi{constructor(t,e){super(t,"not-in",e),this.keys=vi(0,e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function vi(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>br.fromName(t.referenceValue)))}class Ii extends gi{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Rr(e)&&Ar(e.arrayValue,this.value)}}class bi extends gi{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&Ar(this.value.arrayValue,e)}}class Ti extends gi{constructor(t,e){super(t,"not-in",e)}matches(t){if(Ar(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!Ar(this.value.arrayValue,e)}}class Ei extends gi{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Rr(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>Ar(this.value.arrayValue,t)))}}class Si{constructor(t,e){this.position=t,this.inclusive=e}}class _i{constructor(t,e="asc"){this.field=t,this.dir=e}}function Ai(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function Di(t,e,n){let s=0;for(let r=0;r<t.position.length;r++){const i=e[r],o=t.position[r];if(s=i.field.isKeyField()?br.comparator(br.fromName(o.referenceValue),n.key):Dr(o,n.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function xi(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!_r(t.position[n],e.position[n]))return!1;return!0}class Ni{constructor(t,e=null,n=[],s=[],r=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=s,this.limit=r,this.limitType=i,this.startAt=o,this.endAt=a,this.D=null,this.C=null,this.startAt,this.endAt}}function Ci(t,e,n,s,r,i,o,a){return new Ni(t,e,n,s,r,i,o,a)}function ki(t){return new Ni(t)}function Mi(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function Ri(t){for(const e of t.filters)if(e.S())return e.field;return null}function Li(t){return null!==t.collectionGroup}function Vi(t){const e=Ms(t);if(null===e.D){e.D=[];const t=Ri(e),n=Mi(e);if(null!==t&&null===n)t.isKeyField()||e.D.push(new _i(t)),e.D.push(new _i(ir.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e.D.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.D.push(new _i(ir.keyField(),t))}}}return e.D}function Pi(t){const e=Ms(t);if(!e.C)if("F"===e.limitType)e.C=ui(e.path,e.collectionGroup,Vi(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const n of Vi(e)){const e="desc"===n.dir?"asc":"desc";t.push(new _i(n.field,e))}const n=e.endAt?new Si(e.endAt.position,e.endAt.inclusive):null,s=e.startAt?new Si(e.startAt.position,e.startAt.inclusive):null;e.C=ui(e.path,e.collectionGroup,t,e.filters,e.limit,n,s)}return e.C}function Oi(t,e,n){return new Ni(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function Fi(t,e){return hi(Pi(t),Pi(e))&&t.limitType===e.limitType}function qi(t){return`${ci(Pi(t))}|lt:${t.limitType}`}function Ui(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>{return`${(e=t).field.canonicalString()} ${e.op} ${Nr(e.value)}`;var e})).join(", ")}]`),wr(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>Nr(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>Nr(t))).join(",")),`Target(${e})`}(Pi(t))}; limitType=${t.limitType})`}function Bi(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):br.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of t.explicitOrderBy)if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const s=Di(t,e,n);return t.inclusive?s<=0:s<0}(t.startAt,Vi(t),e)||t.endAt&&!function(t,e,n){const s=Di(t,e,n);return t.inclusive?s>=0:s>0}(t.endAt,Vi(t),e))}(t,e)}function Ki(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function Gi(t){return(e,n)=>{let s=!1;for(const r of Vi(t)){const t=ji(r,e,n);if(0!==t)return t;s=s||r.field.isKeyField()}return 0}}function ji(t,e,n){const s=t.field.isKeyField()?br.comparator(e.key,n.key):function(t,e,n){const s=e.data.field(t),r=n.data.field(t);return null!==s&&null!==r?Dr(s,r):Ns()}(t.field,e,n);switch(t.dir){case"asc":return s;case"desc":return-1*s;default:return Ns()}}function $i(t,e){if(t.N){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:vr(e)?"-0":e}}function zi(t){return{integerValue:""+t}}function Qi(t,e){return Ir(e)?zi(e):$i(t,e)}class Wi{constructor(){this._=void 0}}function Hi(t,e,n){return t instanceof Ji?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof Zi?to(t,e):t instanceof eo?no(t,e):function(t,e){const n=Xi(t,e),s=ro(n)+ro(t.k);return Mr(n)&&Mr(t.k)?zi(s):$i(t.M,s)}(t,e)}function Yi(t,e,n){return t instanceof Zi?to(t,e):t instanceof eo?no(t,e):n}function Xi(t,e){return t instanceof so?Mr(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class Ji extends Wi{}class Zi extends Wi{constructor(t){super(),this.elements=t}}function to(t,e){const n=io(e);for(const e of t.elements)n.some((t=>_r(t,e)))||n.push(e);return{arrayValue:{values:n}}}class eo extends Wi{constructor(t){super(),this.elements=t}}function no(t,e){let n=io(e);for(const e of t.elements)n=n.filter((t=>!_r(t,e)));return{arrayValue:{values:n}}}class so extends Wi{constructor(t,e){super(),this.M=t,this.k=e}}function ro(t){return lr(t.integerValue||t.doubleValue)}function io(t){return Rr(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class oo{constructor(t,e){this.field=t,this.transform=e}}class ao{constructor(t,e){this.version=t,this.transformResults=e}}class uo{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new uo}static exists(t){return new uo(void 0,t)}static updateTime(t){return new uo(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function co(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class ho{}function lo(t,e,n){t instanceof yo?function(t,e,n){const s=t.value.clone(),r=Io(t.fieldTransforms,e,n.transformResults);s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):t instanceof wo?function(t,e,n){if(!co(t.precondition,e))return void e.convertToUnknownDocument(n.version);const s=Io(t.fieldTransforms,e,n.transformResults),r=e.data;r.setAll(vo(t)),r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function fo(t,e,n){t instanceof yo?function(t,e,n){if(!co(t.precondition,e))return;const s=t.value.clone(),r=bo(t.fieldTransforms,n,e);s.setAll(r),e.convertToFoundDocument(po(e),s).setHasLocalMutations()}(t,e,n):t instanceof wo?function(t,e,n){if(!co(t.precondition,e))return;const s=bo(t.fieldTransforms,n,e),r=e.data;r.setAll(vo(t)),r.setAll(s),e.convertToFoundDocument(po(e),r).setHasLocalMutations()}(t,e,n):function(t,e){co(t.precondition,e)&&e.convertToNoDocument(Js.min())}(t,e)}function mo(t,e){let n=null;for(const s of t.fieldTransforms){const t=e.data.field(s.field),r=Xi(s.transform,t||null);null!=r&&(null==n&&(n=Gr.empty()),n.set(s.field,r))}return n||null}function go(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&Hs(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof Zi&&e instanceof Zi||t instanceof eo&&e instanceof eo?Hs(t.elements,e.elements,_r):t instanceof so&&e instanceof so?_r(t.k,e.k):t instanceof Ji&&e instanceof Ji}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}function po(t){return t.isFoundDocument()?t.version:Js.min()}class yo extends ho{constructor(t,e,n,s=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=s,this.type=0}}class wo extends ho{constructor(t,e,n,s,r=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=s,this.fieldTransforms=r,this.type=1}}function vo(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const s=t.data.field(n);e.set(n,s)}})),e}function Io(t,e,n){const s=new Map;Cs(t.length===n.length);for(let r=0;r<n.length;r++){const i=t[r],o=i.transform,a=e.data.field(i.field);s.set(i.field,Yi(o,a,n[r]))}return s}function bo(t,e,n){const s=new Map;for(const r of t){const t=r.transform,i=n.data.field(r.field);s.set(r.field,Hi(t,i,e))}return s}class To extends ho{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}}class Eo extends ho{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}}class So{constructor(t){this.count=t}}var _o,Ao;function Do(t){switch(t){default:return Ns();case Rs.CANCELLED:case Rs.UNKNOWN:case Rs.DEADLINE_EXCEEDED:case Rs.RESOURCE_EXHAUSTED:case Rs.INTERNAL:case Rs.UNAVAILABLE:case Rs.UNAUTHENTICATED:return!1;case Rs.INVALID_ARGUMENT:case Rs.NOT_FOUND:case Rs.ALREADY_EXISTS:case Rs.PERMISSION_DENIED:case Rs.FAILED_PRECONDITION:case Rs.ABORTED:case Rs.OUT_OF_RANGE:case Rs.UNIMPLEMENTED:case Rs.DATA_LOSS:return!0}}function xo(t){if(void 0===t)return As("GRPC error has no .code"),Rs.UNKNOWN;switch(t){case _o.OK:return Rs.OK;case _o.CANCELLED:return Rs.CANCELLED;case _o.UNKNOWN:return Rs.UNKNOWN;case _o.DEADLINE_EXCEEDED:return Rs.DEADLINE_EXCEEDED;case _o.RESOURCE_EXHAUSTED:return Rs.RESOURCE_EXHAUSTED;case _o.INTERNAL:return Rs.INTERNAL;case _o.UNAVAILABLE:return Rs.UNAVAILABLE;case _o.UNAUTHENTICATED:return Rs.UNAUTHENTICATED;case _o.INVALID_ARGUMENT:return Rs.INVALID_ARGUMENT;case _o.NOT_FOUND:return Rs.NOT_FOUND;case _o.ALREADY_EXISTS:return Rs.ALREADY_EXISTS;case _o.PERMISSION_DENIED:return Rs.PERMISSION_DENIED;case _o.FAILED_PRECONDITION:return Rs.FAILED_PRECONDITION;case _o.ABORTED:return Rs.ABORTED;case _o.OUT_OF_RANGE:return Rs.OUT_OF_RANGE;case _o.UNIMPLEMENTED:return Rs.UNIMPLEMENTED;case _o.DATA_LOSS:return Rs.DATA_LOSS;default:return Ns()}}(Ao=_o||(_o={}))[Ao.OK=0]="OK",Ao[Ao.CANCELLED=1]="CANCELLED",Ao[Ao.UNKNOWN=2]="UNKNOWN",Ao[Ao.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Ao[Ao.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Ao[Ao.NOT_FOUND=5]="NOT_FOUND",Ao[Ao.ALREADY_EXISTS=6]="ALREADY_EXISTS",Ao[Ao.PERMISSION_DENIED=7]="PERMISSION_DENIED",Ao[Ao.UNAUTHENTICATED=16]="UNAUTHENTICATED",Ao[Ao.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Ao[Ao.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Ao[Ao.ABORTED=10]="ABORTED",Ao[Ao.OUT_OF_RANGE=11]="OUT_OF_RANGE",Ao[Ao.UNIMPLEMENTED=12]="UNIMPLEMENTED",Ao[Ao.INTERNAL=13]="INTERNAL",Ao[Ao.UNAVAILABLE=14]="UNAVAILABLE",Ao[Ao.DATA_LOSS=15]="DATA_LOSS";class No{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,s]of n)if(this.equalsFn(e,t))return s}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),s=this.inner[n];if(void 0===s)return this.inner[n]=[[t,e]],void this.innerSize++;for(let n=0;n<s.length;n++)if(this.equalsFn(s[n][0],t))return void(s[n]=[t,e]);s.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],t))return 1===n.length?delete this.inner[e]:n.splice(s,1),this.innerSize--,!0;return!1}forEach(t){tr(this.inner,((e,n)=>{for(const[e,s]of n)t(e,s)}))}isEmpty(){return er(this.inner)}size(){return this.innerSize}}const Co=new ei(br.comparator);function ko(){return Co}const Mo=new ei(br.comparator);function Ro(...t){let e=Mo;for(const n of t)e=e.insert(n.key,n);return e}function Lo(){return new No((t=>t.toString()),((t,e)=>t.isEqual(e)))}const Vo=new ei(br.comparator),Po=new ri(br.comparator);function Oo(...t){let e=Po;for(const n of t)e=e.add(n);return e}const Fo=new ri(Ws);function qo(){return Fo}class Uo{constructor(t,e,n,s,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=s,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,Bo.createSynthesizedTargetChangeForCurrentChange(t,e)),new Uo(Js.min(),n,qo(),ko(),Oo())}}class Bo{constructor(t,e,n,s,r){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=s,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e){return new Bo(ur.EMPTY_BYTE_STRING,e,Oo(),Oo(),Oo())}}class Ko{constructor(t,e,n,s){this.O=t,this.removedTargetIds=e,this.key=n,this.F=s}}class Go{constructor(t,e){this.targetId=t,this.$=e}}class jo{constructor(t,e,n=ur.EMPTY_BYTE_STRING,s=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=s}}class $o{constructor(){this.B=0,this.L=Wo(),this.U=ur.EMPTY_BYTE_STRING,this.q=!1,this.K=!0}get current(){return this.q}get resumeToken(){return this.U}get G(){return 0!==this.B}get j(){return this.K}W(t){t.approximateByteSize()>0&&(this.K=!0,this.U=t)}H(){let t=Oo(),e=Oo(),n=Oo();return this.L.forEach(((s,r)=>{switch(r){case 0:t=t.add(s);break;case 2:e=e.add(s);break;case 1:n=n.add(s);break;default:Ns()}})),new Bo(this.U,this.q,t,e,n)}J(){this.K=!1,this.L=Wo()}Y(t,e){this.K=!0,this.L=this.L.insert(t,e)}X(t){this.K=!0,this.L=this.L.remove(t)}Z(){this.B+=1}tt(){this.B-=1}et(){this.K=!0,this.q=!0}}class zo{constructor(t){this.nt=t,this.st=new Map,this.it=ko(),this.rt=Qo(),this.ot=new ri(Ws)}ut(t){for(const e of t.O)t.F&&t.F.isFoundDocument()?this.at(e,t.F):this.ct(e,t.key,t.F);for(const e of t.removedTargetIds)this.ct(e,t.key,t.F)}ht(t){this.forEachTarget(t,(e=>{const n=this.lt(e);switch(t.state){case 0:this.ft(e)&&n.W(t.resumeToken);break;case 1:n.tt(),n.G||n.J(),n.W(t.resumeToken);break;case 2:n.tt(),n.G||this.removeTarget(e);break;case 3:this.ft(e)&&(n.et(),n.W(t.resumeToken));break;case 4:this.ft(e)&&(this.dt(e),n.W(t.resumeToken));break;default:Ns()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.st.forEach(((t,n)=>{this.ft(n)&&e(n)}))}_t(t){const e=t.targetId,n=t.$.count,s=this.wt(e);if(s){const t=s.target;if(li(t))if(0===n){const n=new br(t.path);this.ct(e,n,$r.newNoDocument(n,Js.min()))}else Cs(1===n);else this.gt(e)!==n&&(this.dt(e),this.ot=this.ot.add(e))}}yt(t){const e=new Map;this.st.forEach(((n,s)=>{const r=this.wt(s);if(r){if(n.current&&li(r.target)){const e=new br(r.target.path);null!==this.it.get(e)||this.It(s,e)||this.ct(s,e,$r.newNoDocument(e,t))}n.j&&(e.set(s,n.H()),n.J())}}));let n=Oo();this.rt.forEach(((t,e)=>{let s=!0;e.forEachWhile((t=>{const e=this.wt(t);return!e||2===e.purpose||(s=!1,!1)})),s&&(n=n.add(t))})),this.it.forEach(((e,n)=>n.setReadTime(t)));const s=new Uo(t,e,this.ot,this.it,n);return this.it=ko(),this.rt=Qo(),this.ot=new ri(Ws),s}at(t,e){if(!this.ft(t))return;const n=this.It(t,e.key)?2:0;this.lt(t).Y(e.key,n),this.it=this.it.insert(e.key,e),this.rt=this.rt.insert(e.key,this.Tt(e.key).add(t))}ct(t,e,n){if(!this.ft(t))return;const s=this.lt(t);this.It(t,e)?s.Y(e,1):s.X(e),this.rt=this.rt.insert(e,this.Tt(e).delete(t)),n&&(this.it=this.it.insert(e,n))}removeTarget(t){this.st.delete(t)}gt(t){const e=this.lt(t).H();return this.nt.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Z(t){this.lt(t).Z()}lt(t){let e=this.st.get(t);return e||(e=new $o,this.st.set(t,e)),e}Tt(t){let e=this.rt.get(t);return e||(e=new ri(Ws),this.rt=this.rt.insert(t,e)),e}ft(t){const e=null!==this.wt(t);return e||_s("WatchChangeAggregator","Detected inactive target",t),e}wt(t){const e=this.st.get(t);return e&&e.G?null:this.nt.Et(t)}dt(t){this.st.set(t,new $o),this.nt.getRemoteKeysForTarget(t).forEach((e=>{this.ct(t,e,null)}))}It(t,e){return this.nt.getRemoteKeysForTarget(t).has(e)}}function Qo(){return new ei(br.comparator)}function Wo(){return new ei(br.comparator)}const Ho={asc:"ASCENDING",desc:"DESCENDING"},Yo={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class Xo{constructor(t,e){this.databaseId=t,this.N=e}}function Jo(t,e){return t.N?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Zo(t,e){return t.N?e.toBase64():e.toUint8Array()}function ta(t,e){return Jo(t,e.toTimestamp())}function ea(t){return Cs(!!t),Js.fromTimestamp(function(t){const e=hr(t);return new Xs(e.seconds,e.nanos)}(t))}function na(t,e){return function(t){return new sr(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function sa(t){const e=sr.fromString(t);return Cs(_a(e)),e}function ra(t,e){return na(t.databaseId,e.path)}function ia(t,e){const n=sa(e);if(n.get(1)!==t.databaseId.projectId)throw new Ls(Rs.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new Ls(Rs.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new br(ca(n))}function oa(t,e){return na(t.databaseId,e)}function aa(t){const e=sa(t);return 4===e.length?sr.emptyPath():ca(e)}function ua(t){return new sr(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function ca(t){return Cs(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function ha(t,e,n){return{name:ra(t,e),fields:n.value.mapValue.fields}}function la(t,e,n){const s=ia(t,e.name),r=ea(e.updateTime),i=new Gr({mapValue:{fields:e.fields}}),o=$r.newFoundDocument(s,r,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function da(t,e){let n;if(e instanceof yo)n={update:ha(t,e.key,e.value)};else if(e instanceof To)n={delete:ra(t,e.key)};else if(e instanceof wo)n={update:ha(t,e.key,e.data),updateMask:Sa(e.fieldMask)};else{if(!(e instanceof Eo))return Ns();n={verify:ra(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof Ji)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Zi)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof eo)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof so)return{fieldPath:e.field.canonicalString(),increment:n.k};throw Ns()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:ta(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:Ns()}(t,e.precondition)),n}function fa(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?uo.updateTime(ea(t.updateTime)):void 0!==t.exists?uo.exists(t.exists):uo.none()}(e.currentDocument):uo.none(),s=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)Cs("REQUEST_TIME"===e.setToServerValue),n=new Ji;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new Zi(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new eo(t)}else"increment"in e?n=new so(t,e.increment):Ns();const s=ir.fromServerFormat(e.fieldPath);return new oo(s,n)}(t,e))):[];if(e.update){e.update.name;const r=ia(t,e.update.name),i=new Gr({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new or(e.map((t=>ir.fromServerFormat(t))))}(e.updateMask);return new wo(r,i,t,n,s)}return new yo(r,i,n,s)}if(e.delete){const s=ia(t,e.delete);return new To(s,n)}if(e.verify){const s=ia(t,e.verify);return new Eo(s,n)}return Ns()}function ma(t,e){return{documents:[oa(t,e.path)]}}function ga(t,e){const n={structuredQuery:{}},s=e.path;null!==e.collectionGroup?(n.parent=oa(t,s),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=oa(t,s.popLast()),n.structuredQuery.from=[{collectionId:s.lastSegment()}]);const r=function(t){if(0===t.length)return;const e=t.map((t=>function(t){if("=="===t.op){if(Vr(t.value))return{unaryFilter:{field:Ia(t.field),op:"IS_NAN"}};if(Lr(t.value))return{unaryFilter:{field:Ia(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Vr(t.value))return{unaryFilter:{field:Ia(t.field),op:"IS_NOT_NAN"}};if(Lr(t.value))return{unaryFilter:{field:Ia(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Ia(t.field),op:va(t.op),value:t.value}}}(t)));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(e.filters);r&&(n.structuredQuery.where=r);const i=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:Ia(t.field),direction:wa(t.dir)}}(t)))}(e.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(t,e){return t.N||wr(e)?e:{value:e}}(t,e.limit);var a;return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt={before:(a=e.startAt).inclusive,values:a.position}),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),n}function pa(t){let e=aa(t.parent);const n=t.structuredQuery,s=n.from?n.from.length:0;let r=null;if(s>0){Cs(1===s);const t=n.from[0];t.allDescendants?r=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=ya(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((t=>function(t){return new _i(ba(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,wr(e)?null:e}(n.limit));let u=null;n.startAt&&(u=function(t){const e=!!t.before,n=t.values||[];return new Si(n,e)}(n.startAt));let c=null;return n.endAt&&(c=function(t){const e=!t.before,n=t.values||[];return new Si(n,e)}(n.endAt)),Ci(e,r,o,i,a,"F",u,c)}function ya(t){return t?void 0!==t.unaryFilter?[Ea(t)]:void 0!==t.fieldFilter?[Ta(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((t=>ya(t))).reduce(((t,e)=>t.concat(e))):Ns():[]}function wa(t){return Ho[t]}function va(t){return Yo[t]}function Ia(t){return{fieldPath:t.canonicalString()}}function ba(t){return ir.fromServerFormat(t.fieldPath)}function Ta(t){return gi.create(ba(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Ns()}}(t.fieldFilter.op),t.fieldFilter.value)}function Ea(t){switch(t.unaryFilter.op){case"IS_NAN":const e=ba(t.unaryFilter.field);return gi.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=ba(t.unaryFilter.field);return gi.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=ba(t.unaryFilter.field);return gi.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const r=ba(t.unaryFilter.field);return gi.create(r,"!=",{nullValue:"NULL_VALUE"});default:return Ns()}}function Sa(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function _a(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function Aa(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=xa(e)),e=Da(t.get(n),e);return xa(e)}function Da(t,e){let n=e;const s=t.length;for(let e=0;e<s;e++){const s=t.charAt(e);switch(s){case"\0":n+="";break;case"":n+="";break;default:n+=s}}return n}function xa(t){return t+""}function Na(t){const e=t.length;if(Cs(e>=2),2===e)return Cs(""===t.charAt(0)&&""===t.charAt(1)),sr.emptyPath();const n=e-2,s=[];let r="";for(let i=0;i<e;){const e=t.indexOf("",i);switch((e<0||e>n)&&Ns(),t.charAt(e+1)){case"":const n=t.substring(i,e);let o;0===r.length?o=n:(r+=n,o=r,r=""),s.push(o);break;case"":r+=t.substring(i,e),r+="\0";break;case"":r+=t.substring(i,e+1);break;default:Ns()}i=e+2}return new sr(s)}const Ca=["userId","batchId"];function ka(t,e){return[t,Aa(e)]}function Ma(t,e,n){return[t,Aa(e),n]}const Ra={},La=["prefixPath","collectionGroup","readTime","documentId"],Va=["prefixPath","collectionGroup","documentId"],Pa=["collectionGroup","readTime","prefixPath","documentId"],Oa=["canonicalId","targetId"],Fa=["targetId","path"],qa=["path","targetId"],Ua=["collectionId","parent"],Ba=["indexId","uid"],Ka=["uid","sequenceNumber"],Ga=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],ja=["indexId","uid","orderedDocumentKey"],$a=["userId","collectionPath","documentId"],za=["userId","collectionPath","largestBatchId"],Qa=["userId","collectionGroup","largestBatchId"],Wa=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Ha=[...Wa,"documentOverlays"],Ya=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Xa=[...Ya,"indexConfiguration","indexState","indexEntries"],Ja="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Za{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}class tu{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Ns(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new tu(((n,s)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,s)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,s)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof tu?e:tu.resolve(e)}catch(t){return tu.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):tu.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):tu.reject(e)}static resolve(t){return new tu(((e,n)=>{e(t)}))}static reject(t){return new tu(((e,n)=>{n(t)}))}static waitFor(t){return new tu(((e,n)=>{let s=0,r=0,i=!1;t.forEach((t=>{++s,t.next((()=>{++r,i&&r===s&&e()}),(t=>n(t)))})),i=!0,r===s&&e()}))}static or(t){let e=tu.resolve(!1);for(const n of t)e=e.next((t=>t?tu.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,s)=>{n.push(e.call(this,t,s))})),this.waitFor(n)}}class eu{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.At=new Vs,this.transaction.oncomplete=()=>{this.At.resolve()},this.transaction.onabort=()=>{e.error?this.At.reject(new ru(t,e.error)):this.At.resolve()},this.transaction.onerror=e=>{const n=cu(e.target.error);this.At.reject(new ru(t,n))}}static open(t,e,n,s){try{return new eu(e,t.transaction(s,n))}catch(t){throw new ru(e,t)}}get Rt(){return this.At.promise}abort(t){t&&this.At.reject(t),this.aborted||(_s("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}bt(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new ou(e)}}class nu{constructor(t,e,n){this.name=t,this.version=e,this.Pt=n,12.2===nu.Vt((0,a.z$)())&&As("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return _s("SimpleDb","Removing database:",t),au(window.indexedDB.deleteDatabase(t)).toPromise()}static vt(){if(!(0,a.hl)())return!1;if(nu.St())return!0;const t=(0,a.z$)(),e=nu.Vt(t),n=0<e&&e<10,s=nu.Dt(t),r=0<s&&s<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||r)}static St(){var t;return void 0!==ws&&"YES"===(null===(t=ws.env)||void 0===t?void 0:t.Ct)}static xt(t,e){return t.store(e)}static Vt(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static Dt(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async Nt(t){return this.db||(_s("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=t=>{const n=t.target.result;e(n)},s.onblocked=()=>{n(new ru(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{const s=e.target.error;"VersionError"===s.name?n(new Ls(Rs.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===s.name?n(new Ls(Rs.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+s)):n(new ru(t,s))},s.onupgradeneeded=t=>{_s("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.Pt.kt(e,s.transaction,t.oldVersion,this.version).next((()=>{_s("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.Mt&&(this.db.onversionchange=t=>this.Mt(t)),this.db}Ot(t){this.Mt=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,s){const r="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.Nt(t);const e=eu.open(this.db,t,r?"readonly":"readwrite",n),i=s(e).next((t=>(e.bt(),t))).catch((t=>(e.abort(t),tu.reject(t)))).toPromise();return i.catch((()=>{})),await e.Rt,i}catch(t){const e="FirebaseError"!==t.name&&i<3;if(_s("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class su{constructor(t){this.Ft=t,this.$t=!1,this.Bt=null}get isDone(){return this.$t}get Lt(){return this.Bt}set cursor(t){this.Ft=t}done(){this.$t=!0}Ut(t){this.Bt=t}delete(){return au(this.Ft.delete())}}class ru extends Ls{constructor(t,e){super(Rs.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function iu(t){return"IndexedDbTransactionError"===t.name}class ou{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(_s("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(_s("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),au(n)}add(t){return _s("SimpleDb","ADD",this.store.name,t,t),au(this.store.add(t))}get(t){return au(this.store.get(t)).next((e=>(void 0===e&&(e=null),_s("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return _s("SimpleDb","DELETE",this.store.name,t),au(this.store.delete(t))}count(){return _s("SimpleDb","COUNT",this.store.name),au(this.store.count())}qt(t,e){const n=this.options(t,e);if(n.index||"function"!=typeof this.store.getAll){const t=this.cursor(n),e=[];return this.Kt(t,((t,n)=>{e.push(n)})).next((()=>e))}{const t=this.store.getAll(n.range);return new tu(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}}Gt(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new tu(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}Qt(t,e){_s("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.jt=!1;const s=this.cursor(n);return this.Kt(s,((t,e,n)=>n.delete()))}Wt(t,e){let n;e?n=t:(n={},e=t);const s=this.cursor(n);return this.Kt(s,e)}zt(t){const e=this.cursor({});return new tu(((n,s)=>{e.onerror=t=>{const e=cu(t.target.error);s(e)},e.onsuccess=e=>{const s=e.target.result;s?t(s.primaryKey,s.value).next((t=>{t?s.continue():n()})):n()}}))}Kt(t,e){const n=[];return new tu(((s,r)=>{t.onerror=t=>{r(t.target.error)},t.onsuccess=t=>{const r=t.target.result;if(!r)return void s();const i=new su(r),o=e(r.primaryKey,r.value,i);if(o instanceof tu){const t=o.catch((t=>(i.done(),tu.reject(t))));n.push(t)}i.isDone?s():null===i.Lt?r.continue():r.continue(i.Lt)}})).next((()=>tu.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.jt?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function au(t){return new tu(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=cu(t.target.error);n(e)}}))}let uu=!1;function cu(t){const e=nu.Vt((0,a.z$)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new Ls("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return uu||(uu=!0,setTimeout((()=>{throw t}),0)),t}}return t}class hu extends Za{constructor(t,e){super(),this.Ht=t,this.currentSequenceNumber=e}}function lu(t,e){const n=Ms(t);return nu.xt(n.Ht,e)}class du{constructor(t,e,n,s){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const s=this.mutations[e];s.key.isEqual(t.key)&&lo(s,t,n[e])}}applyToLocalView(t){for(const e of this.baseMutations)e.key.isEqual(t.key)&&fo(e,t,this.localWriteTime);for(const e of this.mutations)e.key.isEqual(t.key)&&fo(e,t,this.localWriteTime)}applyToLocalDocumentSet(t){this.mutations.forEach((e=>{const n=t.get(e.key),s=n;this.applyToLocalView(s),n.isValidDocument()||s.convertToNoDocument(Js.min())}))}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),Oo())}isEqual(t){return this.batchId===t.batchId&&Hs(this.mutations,t.mutations,((t,e)=>go(t,e)))&&Hs(this.baseMutations,t.baseMutations,((t,e)=>go(t,e)))}}class fu{constructor(t,e,n,s){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=s}static from(t,e,n){Cs(t.mutations.length===n.length);let s=Vo;const r=t.mutations;for(let t=0;t<r.length;t++)s=s.insert(r[t].key,n[t].version);return new fu(t,e,n,s)}}class mu{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class gu{constructor(t,e,n,s,r=Js.min(),i=Js.min(),o=ur.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=s,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new gu(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new gu(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new gu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class pu{constructor(t){this.Jt=t}}function yu(t,e){const n=e.key,s={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:wu(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())s.document=function(t,e){return{name:ra(t,e.key),fields:e.data.value.mapValue.fields,updateTime:Jo(t,e.version.toTimestamp())}}(t.Jt,e);else if(e.isNoDocument())s.noDocument={path:n.path.toArray(),readTime:vu(e.version)};else{if(!e.isUnknownDocument())return Ns();s.unknownDocument={path:n.path.toArray(),version:vu(e.version)}}return s}function wu(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function vu(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function Iu(t){const e=new Xs(t.seconds,t.nanoseconds);return Js.fromTimestamp(e)}function bu(t,e){const n=(e.baseMutations||[]).map((e=>fa(t.Jt,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const s=e.mutations[t+1];n.updateTransforms=s.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const s=e.mutations.map((e=>fa(t.Jt,e))),r=Xs.fromMillis(e.localWriteTimeMs);return new du(e.batchId,r,n,s)}function Tu(t){const e=Iu(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?Iu(t.lastLimboFreeSnapshotVersion):Js.min();let s;var r;return void 0!==t.query.documents?(Cs(1===(r=t.query).documents.length),s=Pi(ki(aa(r.documents[0])))):s=function(t){return Pi(pa(t))}(t.query),new gu(s,t.targetId,0,t.lastListenSequenceNumber,e,n,ur.fromBase64String(t.resumeToken))}function Eu(t,e){const n=vu(e.snapshotVersion),s=vu(e.lastLimboFreeSnapshotVersion);let r;r=li(e.target)?ma(t.Jt,e.target):ga(t.Jt,e.target);const i=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:ci(e.target),readTime:n,resumeToken:i,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:s,query:r}}function Su(t){const e=pa({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Oi(e,e.limit,"L"):e}function _u(t,e){return new mu(e.largestBatchId,fa(t.Jt,e.overlayMutation))}function Au(t,e){const n=e.path.lastSegment();return[t,Aa(e.path.popLast()),n]}class Du{getBundleMetadata(t,e){return xu(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:Iu(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return xu(t).put({bundleId:(n=e).id,createTime:vu(ea(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return Nu(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:Su(e.bundledQuery),readTime:Iu(e.readTime)};var e}))}saveNamedQuery(t,e){return Nu(t).put(function(t){return{name:t.name,readTime:vu(ea(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function xu(t){return lu(t,"bundles")}function Nu(t){return lu(t,"namedQueries")}class Cu{constructor(t,e){this.M=t,this.userId=e}static Yt(t,e){const n=e.uid||"";return new Cu(t,n)}getOverlay(t,e){return ku(t).get(Au(this.userId,e)).next((t=>t?_u(this.M,t):null))}saveOverlays(t,e,n){const s=[];return n.forEach(((n,r)=>{const i=new mu(e,r);s.push(this.Xt(t,i))})),tu.waitFor(s)}removeOverlaysForBatchId(t,e,n){const s=new Set;e.forEach((t=>s.add(Aa(t.getCollectionPath()))));const r=[];return s.forEach((e=>{const s=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);r.push(ku(t).Qt("collectionPathOverlayIndex",s))})),tu.waitFor(r)}getOverlaysForCollection(t,e,n){const s=Lo(),r=Aa(e),i=IDBKeyRange.bound([this.userId,r,n],[this.userId,r,Number.POSITIVE_INFINITY],!0);return ku(t).qt("collectionPathOverlayIndex",i).next((t=>{for(const e of t){const t=_u(this.M,e);s.set(t.getKey(),t)}return s}))}getOverlaysForCollectionGroup(t,e,n,s){const r=Lo();let i;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return ku(t).Wt({index:"collectionGroupOverlayIndex",range:o},((t,e,n)=>{const o=_u(this.M,e);r.size()<s||o.largestBatchId===i?(r.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>r))}Xt(t,e){return ku(t).put(function(t,e,n){const[s,r,i]=Au(e,n.mutation.key);return{userId:e,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:da(t.Jt,n.mutation)}}(this.M,this.userId,e))}}function ku(t){return lu(t,"documentOverlays")}class Mu{constructor(){}Zt(t,e){this.te(t,e),e.ee()}te(t,e){if("nullValue"in t)this.ne(e,5);else if("booleanValue"in t)this.ne(e,10),e.se(t.booleanValue?1:0);else if("integerValue"in t)this.ne(e,15),e.se(lr(t.integerValue));else if("doubleValue"in t){const n=lr(t.doubleValue);isNaN(n)?this.ne(e,13):(this.ne(e,15),vr(n)?e.se(0):e.se(n))}else if("timestampValue"in t){const n=t.timestampValue;this.ne(e,20),"string"==typeof n?e.ie(n):(e.ie(`${n.seconds||""}`),e.se(n.nanos||0))}else if("stringValue"in t)this.re(t.stringValue,e),this.oe(e);else if("bytesValue"in t)this.ne(e,30),e.ue(dr(t.bytesValue)),this.oe(e);else if("referenceValue"in t)this.ae(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.ne(e,45),e.se(n.latitude||0),e.se(n.longitude||0)}else"mapValue"in t?Fr(t)?this.ne(e,Number.MAX_SAFE_INTEGER):(this.ce(t.mapValue,e),this.oe(e)):"arrayValue"in t?(this.he(t.arrayValue,e),this.oe(e)):Ns()}re(t,e){this.ne(e,25),this.le(t,e)}le(t,e){e.ie(t)}ce(t,e){const n=t.fields||{};this.ne(e,55);for(const t of Object.keys(n))this.re(t,e),this.te(n[t],e)}he(t,e){const n=t.values||[];this.ne(e,50);for(const t of n)this.te(t,e)}ae(t,e){this.ne(e,37),br.fromName(t).path.forEach((t=>{this.ne(e,60),this.le(t,e)}))}ne(t,e){t.se(e)}oe(t){t.se(2)}}function Ru(t){if(0===t)return 8;let e=0;return t>>4==0&&(e+=4,t<<=4),t>>6==0&&(e+=2,t<<=2),t>>7==0&&(e+=1),e}function Lu(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const s=Ru(255&t[n]);if(e+=s,8!==s)break}return e}(t);return Math.ceil(e/8)}Mu.fe=new Mu;class Vu{constructor(){this.buffer=new Uint8Array(1024),this.position=0}de(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this._e(n.value),n=e.next();this.we()}me(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.ge(n.value),n=e.next();this.ye()}pe(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this._e(t);else if(t<2048)this._e(960|t>>>6),this._e(128|63&t);else if(e<"\ud800"||"\udbff"<e)this._e(480|t>>>12),this._e(128|63&t>>>6),this._e(128|63&t);else{const t=e.codePointAt(0);this._e(240|t>>>18),this._e(128|63&t>>>12),this._e(128|63&t>>>6),this._e(128|63&t)}}this.we()}Ie(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.ge(t);else if(t<2048)this.ge(960|t>>>6),this.ge(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.ge(480|t>>>12),this.ge(128|63&t>>>6),this.ge(128|63&t);else{const t=e.codePointAt(0);this.ge(240|t>>>18),this.ge(128|63&t>>>12),this.ge(128|63&t>>>6),this.ge(128|63&t)}}this.ye()}Te(t){const e=this.Ee(t),n=Lu(e);this.Ae(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}Re(t){const e=this.Ee(t),n=Lu(e);this.Ae(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}be(){this.Pe(255),this.Pe(255)}Ve(){this.ve(255),this.ve(255)}reset(){this.position=0}seed(t){this.Ae(t.length),this.buffer.set(t,this.position),this.position+=t.length}Se(){return this.buffer.slice(0,this.position)}Ee(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=0!=(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}_e(t){const e=255&t;0===e?(this.Pe(0),this.Pe(255)):255===e?(this.Pe(255),this.Pe(0)):this.Pe(e)}ge(t){const e=255&t;0===e?(this.ve(0),this.ve(255)):255===e?(this.ve(255),this.ve(0)):this.ve(t)}we(){this.Pe(0),this.Pe(1)}ye(){this.ve(0),this.ve(1)}Pe(t){this.Ae(1),this.buffer[this.position++]=t}ve(t){this.Ae(1),this.buffer[this.position++]=~t}Ae(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const s=new Uint8Array(n);s.set(this.buffer),this.buffer=s}}class Pu{constructor(t){this.De=t}ue(t){this.De.de(t)}ie(t){this.De.pe(t)}se(t){this.De.Te(t)}ee(){this.De.be()}}class Ou{constructor(t){this.De=t}ue(t){this.De.me(t)}ie(t){this.De.Ie(t)}se(t){this.De.Re(t)}ee(){this.De.Ve()}}class Fu{constructor(){this.De=new Vu,this.Ce=new Pu(this.De),this.xe=new Ou(this.De)}seed(t){this.De.seed(t)}Ne(t){return 0===t?this.Ce:this.xe}Se(){return this.De.Se()}reset(){this.De.reset()}}class qu{constructor(t,e,n,s){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=s}ke(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new qu(this.indexId,this.documentKey,this.arrayValue,n)}}function Uu(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=Bu(t.arrayValue,e.arrayValue),0!==n?n:(n=Bu(t.directionalValue,e.directionalValue),0!==n?n:br.comparator(t.documentKey,e.documentKey)))}function Bu(t,e){for(let n=0;n<t.length&&n<e.length;++n){const s=t[n]-e[n];if(0!==s)return s}return t.length-e.length}class Ku{constructor(t){this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Me=t.orderBy,this.Oe=[];for(const e of t.filters){const t=e;t.S()?this.Fe=t:this.Oe.push(t)}}$e(t){const e=Qr(t);if(void 0!==e&&!this.Be(e))return!1;const n=Wr(t);let s=0,r=0;for(;s<n.length&&this.Be(n[s]);++s);if(s===n.length)return!0;if(void 0!==this.Fe){const t=n[s];if(!this.Le(this.Fe,t)||!this.Ue(this.Me[r++],t))return!1;++s}for(;s<n.length;++s){const t=n[s];if(r>=this.Me.length||!this.Ue(this.Me[r++],t))return!1}return!0}Be(t){for(const e of this.Oe)if(this.Le(e,t))return!0;return!1}Le(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}Ue(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}class Gu{constructor(){this.qe=new ju}addToCollectionParentIndex(t,e){return this.qe.add(e),tu.resolve()}getCollectionParents(t,e){return tu.resolve(this.qe.getEntries(e))}addFieldIndex(t,e){return tu.resolve()}deleteFieldIndex(t,e){return tu.resolve()}getDocumentsMatchingTarget(t,e){return tu.resolve(null)}getIndexType(t,e){return tu.resolve(0)}getFieldIndexes(t,e){return tu.resolve([])}getNextCollectionGroupToUpdate(t){return tu.resolve(null)}getMinOffset(t,e){return tu.resolve(Zr.min())}updateCollectionGroup(t,e,n){return tu.resolve()}updateIndexEntries(t,e){return tu.resolve()}}class ju{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e]||new ri(sr.comparator),r=!s.has(n);return this.index[e]=s.add(n),r}has(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e];return s&&s.has(n)}getEntries(t){return(this.index[t]||new ri(sr.comparator)).toArray()}}const $u=new Uint8Array(0);class zu{constructor(t,e){this.user=t,this.databaseId=e,this.Ke=new ju,this.Ge=new No((t=>ci(t)),((t,e)=>hi(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.Ke.has(e)){const n=e.lastSegment(),s=e.popLast();t.addOnCommittedListener((()=>{this.Ke.add(e)}));const r={collectionId:n,parent:Aa(s)};return Qu(t).put(r)}return tu.resolve()}getCollectionParents(t,e){const n=[],s=IDBKeyRange.bound([e,""],[Ys(e),""],!1,!0);return Qu(t).qt(s).next((t=>{for(const s of t){if(s.collectionId!==e)break;n.push(Na(s.parent))}return n}))}addFieldIndex(t,e){const n=Hu(t),s=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);return delete s.indexId,n.add(s).next()}deleteFieldIndex(t,e){const n=Hu(t),s=Yu(t),r=Wu(t);return n.delete(e.indexId).next((()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}getDocumentsMatchingTarget(t,e){const n=Wu(t);let s=!0;const r=new Map;return tu.forEach(this.Qe(e),(e=>this.je(t,e).next((t=>{s&&(s=!!t),r.set(e,t)})))).next((()=>{if(s){let t=Oo();const s=[];return tu.forEach(r,((r,i)=>{var o;_s("IndexedDbIndexManager",`Using index ${o=r,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`} to execute ${ci(e)}`);const a=function(t,e){const n=Qr(e);if(void 0===n)return null;for(const e of di(t,n.fieldPath))switch(e.op){case"array-contains-any":return e.value.arrayValue.values||[];case"array-contains":return[e.value]}return null}(i,r),u=function(t,e){const n=new Map;for(const s of Wr(e))for(const e of di(t,s.fieldPath))switch(e.op){case"==":case"in":n.set(s.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(s.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(i,r),c=function(t,e){const n=[];let s=!0;for(const r of Wr(e)){const e=0===r.kind?fi(t,r.fieldPath,t.startAt):mi(t,r.fieldPath,t.startAt);n.push(e.value),s&&(s=e.inclusive)}return new Si(n,s)}(i,r),h=function(t,e){const n=[];let s=!0;for(const r of Wr(e)){const e=0===r.kind?mi(t,r.fieldPath,t.endAt):fi(t,r.fieldPath,t.endAt);n.push(e.value),s&&(s=e.inclusive)}return new Si(n,s)}(i,r),l=this.We(r,i,c),d=this.We(r,i,h),f=this.ze(r,i,u),m=this.He(r.indexId,a,l,c.inclusive,d,h.inclusive,f);return tu.forEach(m,(r=>n.Gt(r,e.limit).next((e=>{e.forEach((e=>{const n=br.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),s.push(n))}))}))))})).next((()=>s))}return tu.resolve(null)}))}Qe(t){let e=this.Ge.get(t);return e||(e=[t],this.Ge.set(t,e),e)}He(t,e,n,s,r,i,o){const a=(null!=e?e.length:1)*Math.max(n.length,r.length),u=a/(null!=e?e.length:1),c=[];for(let h=0;h<a;++h){const a=e?this.Je(e[h/u]):$u,l=this.Ye(t,a,n[h%u],s),d=this.Xe(t,a,r[h%u],i),f=o.map((e=>this.Ye(t,a,e,!0)));c.push(...this.createRange(l,d,f))}return c}Ye(t,e,n,s){const r=new qu(t,br.empty(),e,n);return s?r:r.ke()}Xe(t,e,n,s){const r=new qu(t,br.empty(),e,n);return s?r.ke():r}je(t,e){const n=new Ku(e),s=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,s).next((t=>{let e=null;for(const s of t)n.$e(s)&&(!e||s.fields.length>e.fields.length)&&(e=s);return e}))}getIndexType(t,e){let n=2;return tu.forEach(this.Qe(e),(e=>this.je(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new ri(ir.comparator),n=!1;for(const s of t.filters){const t=s;t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field))}for(const n of t.orderBy)n.field.isKeyField()||(e=e.add(n.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>n))}Ze(t,e){const n=new Fu;for(const s of Wr(t)){const t=e.data.field(s.fieldPath);if(null==t)return null;const r=n.Ne(s.kind);Mu.fe.Zt(t,r)}return n.Se()}Je(t){const e=new Fu;return Mu.fe.Zt(t,e.Ne(0)),e.Se()}tn(t,e){const n=new Fu;return Mu.fe.Zt(kr(this.databaseId,e),n.Ne(function(t){const e=Wr(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.Se()}ze(t,e,n){if(null===n)return[];let s=[];s.push(new Fu);let r=0;for(const i of Wr(t)){const t=n[r++];for(const n of s)if(this.en(e,i.fieldPath)&&Rr(t))s=this.nn(s,i,t);else{const e=n.Ne(i.kind);Mu.fe.Zt(t,e)}}return this.sn(s)}We(t,e,n){return this.ze(t,e,n.position)}sn(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].Se();return e}nn(t,e,n){const s=[...t],r=[];for(const t of n.arrayValue.values||[])for(const n of s){const s=new Fu;s.seed(n.Se()),Mu.fe.Zt(t,s.Ne(e.kind)),r.push(s)}return r}en(t,e){return!!t.filters.find((t=>t instanceof gi&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=Hu(t),s=Yu(t);return(e?n.qt("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.qt()).next((t=>{const e=[];return tu.forEach(t,(t=>s.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new Yr(e.sequenceNumber,new Zr(Iu(e.readTime),new br(Na(e.documentKey)),e.largestBatchId)):Yr.empty(),s=t.fields.map((([t,e])=>new Hr(ir.fromServerFormat(t),e)));return new zr(t.indexId,t.collectionGroup,s,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:Ws(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const s=Hu(t),r=Yu(t);return this.rn(t).next((t=>s.qt("collectionGroupIndex",IDBKeyRange.bound(e,e)).next((e=>tu.forEach(e,(e=>r.put(function(t,e,n,s){return{indexId:t,uid:e.uid||"",sequenceNumber:n,readTime:vu(s.readTime),documentKey:Aa(s.documentKey.path),largestBatchId:s.largestBatchId}}(e.indexId,this.user,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return tu.forEach(e,((e,s)=>{const r=n.get(e.collectionGroup);return(r?tu.resolve(r):this.getFieldIndexes(t,e.collectionGroup)).next((r=>(n.set(e.collectionGroup,r),tu.forEach(r,(n=>this.on(t,e,n).next((e=>{const r=this.un(s,n);return e.isEqual(r)?tu.resolve():this.an(t,s,n,e,r)})))))))}))}cn(t,e,n,s){return Wu(t).put({indexId:s.indexId,uid:this.uid,arrayValue:s.arrayValue,directionalValue:s.directionalValue,orderedDocumentKey:this.tn(n,e.key),documentKey:e.key.path.toArray()})}hn(t,e,n,s){return Wu(t).delete([s.indexId,this.uid,s.arrayValue,s.directionalValue,this.tn(n,e.key),e.key.path.toArray()])}on(t,e,n){const s=Wu(t);let r=new ri(Uu);return s.Wt({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.tn(n,e)])},((t,s)=>{r=r.add(new qu(n.indexId,e,s.arrayValue,s.directionalValue))})).next((()=>r))}un(t,e){let n=new ri(Uu);const s=this.Ze(e,t);if(null==s)return n;const r=Qr(e);if(null!=r){const i=t.data.field(r.fieldPath);if(Rr(i))for(const r of i.arrayValue.values||[])n=n.add(new qu(e.indexId,t.key,this.Je(r),s))}else n=n.add(new qu(e.indexId,t.key,$u,s));return n}an(t,e,n,s,r){_s("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const i=[];return function(t,e,n,s,r){const i=t.getIterator(),o=e.getIterator();let a=oi(i),u=oi(o);for(;a||u;){let t=!1,e=!1;if(a&&u){const s=n(a,u);s<0?e=!0:s>0&&(t=!0)}else null!=a?e=!0:t=!0;t?(s(u),u=oi(o)):e?(r(a),a=oi(i)):(a=oi(i),u=oi(o))}}(s,r,Uu,(s=>{i.push(this.cn(t,e,n,s))}),(s=>{i.push(this.hn(t,e,n,s))})),tu.waitFor(i)}rn(t){let e=1;return Yu(t).Wt({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,s)=>{s.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>Uu(t,e))).filter(((t,e,n)=>!e||0!==Uu(t,n[e-1])));const s=[];s.push(t);for(const r of n){const n=Uu(r,t),i=Uu(r,e);if(0===n)s[0]=t.ke();else if(n>0&&i<0)s.push(r),s.push(r.ke());else if(i>0)break}s.push(e);const r=[];for(let t=0;t<s.length;t+=2)r.push(IDBKeyRange.bound([s[t].indexId,this.uid,s[t].arrayValue,s[t].directionalValue,$u,[]],[s[t+1].indexId,this.uid,s[t+1].arrayValue,s[t+1].directionalValue,$u,[]]));return r}getMinOffset(t,e){let n;return tu.forEach(this.Qe(e),(e=>this.je(t,e).next((t=>{t?(!n||ti(t.indexState.offset,n)<0)&&(n=t.indexState.offset):n=Zr.min()})))).next((()=>n))}}function Qu(t){return lu(t,"collectionParents")}function Wu(t){return lu(t,"indexEntries")}function Hu(t){return lu(t,"indexConfiguration")}function Yu(t){return lu(t,"indexState")}const Xu={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Ju{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new Ju(t,Ju.DEFAULT_COLLECTION_PERCENTILE,Ju.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Zu(t,e,n){const s=t.store("mutations"),r=t.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=s.Wt({range:o},((t,e,n)=>(a++,n.delete())));i.push(u.next((()=>{Cs(1===a)})));const c=[];for(const t of n.mutations){const s=Ma(e,t.key.path,n.batchId);i.push(r.delete(s)),c.push(t.key)}return tu.waitFor(i).next((()=>c))}function tc(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Ns();e=t.noDocument}return JSON.stringify(e).length}Ju.DEFAULT_COLLECTION_PERCENTILE=10,Ju.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Ju.DEFAULT=new Ju(41943040,Ju.DEFAULT_COLLECTION_PERCENTILE,Ju.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Ju.DISABLED=new Ju(-1,0,0);class ec{constructor(t,e,n,s){this.userId=t,this.M=e,this.indexManager=n,this.referenceDelegate=s,this.ln={}}static Yt(t,e,n,s){Cs(""!==t.uid);const r=t.isAuthenticated()?t.uid:"";return new ec(r,e,n,s)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return sc(t).Wt({index:"userMutationsIndex",range:n},((t,n,s)=>{e=!1,s.done()})).next((()=>e))}addMutationBatch(t,e,n,s){const r=rc(t),i=sc(t);return i.add({}).next((o=>{Cs("number"==typeof o);const a=new du(o,e,n,s),u=function(t,e,n){const s=n.baseMutations.map((e=>da(t.Jt,e))),r=n.mutations.map((e=>da(t.Jt,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:s,mutations:r}}(this.M,this.userId,a),c=[];let h=new ri(((t,e)=>Ws(t.canonicalString(),e.canonicalString())));for(const t of s){const e=Ma(this.userId,t.key.path,o);h=h.add(t.key.path.popLast()),c.push(i.put(u)),c.push(r.put(e,Ra))}return h.forEach((e=>{c.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.ln[o]=a.keys()})),tu.waitFor(c).next((()=>a))}))}lookupMutationBatch(t,e){return sc(t).get(e).next((t=>t?(Cs(t.userId===this.userId),bu(this.M,t)):null))}fn(t,e){return this.ln[e]?tu.resolve(this.ln[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.ln[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=IDBKeyRange.lowerBound([this.userId,n]);let r=null;return sc(t).Wt({index:"userMutationsIndex",range:s},((t,e,s)=>{e.userId===this.userId&&(Cs(e.batchId>=n),r=bu(this.M,e)),s.done()})).next((()=>r))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return sc(t).Wt({index:"userMutationsIndex",range:e,reverse:!0},((t,e,s)=>{n=e.batchId,s.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return sc(t).qt("userMutationsIndex",e).next((t=>t.map((t=>bu(this.M,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=ka(this.userId,e.path),s=IDBKeyRange.lowerBound(n),r=[];return rc(t).Wt({range:s},((n,s,i)=>{const[o,a,u]=n,c=Na(a);if(o===this.userId&&e.path.isEqual(c))return sc(t).get(u).next((t=>{if(!t)throw Ns();Cs(t.userId===this.userId),r.push(bu(this.M,t))}));i.done()})).next((()=>r))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new ri(Ws);const s=[];return e.forEach((e=>{const r=ka(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=rc(t).Wt({range:i},((t,s,r)=>{const[i,o,a]=t,u=Na(o);i===this.userId&&e.path.isEqual(u)?n=n.add(a):r.done()}));s.push(o)})),tu.waitFor(s).next((()=>this.dn(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1,r=ka(this.userId,n),i=IDBKeyRange.lowerBound(r);let o=new ri(Ws);return rc(t).Wt({range:i},((t,e,r)=>{const[i,a,u]=t,c=Na(a);i===this.userId&&n.isPrefixOf(c)?c.length===s&&(o=o.add(u)):r.done()})).next((()=>this.dn(t,o)))}dn(t,e){const n=[],s=[];return e.forEach((e=>{s.push(sc(t).get(e).next((t=>{if(null===t)throw Ns();Cs(t.userId===this.userId),n.push(bu(this.M,t))})))})),tu.waitFor(s).next((()=>n))}removeMutationBatch(t,e){return Zu(t.Ht,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this._n(e.batchId)})),tu.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}_n(t){delete this.ln[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return tu.resolve();const n=IDBKeyRange.lowerBound([this.userId]),s=[];return rc(t).Wt({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=Na(t[1]);s.push(e)}else n.done()})).next((()=>{Cs(0===s.length)}))}))}containsKey(t,e){return nc(t,this.userId,e)}wn(t){return ic(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function nc(t,e,n){const s=ka(e,n.path),r=s[1],i=IDBKeyRange.lowerBound(s);let o=!1;return rc(t).Wt({range:i,jt:!0},((t,n,s)=>{const[i,a,u]=t;i===e&&a===r&&(o=!0),s.done()})).next((()=>o))}function sc(t){return lu(t,"mutations")}function rc(t){return lu(t,"documentMutations")}function ic(t){return lu(t,"mutationQueues")}class oc{constructor(t){this.mn=t}next(){return this.mn+=2,this.mn}static gn(){return new oc(0)}static yn(){return new oc(-1)}}class ac{constructor(t,e){this.referenceDelegate=t,this.M=e}allocateTargetId(t){return this.pn(t).next((e=>{const n=new oc(e.highestTargetId);return e.highestTargetId=n.next(),this.In(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.pn(t).next((t=>Js.fromTimestamp(new Xs(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.pn(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.pn(t).next((s=>(s.highestListenSequenceNumber=e,n&&(s.lastRemoteSnapshotVersion=n.toTimestamp()),e>s.highestListenSequenceNumber&&(s.highestListenSequenceNumber=e),this.In(t,s))))}addTargetData(t,e){return this.Tn(t,e).next((()=>this.pn(t).next((n=>(n.targetCount+=1,this.En(e,n),this.In(t,n))))))}updateTargetData(t,e){return this.Tn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>uc(t).delete(e.targetId))).next((()=>this.pn(t))).next((e=>(Cs(e.targetCount>0),e.targetCount-=1,this.In(t,e))))}removeTargets(t,e,n){let s=0;const r=[];return uc(t).Wt(((i,o)=>{const a=Tu(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(s++,r.push(this.removeTargetData(t,a)))})).next((()=>tu.waitFor(r))).next((()=>s))}forEachTarget(t,e){return uc(t).Wt(((t,n)=>{const s=Tu(n);e(s)}))}pn(t){return cc(t).get("targetGlobalKey").next((t=>(Cs(null!==t),t)))}In(t,e){return cc(t).put("targetGlobalKey",e)}Tn(t,e){return uc(t).put(Eu(this.M,e))}En(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.pn(t).next((t=>t.targetCount))}getTargetData(t,e){const n=ci(e),s=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return uc(t).Wt({range:s,index:"queryTargetsIndex"},((t,n,s)=>{const i=Tu(n);hi(e,i.target)&&(r=i,s.done())})).next((()=>r))}addMatchingKeys(t,e,n){const s=[],r=hc(t);return e.forEach((e=>{const i=Aa(e.path);s.push(r.put({targetId:n,path:i})),s.push(this.referenceDelegate.addReference(t,n,e))})),tu.waitFor(s)}removeMatchingKeys(t,e,n){const s=hc(t);return tu.forEach(e,(e=>{const r=Aa(e.path);return tu.waitFor([s.delete([n,r]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=hc(t),s=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(s)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),s=hc(t);let r=Oo();return s.Wt({range:n,jt:!0},((t,e,n)=>{const s=Na(t[1]),i=new br(s);r=r.add(i)})).next((()=>r))}containsKey(t,e){const n=Aa(e.path),s=IDBKeyRange.bound([n],[Ys(n)],!1,!0);let r=0;return hc(t).Wt({index:"documentTargetsIndex",jt:!0,range:s},(([t,e],n,s)=>{0!==t&&(r++,s.done())})).next((()=>r>0))}Et(t,e){return uc(t).get(e).next((t=>t?Tu(t):null))}}function uc(t){return lu(t,"targets")}function cc(t){return lu(t,"targetGlobal")}function hc(t){return lu(t,"targetDocuments")}async function lc(t){if(t.code!==Rs.FAILED_PRECONDITION||t.message!==Ja)throw t;_s("LocalStore","Unexpectedly lost primary lease")}function dc([t,e],[n,s]){const r=Ws(t,n);return 0===r?Ws(e,s):r}class fc{constructor(t){this.An=t,this.buffer=new ri(dc),this.Rn=0}bn(){return++this.Rn}Pn(t){const e=[t,this.bn()];if(this.buffer.size<this.An)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();dc(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class mc{constructor(t,e){this.garbageCollector=t,this.asyncQueue=e,this.Vn=!1,this.vn=null}start(t){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Sn(t)}stop(){this.vn&&(this.vn.cancel(),this.vn=null)}get started(){return null!==this.vn}Sn(t){const e=this.Vn?3e5:6e4;_s("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.vn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.vn=null,this.Vn=!0;try{await t.collectGarbage(this.garbageCollector)}catch(t){iu(t)?_s("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await lc(t)}await this.Sn(t)}))}}class gc{constructor(t,e){this.Dn=t,this.params=e}calculateTargetCount(t,e){return this.Dn.Cn(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return tu.resolve($s.A);const n=new fc(e);return this.Dn.forEachTarget(t,(t=>n.Pn(t.sequenceNumber))).next((()=>this.Dn.xn(t,(t=>n.Pn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.Dn.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.Dn.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(_s("LruGarbageCollector","Garbage collection skipped; disabled"),tu.resolve(Xu)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(_s("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Xu):this.Nn(t,e)))}getCacheSize(t){return this.Dn.getCacheSize(t)}Nn(t,e){let n,s,r,i,a,u,c;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(_s("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),s=this.params.maximumSequenceNumbersToCollect):s=e,i=Date.now(),this.nthSequenceNumber(t,s)))).next((s=>(n=s,a=Date.now(),this.removeTargets(t,n,e)))).next((e=>(r=e,u=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(c=Date.now(),Es()<=o.in.DEBUG&&_s("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-h}ms\n\tDetermined least recently used ${s} in `+(a-i)+"ms\n"+`\tRemoved ${r} targets in `+(u-a)+"ms\n"+`\tRemoved ${t} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),tu.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:r,documentsRemoved:t}))))}}class pc{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new gc(t,e)}(this,e)}Cn(t){const e=this.kn(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}kn(t){let e=0;return this.xn(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}xn(t,e){return this.Mn(t,((t,n)=>e(n)))}addReference(t,e,n){return yc(t,n)}removeReference(t,e,n){return yc(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return yc(t,e)}On(t,e){return function(t,e){let n=!1;return ic(t).zt((s=>nc(t,s,e).next((t=>(t&&(n=!0),tu.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let r=0;return this.Mn(t,((i,o)=>{if(o<=e){const e=this.On(t,i).next((e=>{if(!e)return r++,n.getEntry(t,i).next((()=>(n.removeEntry(i,Js.min()),hc(t).delete([0,Aa(i.path)]))))}));s.push(e)}})).next((()=>tu.waitFor(s))).next((()=>n.apply(t))).next((()=>r))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return yc(t,e)}Mn(t,e){const n=hc(t);let s,r=$s.A;return n.Wt({index:"documentTargetsIndex"},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(r!==$s.A&&e(new br(Na(s)),r),r=o,s=i):r=$s.A})).next((()=>{r!==$s.A&&e(new br(Na(s)),r)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function yc(t,e){return hc(t).put(function(t,e){return{targetId:0,path:Aa(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class wc{constructor(){this.changes=new No((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,$r.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?tu.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class vc{constructor(t){this.M=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return Tc(t).put(n)}removeEntry(t,e,n){return Tc(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],wu(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.Fn(t,n))))}getEntry(t,e){let n=$r.newInvalidDocument(e);return Tc(t).Wt({index:"documentKeyIndex",range:IDBKeyRange.only(Ec(e))},((t,s)=>{n=this.$n(e,s)})).next((()=>n))}Bn(t,e){let n={size:0,document:$r.newInvalidDocument(e)};return Tc(t).Wt({index:"documentKeyIndex",range:IDBKeyRange.only(Ec(e))},((t,s)=>{n={document:this.$n(e,s),size:tc(s)}})).next((()=>n))}getEntries(t,e){let n=ko();return this.Ln(t,e,((t,e)=>{const s=this.$n(t,e);n=n.insert(t,s)})).next((()=>n))}Un(t,e){let n=ko(),s=new ei(br.comparator);return this.Ln(t,e,((t,e)=>{const r=this.$n(t,e);n=n.insert(t,r),s=s.insert(t,tc(e))})).next((()=>({documents:n,qn:s})))}Ln(t,e,n){if(e.isEmpty())return tu.resolve();let s=new ri(_c);e.forEach((t=>s=s.add(t)));const r=IDBKeyRange.bound(Ec(s.first()),Ec(s.last())),i=s.getIterator();let o=i.getNext();return Tc(t).Wt({index:"documentKeyIndex",range:r},((t,e,s)=>{const r=br.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;o&&_c(o,r)<0;)n(o,null),o=i.getNext();o&&o.isEqual(r)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?s.Ut(Ec(o)):s.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getAllFromCollection(t,e,n){const s=[e.popLast().toArray(),e.lastSegment(),wu(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],r=[e.popLast().toArray(),e.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Tc(t).qt(IDBKeyRange.bound(s,r,!0)).next((t=>{let e=ko();for(const n of t){const t=this.$n(br.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);e=e.insert(t.key,t)}return e}))}getAllFromCollectionGroup(t,e,n,s){let r=ko();const i=Sc(e,n),o=Sc(e,Zr.max());return Tc(t).Wt({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((t,e,n)=>{const i=this.$n(br.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);r=r.insert(i.key,i),r.size===s&&n.done()})).next((()=>r))}newChangeBuffer(t){return new Ic(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return bc(t).get("remoteDocumentGlobalKey").next((t=>(Cs(!!t),t)))}Fn(t,e){return bc(t).put("remoteDocumentGlobalKey",e)}$n(t,e){if(e){const t=function(t,e){let n;if(e.document)n=la(t.Jt,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=br.fromSegments(e.noDocument.path),s=Iu(e.noDocument.readTime);n=$r.newNoDocument(t,s),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return Ns();{const t=br.fromSegments(e.unknownDocument.path),s=Iu(e.unknownDocument.version);n=$r.newUnknownDocument(t,s)}}return e.readTime&&n.setReadTime(function(t){const e=new Xs(t[0],t[1]);return Js.fromTimestamp(e)}(e.readTime)),n}(this.M,e);if(!t.isNoDocument()||!t.version.isEqual(Js.min()))return t}return $r.newInvalidDocument(t)}}class Ic extends wc{constructor(t,e){super(),this.Kn=t,this.trackRemovals=e,this.Gn=new No((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,s=new ri(((t,e)=>Ws(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((r,i)=>{const o=this.Gn.get(r);if(e.push(this.Kn.removeEntry(t,r,o.readTime)),i.isValidDocument()){const a=yu(this.Kn.M,i);s=s.add(r.path.popLast());const u=tc(a);n+=u-o.size,e.push(this.Kn.addEntry(t,r,a))}else if(n-=o.size,this.trackRemovals){const n=yu(this.Kn.M,i.convertToNoDocument(Js.min()));e.push(this.Kn.addEntry(t,r,n))}})),s.forEach((n=>{e.push(this.Kn.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.Kn.updateMetadata(t,n)),tu.waitFor(e)}getFromCache(t,e){return this.Kn.Bn(t,e).next((t=>(this.Gn.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.Kn.Un(t,e).next((({documents:t,qn:e})=>(e.forEach(((e,n)=>{this.Gn.set(e,{size:n,readTime:t.get(e).readTime})})),t)))}}function bc(t){return lu(t,"remoteDocumentGlobal")}function Tc(t){return lu(t,"remoteDocumentsV14")}function Ec(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Sc(t,e){const n=e.documentKey.path.toArray();return[t,wu(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function _c(t,e){const n=t.path.toArray(),s=e.path.toArray();let r=0;for(let t=0;t<n.length-2&&t<s.length-2;++t)if(r=Ws(n[t],s[t]),r)return r;return r=Ws(n.length,s.length),r||(r=Ws(n[n.length-2],s[s.length-2]),r||Ws(n[n.length-1],s[s.length-1]))}class Ac{constructor(t){this.M=t}kt(t,e,n,s){const r=new eu("createOrUpgrade",e);n<1&&s>=1&&(function(t){t.createObjectStore("owner")}(t),function(t){t.createObjectStore("mutationQueues",{keyPath:"userId"}),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ca,{unique:!0}),t.createObjectStore("documentMutations")}(t),Dc(t),function(t){t.createObjectStore("remoteDocuments")}(t));let i=tu.resolve();return n<3&&s>=3&&(0!==n&&(function(t){t.deleteObjectStore("targetDocuments"),t.deleteObjectStore("targets"),t.deleteObjectStore("targetGlobal")}(t),Dc(t)),i=i.next((()=>function(t){const e=t.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:Js.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",n)}(r)))),n<4&&s>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store("mutations").qt().next((n=>{t.deleteObjectStore("mutations"),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ca,{unique:!0});const s=e.store("mutations"),r=n.map((t=>s.put(t)));return tu.waitFor(r)}))}(t,r)))),i=i.next((()=>{!function(t){t.createObjectStore("clientMetadata",{keyPath:"clientId"})}(t)}))),n<5&&s>=5&&(i=i.next((()=>this.Qn(r)))),n<6&&s>=6&&(i=i.next((()=>(function(t){t.createObjectStore("remoteDocumentGlobal")}(t),this.jn(r))))),n<7&&s>=7&&(i=i.next((()=>this.Wn(r)))),n<8&&s>=8&&(i=i.next((()=>this.zn(t,r)))),n<9&&s>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&s>=10&&(i=i.next((()=>this.Hn(r)))),n<11&&s>=11&&(i=i.next((()=>{!function(t){t.createObjectStore("bundles",{keyPath:"bundleId"})}(t),function(t){t.createObjectStore("namedQueries",{keyPath:"name"})}(t)}))),n<12&&s>=12&&(i=i.next((()=>{!function(t){const e=t.createObjectStore("documentOverlays",{keyPath:$a});e.createIndex("collectionPathOverlayIndex",za,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",Qa,{unique:!1})}(t)}))),n<13&&s>=13&&(i=i.next((()=>function(t){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:La});e.createIndex("documentKeyIndex",Va),e.createIndex("collectionGroupIndex",Pa)}(t))).next((()=>this.Jn(t,r))).next((()=>t.deleteObjectStore("remoteDocuments")))),n<14&&s>=14&&(i=i.next((()=>{!function(t){t.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),t.createObjectStore("indexState",{keyPath:Ba}).createIndex("sequenceNumberIndex",Ka,{unique:!1}),t.createObjectStore("indexEntries",{keyPath:Ga}).createIndex("documentKeyIndex",ja,{unique:!1})}(t)}))),i}jn(t){let e=0;return t.store("remoteDocuments").Wt(((t,n)=>{e+=tc(n)})).next((()=>{const n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Qn(t){const e=t.store("mutationQueues"),n=t.store("mutations");return e.qt().next((e=>tu.forEach(e,(e=>{const s=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.qt("userMutationsIndex",s).next((n=>tu.forEach(n,(n=>{Cs(n.userId===e.userId);const s=bu(this.M,n);return Zu(t,e.userId,s).next((()=>{}))}))))}))))}Wn(t){const e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next((t=>{const s=[];return n.Wt(((n,r)=>{const i=new sr(n),o=function(t){return[0,Aa(t)]}(i);s.push(e.get(o).next((n=>n?tu.resolve():(n=>e.put({targetId:0,path:Aa(n),sequenceNumber:t.highestListenSequenceNumber}))(i))))})).next((()=>tu.waitFor(s)))}))}zn(t,e){t.createObjectStore("collectionParents",{keyPath:Ua});const n=e.store("collectionParents"),s=new ju,r=t=>{if(s.add(t)){const e=t.lastSegment(),s=t.popLast();return n.put({collectionId:e,parent:Aa(s)})}};return e.store("remoteDocuments").Wt({jt:!0},((t,e)=>{const n=new sr(t);return r(n.popLast())})).next((()=>e.store("documentMutations").Wt({jt:!0},(([t,e,n],s)=>{const i=Na(e);return r(i.popLast())}))))}Hn(t){const e=t.store("targets");return e.Wt(((t,n)=>{const s=Tu(n),r=Eu(this.M,s);return e.put(r)}))}Jn(t,e){const n=e.store("remoteDocuments"),s=[];return n.Wt(((t,n)=>{const r=e.store("remoteDocumentsV14"),i=(o=n,o.document?new br(sr.fromString(o.document.name).popFirst(5)):o.noDocument?br.fromSegments(o.noDocument.path):o.unknownDocument?br.fromSegments(o.unknownDocument.path):Ns()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};s.push(r.put(a))})).next((()=>tu.waitFor(s)))}}function Dc(t){t.createObjectStore("targetDocuments",{keyPath:Fa}).createIndex("documentTargetsIndex",qa,{unique:!0}),t.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Oa,{unique:!0}),t.createObjectStore("targetGlobal")}const xc="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Nc{constructor(t,e,n,s,r,i,o,a,u,c,h=13){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Yn=r,this.window=i,this.document=o,this.Xn=u,this.Zn=c,this.ts=h,this.es=null,this.ns=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ss=null,this.inForeground=!1,this.rs=null,this.os=null,this.us=Number.NEGATIVE_INFINITY,this.cs=t=>Promise.resolve(),!Nc.vt())throw new Ls(Rs.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new pc(this,s),this.hs=e+"main",this.M=new pu(a),this.ls=new nu(this.hs,this.ts,new Ac(this.M)),this.fs=new ac(this.referenceDelegate,this.M),this.ds=function(t){return new vc(t)}(this.M),this._s=new Du,this.window&&this.window.localStorage?this.ws=this.window.localStorage:(this.ws=null,!1===c&&As("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.gs().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Ls(Rs.FAILED_PRECONDITION,xc);return this.ys(),this.ps(),this.Is(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.fs.getHighestSequenceNumber(t)))})).then((t=>{this.es=new $s(t,this.Xn)})).then((()=>{this.ns=!0})).catch((t=>(this.ls&&this.ls.close(),Promise.reject(t))))}Ts(t){return this.cs=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ls.Ot((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Yn.enqueueAndForget((async()=>{this.started&&await this.gs()})))}gs(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>kc(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.Es(t).next((t=>{t||(this.isPrimary=!1,this.Yn.enqueueRetryable((()=>this.cs(!1))))}))})).next((()=>this.As(t))).next((e=>this.isPrimary&&!e?this.Rs(t).next((()=>!1)):!!e&&this.bs(t).next((()=>!0)))))).catch((t=>{if(iu(t))return _s("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return _s("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.Yn.enqueueRetryable((()=>this.cs(t))),this.isPrimary=t}))}Es(t){return Cc(t).get("owner").next((t=>tu.resolve(this.Ps(t))))}Vs(t){return kc(t).delete(this.clientId)}async vs(){if(this.isPrimary&&!this.Ss(this.us,18e5)){this.us=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=lu(t,"clientMetadata");return e.qt().next((t=>{const n=this.Ds(t,18e5),s=t.filter((t=>-1===n.indexOf(t)));return tu.forEach(s,(t=>e.delete(t.clientId))).next((()=>s))}))})).catch((()=>[]));if(this.ws)for(const e of t)this.ws.removeItem(this.Cs(e.clientId))}}Is(){this.os=this.Yn.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.gs().then((()=>this.vs())).then((()=>this.Is()))))}Ps(t){return!!t&&t.ownerId===this.clientId}As(t){return this.Zn?tu.resolve(!0):Cc(t).get("owner").next((e=>{if(null!==e&&this.Ss(e.leaseTimestampMs,5e3)&&!this.xs(e.ownerId)){if(this.Ps(e)&&this.networkEnabled)return!0;if(!this.Ps(e)){if(!e.allowTabSynchronization)throw new Ls(Rs.FAILED_PRECONDITION,xc);return!1}}return!(!this.networkEnabled||!this.inForeground)||kc(t).qt().next((t=>void 0===this.Ds(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,s=this.networkEnabled===t.networkEnabled;if(e||n&&s)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&_s("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.ns=!1,this.Ns(),this.os&&(this.os.cancel(),this.os=null),this.ks(),this.Ms(),await this.ls.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(t=>{const e=new hu(t,$s.A);return this.Rs(e).next((()=>this.Vs(e)))})),this.ls.close(),this.Os()}Ds(t,e){return t.filter((t=>this.Ss(t.updateTimeMs,e)&&!this.xs(t.clientId)))}Fs(){return this.runTransaction("getActiveClients","readonly",(t=>kc(t).qt().next((t=>this.Ds(t,18e5).map((t=>t.clientId))))))}get started(){return this.ns}getMutationQueue(t,e){return ec.Yt(t,this.M,e,this.referenceDelegate)}getTargetCache(){return this.fs}getRemoteDocumentCache(){return this.ds}getIndexManager(t){return new zu(t,this.M.Jt.databaseId)}getDocumentOverlayCache(t){return Cu.Yt(this.M,t)}getBundleCache(){return this._s}runTransaction(t,e,n){_s("IndexedDbPersistence","Starting transaction:",t);const s="readonly"===e?"readonly":"readwrite",r=14===(i=this.ts)?Xa:13===i?Ya:12===i?Ha:11===i?Wa:void Ns();var i;let o;return this.ls.runTransaction(t,s,r,(s=>(o=new hu(s,this.es?this.es.next():$s.A),"readwrite-primary"===e?this.Es(o).next((t=>!!t||this.As(o))).next((e=>{if(!e)throw As(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Yn.enqueueRetryable((()=>this.cs(!1))),new Ls(Rs.FAILED_PRECONDITION,Ja);return n(o)})).next((t=>this.bs(o).next((()=>t)))):this.$s(o).next((()=>n(o)))))).then((t=>(o.raiseOnCommittedEvent(),t)))}$s(t){return Cc(t).get("owner").next((t=>{if(null!==t&&this.Ss(t.leaseTimestampMs,5e3)&&!this.xs(t.ownerId)&&!this.Ps(t)&&!(this.Zn||this.allowTabSynchronization&&t.allowTabSynchronization))throw new Ls(Rs.FAILED_PRECONDITION,xc)}))}bs(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Cc(t).put("owner",e)}static vt(){return nu.vt()}Rs(t){const e=Cc(t);return e.get("owner").next((t=>this.Ps(t)?(_s("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):tu.resolve()))}Ss(t,e){const n=Date.now();return!(t<n-e||t>n&&(As(`Detected an update time that is in the future: ${t} > ${n}`),1))}ys(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.rs=()=>{this.Yn.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.gs())))},this.document.addEventListener("visibilitychange",this.rs),this.inForeground="visible"===this.document.visibilityState)}ks(){this.rs&&(this.document.removeEventListener("visibilitychange",this.rs),this.rs=null)}ps(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.ss=()=>{this.Ns(),(0,a.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Yn.enterRestrictedMode(!0),this.Yn.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ss))}Ms(){this.ss&&(this.window.removeEventListener("pagehide",this.ss),this.ss=null)}xs(t){var e;try{const n=null!==(null===(e=this.ws)||void 0===e?void 0:e.getItem(this.Cs(t)));return _s("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return As("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}Ns(){if(this.ws)try{this.ws.setItem(this.Cs(this.clientId),String(Date.now()))}catch(t){As("Failed to set zombie client id.",t)}}Os(){if(this.ws)try{this.ws.removeItem(this.Cs(this.clientId))}catch(t){}}Cs(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function Cc(t){return lu(t,"owner")}function kc(t){return lu(t,"clientMetadata")}function Mc(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class Rc{constructor(t,e,n){this.ds=t,this.Bs=e,this.indexManager=n}Ls(t,e){return this.Bs.getAllMutationBatchesAffectingDocumentKey(t,e).next((n=>this.Us(t,e,n)))}Us(t,e,n){return this.ds.getEntry(t,e).next((t=>{for(const e of n)e.applyToLocalView(t);return t}))}qs(t,e){t.forEach(((t,n)=>{for(const t of e)t.applyToLocalView(n)}))}Ks(t,e){return this.ds.getEntries(t,e).next((e=>this.Gs(t,e).next((()=>e))))}Gs(t,e){return this.Bs.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>this.qs(e,t)))}Qs(t,e,n){return function(t){return br.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.js(t,e.path):Li(e)?this.Ws(t,e,n):this.zs(t,e,n)}js(t,e){return this.Ls(t,new br(e)).next((t=>{let e=Ro();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}Ws(t,e,n){const s=e.collectionGroup;let r=Ro();return this.indexManager.getCollectionParents(t,s).next((i=>tu.forEach(i,(i=>{const o=function(t,e){return new Ni(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,i.child(s));return this.zs(t,o,n).next((t=>{t.forEach(((t,e)=>{r=r.insert(t,e)}))}))})).next((()=>r))))}zs(t,e,n){let s;return this.ds.getAllFromCollection(t,e.path,n).next((n=>(s=n,this.Bs.getAllMutationBatchesAffectingQuery(t,e)))).next((t=>{for(const e of t)for(const t of e.mutations){const n=t.key;let r=s.get(n);null==r&&(r=$r.newInvalidDocument(n),s=s.insert(n,r)),fo(t,r,e.localWriteTime),r.isFoundDocument()||(s=s.remove(n))}})).next((()=>(s.forEach(((t,n)=>{Bi(e,n)||(s=s.remove(t))})),s)))}}class Lc{constructor(t,e,n,s){this.targetId=t,this.fromCache=e,this.Hs=n,this.Js=s}static Ys(t,e){let n=Oo(),s=Oo();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:s=s.add(t.doc.key)}return new Lc(t,e.fromCache,n,s)}}class Vc{constructor(){this.Xs=!1}initialize(t,e){this.Zs=t,this.indexManager=e,this.Xs=!0}Qs(t,e,n,s){return this.ti(t,e).next((r=>r||this.ei(t,e,s,n))).next((n=>n||this.ni(t,e)))}ti(t,e){return tu.resolve(null)}ei(t,e,n,s){return function(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}(e)||s.isEqual(Js.min())?this.ni(t,e):this.Zs.Ks(t,n).next((r=>{const i=this.si(e,r);return this.ii(e,i,n,s)?this.ni(t,e):(Es()<=o.in.DEBUG&&_s("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),Ui(e)),this.ri(t,i,e,Xr(s,-1)))}))}si(t,e){let n=new ri(Gi(t));return e.forEach(((e,s)=>{Bi(t,s)&&(n=n.add(s))})),n}ii(t,e,n,s){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const r="F"===t.limitType?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(s)>0)}ni(t,e){return Es()<=o.in.DEBUG&&_s("QueryEngine","Using full collection scan to execute query:",Ui(e)),this.Zs.Qs(t,e,Zr.min())}ri(t,e,n,s){return this.Zs.Qs(t,n,s).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}class Pc{constructor(t,e,n,s){this.persistence=t,this.oi=e,this.M=s,this.ui=new ei(Ws),this.ai=new No((t=>ci(t)),hi),this.ci=new Map,this.hi=t.getRemoteDocumentCache(),this.fs=t.getTargetCache(),this._s=t.getBundleCache(),this.li(n)}li(t){this.indexManager=this.persistence.getIndexManager(t),this.Bs=this.persistence.getMutationQueue(t,this.indexManager),this.fi=new Rc(this.hi,this.Bs,this.indexManager),this.hi.setIndexManager(this.indexManager),this.oi.initialize(this.fi,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.ui)))}}function Oc(t,e,n,s){return new Pc(t,e,n,s)}async function Fc(t,e){const n=Ms(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let s;return n.Bs.getAllMutationBatches(t).next((r=>(s=r,n.li(e),n.Bs.getAllMutationBatches(t)))).next((e=>{const r=[],i=[];let o=Oo();for(const t of s){r.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.fi.Ks(t,o).next((t=>({di:t,removedBatchIds:r,addedBatchIds:i})))}))}))}function qc(t){const e=Ms(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.fs.getLastRemoteSnapshotVersion(t)))}function Uc(t,e,n){let s=Oo();return n.forEach((t=>s=s.add(t))),e.getEntries(t,s).next((t=>{let s=ko();return n.forEach(((n,r)=>{const i=t.get(n);r.isNoDocument()&&r.version.isEqual(Js.min())?(e.removeEntry(n,r.readTime),s=s.insert(n,r)):!i.isValidDocument()||r.version.compareTo(i.version)>0||0===r.version.compareTo(i.version)&&i.hasPendingWrites?(e.addEntry(r),s=s.insert(n,r)):_s("LocalStore","Ignoring outdated watch update for ",n,". Current version:",i.version," Watch version:",r.version)})),s}))}function Bc(t,e){const n=Ms(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.Bs.getNextMutationBatchAfterBatchId(t,e))))}function Kc(t,e){const n=Ms(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let s;return n.fs.getTargetData(t,e).next((r=>r?(s=r,tu.resolve(s)):n.fs.allocateTargetId(t).next((r=>(s=new gu(e,r,0,t.currentSequenceNumber),n.fs.addTargetData(t,s).next((()=>s)))))))})).then((t=>{const s=n.ui.get(t.targetId);return(null===s||t.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(n.ui=n.ui.insert(t.targetId,t),n.ai.set(e,t.targetId)),t}))}async function Gc(t,e,n){const s=Ms(t),r=s.ui.get(e),i=n?"readwrite":"readwrite-primary";try{n||await s.persistence.runTransaction("Release target",i,(t=>s.persistence.referenceDelegate.removeTarget(t,r)))}catch(t){if(!iu(t))throw t;_s("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}s.ui=s.ui.remove(e),s.ai.delete(r.target)}function jc(t,e,n){const s=Ms(t);let r=Js.min(),i=Oo();return s.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const s=Ms(t),r=s.ai.get(n);return void 0!==r?tu.resolve(s.ui.get(r)):s.fs.getTargetData(e,n)}(s,t,Pi(e)).next((e=>{if(e)return r=e.lastLimboFreeSnapshotVersion,s.fs.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>s.oi.Qs(t,e,n?r:Js.min(),n?i:Oo()))).next((t=>(Qc(s,Ki(e),t),{documents:t,_i:i})))))}function $c(t,e){const n=Ms(t),s=Ms(n.fs),r=n.ui.get(e);return r?Promise.resolve(r.target):n.persistence.runTransaction("Get target data","readonly",(t=>s.Et(t,e).next((t=>t?t.target:null))))}function zc(t,e){const n=Ms(t),s=n.ci.get(e)||Js.min();return n.persistence.runTransaction("Get new document changes","readonly",(t=>n.hi.getAllFromCollectionGroup(t,e,Xr(s,-1),Number.MAX_SAFE_INTEGER))).then((t=>(Qc(n,e,t),t)))}function Qc(t,e,n){let s=Js.min();n.forEach(((t,e)=>{e.readTime.compareTo(s)>0&&(s=e.readTime)})),t.ci.set(e,s)}async function Wc(t,e,n=Oo()){const s=await Kc(t,Pi(Su(e.bundledQuery))),r=Ms(t);return r.persistence.runTransaction("Save named query","readwrite",(t=>{const i=ea(e.readTime);if(s.snapshotVersion.compareTo(i)>=0)return r._s.saveNamedQuery(t,e);const o=s.withResumeToken(ur.EMPTY_BYTE_STRING,i);return r.ui=r.ui.insert(o.targetId,o),r.fs.updateTargetData(t,o).next((()=>r.fs.removeMatchingKeysForTargetId(t,s.targetId))).next((()=>r.fs.addMatchingKeys(t,n,s.targetId))).next((()=>r._s.saveNamedQuery(t,e)))}))}class Hc{constructor(t){this.M=t,this.yi=new Map,this.pi=new Map}getBundleMetadata(t,e){return tu.resolve(this.yi.get(e))}saveBundleMetadata(t,e){var n;return this.yi.set(e.id,{id:(n=e).id,version:n.version,createTime:ea(n.createTime)}),tu.resolve()}getNamedQuery(t,e){return tu.resolve(this.pi.get(e))}saveNamedQuery(t,e){return this.pi.set(e.name,function(t){return{name:t.name,query:Su(t.bundledQuery),readTime:ea(t.readTime)}}(e)),tu.resolve()}}class Yc{constructor(){this.overlays=new ei(br.comparator),this.Ii=new Map}getOverlay(t,e){return tu.resolve(this.overlays.get(e))}saveOverlays(t,e,n){return n.forEach(((n,s)=>{this.Xt(t,e,s)})),tu.resolve()}removeOverlaysForBatchId(t,e,n){const s=this.Ii.get(n);return void 0!==s&&(s.forEach((t=>this.overlays=this.overlays.remove(t))),this.Ii.delete(n)),tu.resolve()}getOverlaysForCollection(t,e,n){const s=Lo(),r=e.length+1,i=new br(e.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const t=o.getNext().value,i=t.getKey();if(!e.isPrefixOf(i.path))break;i.path.length===r&&t.largestBatchId>n&&s.set(t.getKey(),t)}return tu.resolve(s)}getOverlaysForCollectionGroup(t,e,n,s){let r=new ei(((t,e)=>t-e));const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=r.get(t.largestBatchId);null===e&&(e=Lo(),r=r.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=Lo(),a=r.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((t,e)=>o.set(t,e))),!(o.size()>=s)););return tu.resolve(o)}Xt(t,e,n){if(null===n)return;const s=this.overlays.get(n.key);if(null!==s){const t=this.Ii.get(s.largestBatchId).delete(n.key);this.Ii.set(s.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new mu(e,n));let r=this.Ii.get(e);void 0===r&&(r=Oo(),this.Ii.set(e,r)),this.Ii.set(e,r.add(n.key))}}class Xc{constructor(){this.Ti=new ri(Jc.Ei),this.Ai=new ri(Jc.Ri)}isEmpty(){return this.Ti.isEmpty()}addReference(t,e){const n=new Jc(t,e);this.Ti=this.Ti.add(n),this.Ai=this.Ai.add(n)}bi(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.Pi(new Jc(t,e))}Vi(t,e){t.forEach((t=>this.removeReference(t,e)))}vi(t){const e=new br(new sr([])),n=new Jc(e,t),s=new Jc(e,t+1),r=[];return this.Ai.forEachInRange([n,s],(t=>{this.Pi(t),r.push(t.key)})),r}Si(){this.Ti.forEach((t=>this.Pi(t)))}Pi(t){this.Ti=this.Ti.delete(t),this.Ai=this.Ai.delete(t)}Di(t){const e=new br(new sr([])),n=new Jc(e,t),s=new Jc(e,t+1);let r=Oo();return this.Ai.forEachInRange([n,s],(t=>{r=r.add(t.key)})),r}containsKey(t){const e=new Jc(t,0),n=this.Ti.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Jc{constructor(t,e){this.key=t,this.Ci=e}static Ei(t,e){return br.comparator(t.key,e.key)||Ws(t.Ci,e.Ci)}static Ri(t,e){return Ws(t.Ci,e.Ci)||br.comparator(t.key,e.key)}}class Zc{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.Bs=[],this.xi=1,this.Ni=new ri(Jc.Ei)}checkEmpty(t){return tu.resolve(0===this.Bs.length)}addMutationBatch(t,e,n,s){const r=this.xi;this.xi++,this.Bs.length>0&&this.Bs[this.Bs.length-1];const i=new du(r,e,n,s);this.Bs.push(i);for(const e of s)this.Ni=this.Ni.add(new Jc(e.key,r)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return tu.resolve(i)}lookupMutationBatch(t,e){return tu.resolve(this.ki(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=this.Mi(n),r=s<0?0:s;return tu.resolve(this.Bs.length>r?this.Bs[r]:null)}getHighestUnacknowledgedBatchId(){return tu.resolve(0===this.Bs.length?-1:this.xi-1)}getAllMutationBatches(t){return tu.resolve(this.Bs.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Jc(e,0),s=new Jc(e,Number.POSITIVE_INFINITY),r=[];return this.Ni.forEachInRange([n,s],(t=>{const e=this.ki(t.Ci);r.push(e)})),tu.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new ri(Ws);return e.forEach((t=>{const e=new Jc(t,0),s=new Jc(t,Number.POSITIVE_INFINITY);this.Ni.forEachInRange([e,s],(t=>{n=n.add(t.Ci)}))})),tu.resolve(this.Oi(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1;let r=n;br.isDocumentKey(r)||(r=r.child(""));const i=new Jc(new br(r),0);let o=new ri(Ws);return this.Ni.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===s&&(o=o.add(t.Ci)),!0)}),i),tu.resolve(this.Oi(o))}Oi(t){const e=[];return t.forEach((t=>{const n=this.ki(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){Cs(0===this.Fi(e.batchId,"removed")),this.Bs.shift();let n=this.Ni;return tu.forEach(e.mutations,(s=>{const r=new Jc(s.key,e.batchId);return n=n.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,s.key)})).next((()=>{this.Ni=n}))}_n(t){}containsKey(t,e){const n=new Jc(e,0),s=this.Ni.firstAfterOrEqual(n);return tu.resolve(e.isEqual(s&&s.key))}performConsistencyCheck(t){return this.Bs.length,tu.resolve()}Fi(t,e){return this.Mi(t)}Mi(t){return 0===this.Bs.length?0:t-this.Bs[0].batchId}ki(t){const e=this.Mi(t);return e<0||e>=this.Bs.length?null:this.Bs[e]}}class th{constructor(t){this.$i=t,this.docs=new ei(br.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,s=this.docs.get(n),r=s?s.size:0,i=this.$i(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:i}),this.size+=i-r,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return tu.resolve(n?n.document.mutableCopy():$r.newInvalidDocument(e))}getEntries(t,e){let n=ko();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():$r.newInvalidDocument(t))})),tu.resolve(n)}getAllFromCollection(t,e,n){let s=ko();const r=new br(e.child("")),i=this.docs.getIteratorFrom(r);for(;i.hasNext();){const{key:t,value:{document:r}}=i.getNext();if(!e.isPrefixOf(t.path))break;t.path.length>e.length+1||ti(Jr(r),n)<=0||(s=s.insert(r.key,r.mutableCopy()))}return tu.resolve(s)}getAllFromCollectionGroup(t,e,n,s){Ns()}Bi(t,e){return tu.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new eh(this)}getSize(t){return tu.resolve(this.size)}}class eh extends wc{constructor(t){super(),this.Kn=t}applyChanges(t){const e=[];return this.changes.forEach(((n,s)=>{s.isValidDocument()?e.push(this.Kn.addEntry(t,s)):this.Kn.removeEntry(n)})),tu.waitFor(e)}getFromCache(t,e){return this.Kn.getEntry(t,e)}getAllFromCache(t,e){return this.Kn.getEntries(t,e)}}class nh{constructor(t){this.persistence=t,this.Li=new No((t=>ci(t)),hi),this.lastRemoteSnapshotVersion=Js.min(),this.highestTargetId=0,this.Ui=0,this.qi=new Xc,this.targetCount=0,this.Ki=oc.gn()}forEachTarget(t,e){return this.Li.forEach(((t,n)=>e(n))),tu.resolve()}getLastRemoteSnapshotVersion(t){return tu.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return tu.resolve(this.Ui)}allocateTargetId(t){return this.highestTargetId=this.Ki.next(),tu.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Ui&&(this.Ui=e),tu.resolve()}Tn(t){this.Li.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.Ki=new oc(e),this.highestTargetId=e),t.sequenceNumber>this.Ui&&(this.Ui=t.sequenceNumber)}addTargetData(t,e){return this.Tn(e),this.targetCount+=1,tu.resolve()}updateTargetData(t,e){return this.Tn(e),tu.resolve()}removeTargetData(t,e){return this.Li.delete(e.target),this.qi.vi(e.targetId),this.targetCount-=1,tu.resolve()}removeTargets(t,e,n){let s=0;const r=[];return this.Li.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Li.delete(i),r.push(this.removeMatchingKeysForTargetId(t,o.targetId)),s++)})),tu.waitFor(r).next((()=>s))}getTargetCount(t){return tu.resolve(this.targetCount)}getTargetData(t,e){const n=this.Li.get(e)||null;return tu.resolve(n)}addMatchingKeys(t,e,n){return this.qi.bi(e,n),tu.resolve()}removeMatchingKeys(t,e,n){this.qi.Vi(e,n);const s=this.persistence.referenceDelegate,r=[];return s&&e.forEach((e=>{r.push(s.markPotentiallyOrphaned(t,e))})),tu.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.qi.vi(e),tu.resolve()}getMatchingKeysForTargetId(t,e){const n=this.qi.Di(e);return tu.resolve(n)}containsKey(t,e){return tu.resolve(this.qi.containsKey(e))}}class sh{constructor(t,e){this.Gi={},this.overlays={},this.es=new $s(0),this.ns=!1,this.ns=!0,this.referenceDelegate=t(this),this.fs=new nh(this),this.indexManager=new Gu,this.ds=function(t){return new th(t)}((t=>this.referenceDelegate.Qi(t))),this.M=new pu(e),this._s=new Hc(this.M)}start(){return Promise.resolve()}shutdown(){return this.ns=!1,Promise.resolve()}get started(){return this.ns}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Yc,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.Gi[t.toKey()];return n||(n=new Zc(e,this.referenceDelegate),this.Gi[t.toKey()]=n),n}getTargetCache(){return this.fs}getRemoteDocumentCache(){return this.ds}getBundleCache(){return this._s}runTransaction(t,e,n){_s("MemoryPersistence","Starting transaction:",t);const s=new rh(this.es.next());return this.referenceDelegate.ji(),n(s).next((t=>this.referenceDelegate.Wi(s).next((()=>t)))).toPromise().then((t=>(s.raiseOnCommittedEvent(),t)))}zi(t,e){return tu.or(Object.values(this.Gi).map((n=>()=>n.containsKey(t,e))))}}class rh extends Za{constructor(t){super(),this.currentSequenceNumber=t}}class ih{constructor(t){this.persistence=t,this.Hi=new Xc,this.Ji=null}static Yi(t){return new ih(t)}get Xi(){if(this.Ji)return this.Ji;throw Ns()}addReference(t,e,n){return this.Hi.addReference(n,e),this.Xi.delete(n.toString()),tu.resolve()}removeReference(t,e,n){return this.Hi.removeReference(n,e),this.Xi.add(n.toString()),tu.resolve()}markPotentiallyOrphaned(t,e){return this.Xi.add(e.toString()),tu.resolve()}removeTarget(t,e){this.Hi.vi(e.targetId).forEach((t=>this.Xi.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.Xi.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}ji(){this.Ji=new Set}Wi(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return tu.forEach(this.Xi,(n=>{const s=br.fromPath(n);return this.Zi(t,s).next((t=>{t||e.removeEntry(s,Js.min())}))})).next((()=>(this.Ji=null,e.apply(t))))}updateLimboDocument(t,e){return this.Zi(t,e).next((t=>{t?this.Xi.delete(e.toString()):this.Xi.add(e.toString())}))}Qi(t){return 0}Zi(t,e){return tu.or([()=>tu.resolve(this.Hi.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.zi(t,e)])}}function oh(t,e){return`firestore_clients_${t}_${e}`}function ah(t,e,n){let s=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(s+=`_${e.uid}`),s}function uh(t,e){return`firestore_targets_${t}_${e}`}class ch{constructor(t,e,n,s){this.user=t,this.batchId=e,this.state=n,this.error=s}static tr(t,e,n){const s=JSON.parse(n);let r,i="object"==typeof s&&-1!==["pending","acknowledged","rejected"].indexOf(s.state)&&(void 0===s.error||"object"==typeof s.error);return i&&s.error&&(i="string"==typeof s.error.message&&"string"==typeof s.error.code,i&&(r=new Ls(s.error.code,s.error.message))),i?new ch(t,e,s.state,r):(As("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}er(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class hh{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static tr(t,e){const n=JSON.parse(e);let s,r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code,r&&(s=new Ls(n.error.code,n.error.message))),r?new hh(t,n.state,s):(As("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}er(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class lh{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static tr(t,e){const n=JSON.parse(e);let s="object"==typeof n&&n.activeTargetIds instanceof Array,r=qo();for(let t=0;s&&t<n.activeTargetIds.length;++t)s=Ir(n.activeTargetIds[t]),r=r.add(n.activeTargetIds[t]);return s?new lh(t,r):(As("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class dh{constructor(t,e){this.clientId=t,this.onlineState=e}static tr(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new dh(e.clientId,e.onlineState):(As("SharedClientState",`Failed to parse online state: ${t}`),null)}}class fh{constructor(){this.activeTargetIds=qo()}nr(t){this.activeTargetIds=this.activeTargetIds.add(t)}sr(t){this.activeTargetIds=this.activeTargetIds.delete(t)}er(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class mh{constructor(t,e,n,s,r){this.window=t,this.Yn=e,this.persistenceKey=n,this.ir=s,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.rr=this.ur.bind(this),this.ar=new ei(Ws),this.started=!1,this.cr=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=r,this.hr=oh(this.persistenceKey,this.ir),this.lr=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.ar=this.ar.insert(this.ir,new fh),this.dr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this._r=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.wr=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.mr=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.gr=function(t){return`firestore_bundle_loaded_v2_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.rr)}static vt(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.Fs();for(const e of t){if(e===this.ir)continue;const t=this.getItem(oh(this.persistenceKey,e));if(t){const n=lh.tr(e,t);n&&(this.ar=this.ar.insert(n.clientId,n))}}this.yr();const e=this.storage.getItem(this.mr);if(e){const t=this.pr(e);t&&this.Ir(t)}for(const t of this.cr)this.ur(t);this.cr=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.lr,JSON.stringify(t))}getAllActiveQueryTargets(){return this.Tr(this.ar)}isActiveQueryTarget(t){let e=!1;return this.ar.forEach(((n,s)=>{s.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.Er(t,"pending")}updateMutationState(t,e,n){this.Er(t,e,n),this.Ar(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(uh(this.persistenceKey,t));if(n){const s=hh.tr(t,n);s&&(e=s.state)}}return this.Rr.nr(t),this.yr(),e}removeLocalQueryTarget(t){this.Rr.sr(t),this.yr()}isLocalQueryTarget(t){return this.Rr.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(uh(this.persistenceKey,t))}updateQueryState(t,e,n){this.br(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.Ar(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.Pr(t)}notifyBundleLoaded(t){this.Vr(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.rr),this.removeItem(this.hr),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return _s("SharedClientState","READ",t,e),e}setItem(t,e){_s("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){_s("SharedClientState","REMOVE",t),this.storage.removeItem(t)}ur(t){const e=t;if(e.storageArea===this.storage){if(_s("SharedClientState","EVENT",e.key,e.newValue),e.key===this.hr)return void As("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Yn.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.dr.test(e.key)){if(null==e.newValue){const t=this.vr(e.key);return this.Sr(t,null)}{const t=this.Dr(e.key,e.newValue);if(t)return this.Sr(t.clientId,t)}}else if(this._r.test(e.key)){if(null!==e.newValue){const t=this.Cr(e.key,e.newValue);if(t)return this.Nr(t)}}else if(this.wr.test(e.key)){if(null!==e.newValue){const t=this.kr(e.key,e.newValue);if(t)return this.Mr(t)}}else if(e.key===this.mr){if(null!==e.newValue){const t=this.pr(e.newValue);if(t)return this.Ir(t)}}else if(e.key===this.lr){const t=function(t){let e=$s.A;if(null!=t)try{const n=JSON.parse(t);Cs("number"==typeof n),e=n}catch(t){As("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==$s.A&&this.sequenceNumberHandler(t)}else if(e.key===this.gr){const t=this.Or(e.newValue);await Promise.all(t.map((t=>this.syncEngine.Fr(t))))}}else this.cr.push(e)}))}}get Rr(){return this.ar.get(this.ir)}yr(){this.setItem(this.hr,this.Rr.er())}Er(t,e,n){const s=new ch(this.currentUser,t,e,n),r=ah(this.persistenceKey,this.currentUser,t);this.setItem(r,s.er())}Ar(t){const e=ah(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Pr(t){const e={clientId:this.ir,onlineState:t};this.storage.setItem(this.mr,JSON.stringify(e))}br(t,e,n){const s=uh(this.persistenceKey,t),r=new hh(t,e,n);this.setItem(s,r.er())}Vr(t){const e=JSON.stringify(Array.from(t));this.setItem(this.gr,e)}vr(t){const e=this.dr.exec(t);return e?e[1]:null}Dr(t,e){const n=this.vr(t);return lh.tr(n,e)}Cr(t,e){const n=this._r.exec(t),s=Number(n[1]),r=void 0!==n[2]?n[2]:null;return ch.tr(new Is(r),s,e)}kr(t,e){const n=this.wr.exec(t),s=Number(n[1]);return hh.tr(s,e)}pr(t){return dh.tr(t)}Or(t){return JSON.parse(t)}async Nr(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.$r(t.batchId,t.state,t.error);_s("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}Mr(t){return this.syncEngine.Br(t.targetId,t.state,t.error)}Sr(t,e){const n=e?this.ar.insert(t,e):this.ar.remove(t),s=this.Tr(this.ar),r=this.Tr(n),i=[],o=[];return r.forEach((t=>{s.has(t)||i.push(t)})),s.forEach((t=>{r.has(t)||o.push(t)})),this.syncEngine.Lr(i,o).then((()=>{this.ar=n}))}Ir(t){this.ar.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}Tr(t){let e=qo();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class gh{constructor(){this.Ur=new fh,this.qr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.Ur.nr(t),this.qr[t]||"not-current"}updateQueryState(t,e,n){this.qr[t]=e}removeLocalQueryTarget(t){this.Ur.sr(t)}isLocalQueryTarget(t){return this.Ur.activeTargetIds.has(t)}clearQueryState(t){delete this.qr[t]}getAllActiveQueryTargets(){return this.Ur.activeTargetIds}isActiveQueryTarget(t){return this.Ur.activeTargetIds.has(t)}start(){return this.Ur=new fh,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class ph{Kr(t){}shutdown(){}}class yh{constructor(){this.Gr=()=>this.Qr(),this.jr=()=>this.Wr(),this.zr=[],this.Hr()}Kr(t){this.zr.push(t)}shutdown(){window.removeEventListener("online",this.Gr),window.removeEventListener("offline",this.jr)}Hr(){window.addEventListener("online",this.Gr),window.addEventListener("offline",this.jr)}Qr(){_s("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.zr)t(0)}Wr(){_s("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.zr)t(1)}static vt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const wh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class vh{constructor(t){this.Jr=t.Jr,this.Yr=t.Yr}Xr(t){this.Zr=t}eo(t){this.no=t}onMessage(t){this.so=t}close(){this.Yr()}send(t){this.Jr(t)}io(){this.Zr()}ro(t){this.no(t)}oo(t){this.so(t)}}class Ih extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.uo=e+"://"+t.host,this.ao="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}co(t,e,n,s,r){const i=this.ho(t,e);_s("RestConnection","Sending: ",i,n);const o={};return this.lo(o,s,r),this.fo(t,i,o,n).then((t=>(_s("RestConnection","Received: ",t),t)),(e=>{throw Ds("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e}))}_o(t,e,n,s,r){return this.co(t,e,n,s,r)}lo(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+bs,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}ho(t,e){const n=wh[t];return`${this.uo}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}fo(t,e,n,s){return new Promise(((r,i)=>{const o=new ys;o.listenOnce(ds.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case ls.NO_ERROR:const e=o.getResponseJson();_s("Connection","XHR received:",JSON.stringify(e)),r(e);break;case ls.TIMEOUT:_s("Connection",'RPC "'+t+'" timed out'),i(new Ls(Rs.DEADLINE_EXCEEDED,"Request time out"));break;case ls.HTTP_ERROR:const n=o.getStatus();if(_s("Connection",'RPC "'+t+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const t=o.getResponseJson().error;if(t&&t.status&&t.message){const e=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(Rs).indexOf(e)>=0?e:Rs.UNKNOWN}(t.status);i(new Ls(e,t.message))}else i(new Ls(Rs.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new Ls(Rs.UNAVAILABLE,"Connection failed."));break;default:Ns()}}finally{_s("Connection",'RPC "'+t+'" completed.')}}));const a=JSON.stringify(s);o.send(e,"POST",a,n,15)}))}wo(t,e,n){const s=[this.uo,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=cs(),i=hs(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new gs({})),this.lo(o.initMessageHeaders,e,n),(0,a.uI)()||(0,a.b$)()||(0,a.d)()||(0,a.w1)()||(0,a.Mn)()||(0,a.ru)()||(o.httpHeadersOverwriteParam="$httpHeaders");const u=s.join("");_s("Connection","Creating WebChannel: "+u,o);const c=r.createWebChannel(u,o);let h=!1,l=!1;const d=new vh({Jr:t=>{l?_s("Connection","Not sending because WebChannel is closed:",t):(h||(_s("Connection","Opening WebChannel transport."),c.open(),h=!0),_s("Connection","WebChannel sending:",t),c.send(t))},Yr:()=>c.close()}),f=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return f(c,ps.EventType.OPEN,(()=>{l||_s("Connection","WebChannel transport opened.")})),f(c,ps.EventType.CLOSE,(()=>{l||(l=!0,_s("Connection","WebChannel transport closed"),d.ro())})),f(c,ps.EventType.ERROR,(t=>{l||(l=!0,Ds("Connection","WebChannel transport errored:",t),d.ro(new Ls(Rs.UNAVAILABLE,"The operation could not be completed")))})),f(c,ps.EventType.MESSAGE,(t=>{var e;if(!l){const n=t.data[0];Cs(!!n);const s=n,r=s.error||(null===(e=s[0])||void 0===e?void 0:e.error);if(r){_s("Connection","WebChannel received error:",r);const t=r.status;let e=function(t){const e=_o[t];if(void 0!==e)return xo(e)}(t),n=r.message;void 0===e&&(e=Rs.INTERNAL,n="Unknown error status: "+t+" with message "+r.message),l=!0,d.ro(new Ls(e,n)),c.close()}else _s("Connection","WebChannel received:",n),d.oo(n)}})),f(i,fs.STAT_EVENT,(t=>{t.stat===ms.PROXY?_s("Connection","Detected buffering proxy"):t.stat===ms.NOPROXY&&_s("Connection","Detected no buffering proxy")})),setTimeout((()=>{d.io()}),0),d}}function bh(){return"undefined"!=typeof window?window:null}function Th(){return"undefined"!=typeof document?document:null}function Eh(t){return new Xo(t,!0)}class Sh{constructor(t,e,n=1e3,s=1.5,r=6e4){this.Yn=t,this.timerId=e,this.mo=n,this.yo=s,this.po=r,this.Io=0,this.To=null,this.Eo=Date.now(),this.reset()}reset(){this.Io=0}Ao(){this.Io=this.po}Ro(t){this.cancel();const e=Math.floor(this.Io+this.bo()),n=Math.max(0,Date.now()-this.Eo),s=Math.max(0,e-n);s>0&&_s("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.Io} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.To=this.Yn.enqueueAfterDelay(this.timerId,s,(()=>(this.Eo=Date.now(),t()))),this.Io*=this.yo,this.Io<this.mo&&(this.Io=this.mo),this.Io>this.po&&(this.Io=this.po)}Po(){null!==this.To&&(this.To.skipDelay(),this.To=null)}cancel(){null!==this.To&&(this.To.cancel(),this.To=null)}bo(){return(Math.random()-.5)*this.Io}}class _h{constructor(t,e,n,s,r,i,o,a){this.Yn=t,this.Vo=n,this.vo=s,this.So=r,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Do=0,this.Co=null,this.xo=null,this.stream=null,this.No=new Sh(t,e)}ko(){return 1===this.state||5===this.state||this.Mo()}Mo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Oo()}async stop(){this.ko()&&await this.close(0)}Fo(){this.state=0,this.No.reset()}$o(){this.Mo()&&null===this.Co&&(this.Co=this.Yn.enqueueAfterDelay(this.Vo,6e4,(()=>this.Bo())))}Lo(t){this.Uo(),this.stream.send(t)}async Bo(){if(this.Mo())return this.close(0)}Uo(){this.Co&&(this.Co.cancel(),this.Co=null)}qo(){this.xo&&(this.xo.cancel(),this.xo=null)}async close(t,e){this.Uo(),this.qo(),this.No.cancel(),this.Do++,4!==t?this.No.reset():e&&e.code===Rs.RESOURCE_EXHAUSTED?(As(e.toString()),As("Using maximum backoff delay to prevent overloading the backend."),this.No.Ao()):e&&e.code===Rs.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Ko(),this.stream.close(),this.stream=null),this.state=t,await this.listener.eo(e)}Ko(){}auth(){this.state=1;const t=this.Go(this.Do),e=this.Do;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.Do===e&&this.Qo(t,n)}),(e=>{t((()=>{const t=new Ls(Rs.UNKNOWN,"Fetching auth token failed: "+e.message);return this.jo(t)}))}))}Qo(t,e){const n=this.Go(this.Do);this.stream=this.Wo(t,e),this.stream.Xr((()=>{n((()=>(this.state=2,this.xo=this.Yn.enqueueAfterDelay(this.vo,1e4,(()=>(this.Mo()&&(this.state=3),Promise.resolve()))),this.listener.Xr())))})),this.stream.eo((t=>{n((()=>this.jo(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}Oo(){this.state=5,this.No.Ro((async()=>{this.state=0,this.start()}))}jo(t){return _s("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Go(t){return e=>{this.Yn.enqueueAndForget((()=>this.Do===t?e():(_s("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Ah extends _h{constructor(t,e,n,s,r,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,s,i),this.M=r}Wo(t,e){return this.So.wo("Listen",t,e)}onMessage(t){this.No.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const s=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:Ns()}(e.targetChange.targetChangeType||"NO_CHANGE"),r=e.targetChange.targetIds||[],i=function(t,e){return t.N?(Cs(void 0===e||"string"==typeof e),ur.fromBase64String(e||"")):(Cs(void 0===e||e instanceof Uint8Array),ur.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?Rs.UNKNOWN:xo(t.code);return new Ls(e,t.message||"")}(o);n=new jo(s,r,i,a||null)}else if("documentChange"in e){e.documentChange;const s=e.documentChange;s.document,s.document.name,s.document.updateTime;const r=ia(t,s.document.name),i=ea(s.document.updateTime),o=new Gr({mapValue:{fields:s.document.fields}}),a=$r.newFoundDocument(r,i,o),u=s.targetIds||[],c=s.removedTargetIds||[];n=new Ko(u,c,a.key,a)}else if("documentDelete"in e){e.documentDelete;const s=e.documentDelete;s.document;const r=ia(t,s.document),i=s.readTime?ea(s.readTime):Js.min(),o=$r.newNoDocument(r,i),a=s.removedTargetIds||[];n=new Ko([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const s=e.documentRemove;s.document;const r=ia(t,s.document),i=s.removedTargetIds||[];n=new Ko([],i,r,null)}else{if(!("filter"in e))return Ns();{e.filter;const t=e.filter;t.targetId;const s=t.count||0,r=new So(s),i=t.targetId;n=new Go(i,r)}}return n}(this.M,t),n=function(t){if(!("targetChange"in t))return Js.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?Js.min():e.readTime?ea(e.readTime):Js.min()}(t);return this.listener.zo(e,n)}Ho(t){const e={};e.database=ua(this.M),e.addTarget=function(t,e){let n;const s=e.target;return n=li(s)?{documents:ma(t,s)}:{query:ga(t,s)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=Zo(t,e.resumeToken):e.snapshotVersion.compareTo(Js.min())>0&&(n.readTime=Jo(t,e.snapshotVersion.toTimestamp())),n}(this.M,t);const n=function(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Ns()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.M,t);n&&(e.labels=n),this.Lo(e)}Jo(t){const e={};e.database=ua(this.M),e.removeTarget=t,this.Lo(e)}}class Dh extends _h{constructor(t,e,n,s,r,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,s,i),this.M=r,this.Yo=!1}get Xo(){return this.Yo}start(){this.Yo=!1,this.lastStreamToken=void 0,super.start()}Ko(){this.Yo&&this.Zo([])}Wo(t,e){return this.So.wo("Write",t,e)}onMessage(t){if(Cs(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Yo){this.No.reset();const e=function(t,e){return t&&t.length>0?(Cs(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?ea(t.updateTime):ea(e);return n.isEqual(Js.min())&&(n=ea(e)),new ao(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=ea(t.commitTime);return this.listener.tu(n,e)}return Cs(!t.writeResults||0===t.writeResults.length),this.Yo=!0,this.listener.eu()}nu(){const t={};t.database=ua(this.M),this.Lo(t)}Zo(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>da(this.M,t)))};this.Lo(e)}}class xh extends class{}{constructor(t,e,n,s){super(),this.authCredentials=t,this.appCheckCredentials=e,this.So=n,this.M=s,this.su=!1}iu(){if(this.su)throw new Ls(Rs.FAILED_PRECONDITION,"The client has already been terminated.")}co(t,e,n){return this.iu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.So.co(t,e,n,s,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Rs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Ls(Rs.UNKNOWN,t.toString())}))}_o(t,e,n){return this.iu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.So._o(t,e,n,s,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Rs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Ls(Rs.UNKNOWN,t.toString())}))}terminate(){this.su=!0}}class Nh{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.ru=0,this.ou=null,this.uu=!0}au(){0===this.ru&&(this.cu("Unknown"),this.ou=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.ou=null,this.hu("Backend didn't respond within 10 seconds."),this.cu("Offline"),Promise.resolve()))))}lu(t){"Online"===this.state?this.cu("Unknown"):(this.ru++,this.ru>=1&&(this.fu(),this.hu(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.cu("Offline")))}set(t){this.fu(),this.ru=0,"Online"===t&&(this.uu=!1),this.cu(t)}cu(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}hu(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.uu?(As(e),this.uu=!1):_s("OnlineStateTracker",e)}fu(){null!==this.ou&&(this.ou.cancel(),this.ou=null)}}class Ch{constructor(t,e,n,s,r){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.du=[],this._u=new Map,this.wu=new Set,this.mu=[],this.gu=r,this.gu.Kr((t=>{n.enqueueAndForget((async()=>{qh(this)&&(_s("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=Ms(t);e.wu.add(4),await Mh(e),e.yu.set("Unknown"),e.wu.delete(4),await kh(e)}(this))}))})),this.yu=new Nh(n,s)}}async function kh(t){if(qh(t))for(const e of t.mu)await e(!0)}async function Mh(t){for(const e of t.mu)await e(!1)}function Rh(t,e){const n=Ms(t);n._u.has(e.targetId)||(n._u.set(e.targetId,e),Fh(n)?Oh(n):sl(n).Mo()&&Vh(n,e))}function Lh(t,e){const n=Ms(t),s=sl(n);n._u.delete(e),s.Mo()&&Ph(n,e),0===n._u.size&&(s.Mo()?s.$o():qh(n)&&n.yu.set("Unknown"))}function Vh(t,e){t.pu.Z(e.targetId),sl(t).Ho(e)}function Ph(t,e){t.pu.Z(e),sl(t).Jo(e)}function Oh(t){t.pu=new zo({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),Et:e=>t._u.get(e)||null}),sl(t).start(),t.yu.au()}function Fh(t){return qh(t)&&!sl(t).ko()&&t._u.size>0}function qh(t){return 0===Ms(t).wu.size}function Uh(t){t.pu=void 0}async function Bh(t){t._u.forEach(((e,n)=>{Vh(t,e)}))}async function Kh(t,e){Uh(t),Fh(t)?(t.yu.lu(e),Oh(t)):t.yu.set("Unknown")}async function Gh(t,e,n){if(t.yu.set("Online"),e instanceof jo&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const s of e.targetIds)t._u.has(s)&&(await t.remoteSyncer.rejectListen(s,n),t._u.delete(s),t.pu.removeTarget(s))}(t,e)}catch(n){_s("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await jh(t,n)}else if(e instanceof Ko?t.pu.ut(e):e instanceof Go?t.pu._t(e):t.pu.ht(e),!n.isEqual(Js.min()))try{const e=await qc(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.pu.yt(e);return n.targetChanges.forEach(((n,s)=>{if(n.resumeToken.approximateByteSize()>0){const r=t._u.get(s);r&&t._u.set(s,r.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((e=>{const n=t._u.get(e);if(!n)return;t._u.set(e,n.withResumeToken(ur.EMPTY_BYTE_STRING,n.snapshotVersion)),Ph(t,e);const s=new gu(n.target,e,1,n.sequenceNumber);Vh(t,s)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){_s("RemoteStore","Failed to raise snapshot:",e),await jh(t,e)}}async function jh(t,e,n){if(!iu(e))throw e;t.wu.add(1),await Mh(t),t.yu.set("Offline"),n||(n=()=>qc(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{_s("RemoteStore","Retrying IndexedDB access"),await n(),t.wu.delete(1),await kh(t)}))}function $h(t,e){return e().catch((n=>jh(t,n,e)))}async function zh(t){const e=Ms(t),n=rl(e);let s=e.du.length>0?e.du[e.du.length-1].batchId:-1;for(;Qh(e);)try{const t=await Bc(e.localStore,s);if(null===t){0===e.du.length&&n.$o();break}s=t.batchId,Wh(e,t)}catch(t){await jh(e,t)}Hh(e)&&Yh(e)}function Qh(t){return qh(t)&&t.du.length<10}function Wh(t,e){t.du.push(e);const n=rl(t);n.Mo()&&n.Xo&&n.Zo(e.mutations)}function Hh(t){return qh(t)&&!rl(t).ko()&&t.du.length>0}function Yh(t){rl(t).start()}async function Xh(t){rl(t).nu()}async function Jh(t){const e=rl(t);for(const n of t.du)e.Zo(n.mutations)}async function Zh(t,e,n){const s=t.du.shift(),r=fu.from(s,e,n);await $h(t,(()=>t.remoteSyncer.applySuccessfulWrite(r))),await zh(t)}async function tl(t,e){e&&rl(t).Xo&&await async function(t,e){if(Do(n=e.code)&&n!==Rs.ABORTED){const n=t.du.shift();rl(t).Fo(),await $h(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await zh(t)}var n}(t,e),Hh(t)&&Yh(t)}async function el(t,e){const n=Ms(t);n.asyncQueue.verifyOperationInProgress(),_s("RemoteStore","RemoteStore received new credentials");const s=qh(n);n.wu.add(3),await Mh(n),s&&n.yu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.wu.delete(3),await kh(n)}async function nl(t,e){const n=Ms(t);e?(n.wu.delete(2),await kh(n)):e||(n.wu.add(2),await Mh(n),n.yu.set("Unknown"))}function sl(t){return t.Iu||(t.Iu=function(t,e,n){const s=Ms(t);return s.iu(),new Ah(e,s.So,s.authCredentials,s.appCheckCredentials,s.M,n)}(t.datastore,t.asyncQueue,{Xr:Bh.bind(null,t),eo:Kh.bind(null,t),zo:Gh.bind(null,t)}),t.mu.push((async e=>{e?(t.Iu.Fo(),Fh(t)?Oh(t):t.yu.set("Unknown")):(await t.Iu.stop(),Uh(t))}))),t.Iu}function rl(t){return t.Tu||(t.Tu=function(t,e,n){const s=Ms(t);return s.iu(),new Dh(e,s.So,s.authCredentials,s.appCheckCredentials,s.M,n)}(t.datastore,t.asyncQueue,{Xr:Xh.bind(null,t),eo:tl.bind(null,t),eu:Jh.bind(null,t),tu:Zh.bind(null,t)}),t.mu.push((async e=>{e?(t.Tu.Fo(),await zh(t)):(await t.Tu.stop(),t.du.length>0&&(_s("RemoteStore",`Stopping write stream with ${t.du.length} pending writes`),t.du=[]))}))),t.Tu}class il{constructor(t,e,n,s,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=s,this.removalCallback=r,this.deferred=new Vs,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,s,r){const i=Date.now()+n,o=new il(t,e,i,s,r);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Ls(Rs.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function ol(t,e){if(As("AsyncQueue",`${e}: ${t}`),iu(t))return new Ls(Rs.UNAVAILABLE,`${e}: ${t}`);throw t}class al{constructor(t){this.comparator=t?(e,n)=>t(e,n)||br.comparator(e.key,n.key):(t,e)=>br.comparator(t.key,e.key),this.keyedMap=Ro(),this.sortedSet=new ei(this.comparator)}static emptySet(t){return new al(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof al))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(!t.isEqual(s))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new al;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class ul{constructor(){this.Eu=new ei(br.comparator)}track(t){const e=t.doc.key,n=this.Eu.get(e);n?0!==t.type&&3===n.type?this.Eu=this.Eu.insert(e,t):3===t.type&&1!==n.type?this.Eu=this.Eu.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Eu=this.Eu.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Eu=this.Eu.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Eu=this.Eu.remove(e):1===t.type&&2===n.type?this.Eu=this.Eu.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Eu=this.Eu.insert(e,{type:2,doc:t.doc}):Ns():this.Eu=this.Eu.insert(e,t)}Au(){const t=[];return this.Eu.inorderTraversal(((e,n)=>{t.push(n)})),t}}class cl{constructor(t,e,n,s,r,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=s,this.mutatedKeys=r,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,s){const r=[];return e.forEach((t=>{r.push({type:0,doc:t})})),new cl(t,e,al.emptySet(e),r,n,s,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Fi(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class hl{constructor(){this.Ru=void 0,this.listeners=[]}}class ll{constructor(){this.queries=new No((t=>qi(t)),Fi),this.onlineState="Unknown",this.bu=new Set}}async function dl(t,e){const n=Ms(t),s=e.query;let r=!1,i=n.queries.get(s);if(i||(r=!0,i=new hl),r)try{i.Ru=await n.onListen(s)}catch(t){const n=ol(t,`Initialization of query '${Ui(e.query)}' failed`);return void e.onError(n)}n.queries.set(s,i),i.listeners.push(e),e.Pu(n.onlineState),i.Ru&&e.Vu(i.Ru)&&pl(n)}async function fl(t,e){const n=Ms(t),s=e.query;let r=!1;const i=n.queries.get(s);if(i){const t=i.listeners.indexOf(e);t>=0&&(i.listeners.splice(t,1),r=0===i.listeners.length)}if(r)return n.queries.delete(s),n.onUnlisten(s)}function ml(t,e){const n=Ms(t);let s=!1;for(const t of e){const e=t.query,r=n.queries.get(e);if(r){for(const e of r.listeners)e.Vu(t)&&(s=!0);r.Ru=t}}s&&pl(n)}function gl(t,e,n){const s=Ms(t),r=s.queries.get(e);if(r)for(const t of r.listeners)t.onError(n);s.queries.delete(e)}function pl(t){t.bu.forEach((t=>{t.next()}))}class yl{constructor(t,e,n){this.query=t,this.vu=e,this.Su=!1,this.Du=null,this.onlineState="Unknown",this.options=n||{}}Vu(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new cl(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.Su?this.Cu(t)&&(this.vu.next(t),e=!0):this.xu(t,this.onlineState)&&(this.Nu(t),e=!0),this.Du=t,e}onError(t){this.vu.error(t)}Pu(t){this.onlineState=t;let e=!1;return this.Du&&!this.Su&&this.xu(this.Du,t)&&(this.Nu(this.Du),e=!0),e}xu(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return!(this.options.ku&&n||t.docs.isEmpty()&&"Offline"!==e)}Cu(t){if(t.docChanges.length>0)return!0;const e=this.Du&&this.Du.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}Nu(t){t=cl.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.Su=!0,this.vu.next(t)}}class wl{constructor(t,e){this.payload=t,this.byteLength=e}Mu(){return"metadata"in this.payload}}class vl{constructor(t){this.M=t}wi(t){return ia(this.M,t)}mi(t){return t.metadata.exists?la(this.M,t.document,!1):$r.newNoDocument(this.wi(t.metadata.name),this.gi(t.metadata.readTime))}gi(t){return ea(t)}}class Il{constructor(t,e,n){this.Ou=t,this.localStore=e,this.M=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=bl(t)}Fu(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.payload.namedQuery)this.queries.push(t.payload.namedQuery);else if(t.payload.documentMetadata){this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e;const n=sr.fromString(t.payload.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}$u(t){const e=new Map,n=new vl(this.M);for(const s of t)if(s.metadata.queries){const t=n.wi(s.metadata.name);for(const n of s.metadata.queries){const s=(e.get(n)||Oo()).add(t);e.set(n,s)}}return e}async complete(){const t=await async function(t,e,n,s){const r=Ms(t);let i=Oo(),o=ko();for(const t of n){const n=e.wi(t.metadata.name);t.document&&(i=i.add(n));const s=e.mi(t);s.setReadTime(e.gi(t.metadata.readTime)),o=o.insert(n,s)}const a=r.hi.newChangeBuffer({trackRemovals:!0}),u=await Kc(r,function(t){return Pi(ki(sr.fromString(`__bundle__/docs/${t}`)))}(s));return r.persistence.runTransaction("Apply bundle documents","readwrite",(t=>Uc(t,a,o).next((e=>(a.apply(t),e))).next((e=>r.fs.removeMatchingKeysForTargetId(t,u.targetId).next((()=>r.fs.addMatchingKeys(t,i,u.targetId))).next((()=>r.fi.Gs(t,e))).next((()=>e))))))}(this.localStore,new vl(this.M),this.documents,this.Ou.id),e=this.$u(this.documents);for(const t of this.queries)await Wc(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",{progress:this.progress,Bu:this.collectionGroups,Lu:t}}}function bl(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class Tl{constructor(t){this.key=t}}class El{constructor(t){this.key=t}}class Sl{constructor(t,e){this.query=t,this.Uu=e,this.qu=null,this.current=!1,this.Ku=Oo(),this.mutatedKeys=Oo(),this.Gu=Gi(t),this.Qu=new al(this.Gu)}get ju(){return this.Uu}Wu(t,e){const n=e?e.zu:new ul,s=e?e.Qu:this.Qu;let r=e?e.mutatedKeys:this.mutatedKeys,i=s,o=!1;const a="F"===this.query.limitType&&s.size===this.query.limit?s.last():null,u="L"===this.query.limitType&&s.size===this.query.limit?s.first():null;if(t.inorderTraversal(((t,e)=>{const c=s.get(t),h=Bi(this.query,e)?e:null,l=!!c&&this.mutatedKeys.has(c.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;c&&h?c.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.Hu(c,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.Gu(h,a)>0||u&&this.Gu(h,u)<0)&&(o=!0)):!c&&h?(n.track({type:0,doc:h}),f=!0):c&&!h&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(h?(i=i.add(h),r=d?r.add(t):r.delete(t)):(i=i.delete(t),r=r.delete(t)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const t="F"===this.query.limitType?i.last():i.first();i=i.delete(t.key),r=r.delete(t.key),n.track({type:1,doc:t})}return{Qu:i,zu:n,ii:o,mutatedKeys:r}}Hu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const s=this.Qu;this.Qu=t.Qu,this.mutatedKeys=t.mutatedKeys;const r=t.zu.Au();r.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Ns()}};return n(t)-n(e)}(t.type,e.type)||this.Gu(t.doc,e.doc))),this.Ju(n);const i=e?this.Yu():[],o=0===this.Ku.size&&this.current?1:0,a=o!==this.qu;return this.qu=o,0!==r.length||a?{snapshot:new cl(this.query,t.Qu,s,r,t.mutatedKeys,0===o,a,!1),Xu:i}:{Xu:i}}Pu(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Qu:this.Qu,zu:new ul,mutatedKeys:this.mutatedKeys,ii:!1},!1)):{Xu:[]}}Zu(t){return!this.Uu.has(t)&&!!this.Qu.has(t)&&!this.Qu.get(t).hasLocalMutations}Ju(t){t&&(t.addedDocuments.forEach((t=>this.Uu=this.Uu.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.Uu=this.Uu.delete(t))),this.current=t.current)}Yu(){if(!this.current)return[];const t=this.Ku;this.Ku=Oo(),this.Qu.forEach((t=>{this.Zu(t.key)&&(this.Ku=this.Ku.add(t.key))}));const e=[];return t.forEach((t=>{this.Ku.has(t)||e.push(new El(t))})),this.Ku.forEach((n=>{t.has(n)||e.push(new Tl(n))})),e}ta(t){this.Uu=t._i,this.Ku=Oo();const e=this.Wu(t.documents);return this.applyChanges(e,!0)}ea(){return cl.fromInitialDocuments(this.query,this.Qu,this.mutatedKeys,0===this.qu)}}class _l{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class Al{constructor(t){this.key=t,this.na=!1}}class Dl{constructor(t,e,n,s,r,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=s,this.currentUser=r,this.maxConcurrentLimboResolutions=i,this.sa={},this.ia=new No((t=>qi(t)),Fi),this.ra=new Map,this.oa=new Set,this.ua=new ei(br.comparator),this.aa=new Map,this.ca=new Xc,this.ha={},this.la=new Map,this.fa=oc.yn(),this.onlineState="Unknown",this.da=void 0}get isPrimaryClient(){return!0===this.da}}async function xl(t,e){const n=td(t);let s,r;const i=n.ia.get(e);if(i)s=i.targetId,n.sharedClientState.addLocalQueryTarget(s),r=i.view.ea();else{const t=await Kc(n.localStore,Pi(e));n.isPrimaryClient&&Rh(n.remoteStore,t);const i=n.sharedClientState.addLocalQueryTarget(t.targetId);s=t.targetId,r=await Nl(n,e,s,"current"===i)}return r}async function Nl(t,e,n,s){t._a=(e,n,s)=>async function(t,e,n,s){let r=e.view.Wu(n);r.ii&&(r=await jc(t.localStore,e.query,!1).then((({documents:t})=>e.view.Wu(t,r))));const i=s&&s.targetChanges.get(e.targetId),o=e.view.applyChanges(r,t.isPrimaryClient,i);return Ul(t,e.targetId,o.Xu),o.snapshot}(t,e,n,s);const r=await jc(t.localStore,e,!0),i=new Sl(e,r._i),o=i.Wu(r.documents),a=Bo.createSynthesizedTargetChangeForCurrentChange(n,s&&"Offline"!==t.onlineState),u=i.applyChanges(o,t.isPrimaryClient,a);Ul(t,n,u.Xu);const c=new _l(e,n,i);return t.ia.set(e,c),t.ra.has(n)?t.ra.get(n).push(e):t.ra.set(n,[e]),u.snapshot}async function Cl(t,e){const n=Ms(t),s=n.ia.get(e),r=n.ra.get(s.targetId);if(r.length>1)return n.ra.set(s.targetId,r.filter((t=>!Fi(t,e)))),void n.ia.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(s.targetId),n.sharedClientState.isActiveQueryTarget(s.targetId)||await Gc(n.localStore,s.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(s.targetId),Lh(n.remoteStore,s.targetId),Fl(n,s.targetId)})).catch(lc)):(Fl(n,s.targetId),await Gc(n.localStore,s.targetId,!0))}async function kl(t,e){const n=Ms(t);try{const t=await function(t,e){const n=Ms(t),s=e.snapshotVersion;let r=n.ui;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.hi.newChangeBuffer({trackRemovals:!0});r=n.ui;const o=[];e.targetChanges.forEach(((i,a)=>{const u=r.get(a);if(!u)return;o.push(n.fs.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.fs.addMatchingKeys(t,i.addedDocuments,a))));let c=u.withSequenceNumber(t.currentSequenceNumber);e.targetMismatches.has(a)?c=c.withResumeToken(ur.EMPTY_BYTE_STRING,Js.min()).withLastLimboFreeSnapshotVersion(Js.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,s)),r=r.insert(a,c),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.fs.updateTargetData(t,c))}));let a=ko();if(e.documentUpdates.forEach((s=>{e.resolvedLimboDocuments.has(s)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,s))})),o.push(Uc(t,i,e.documentUpdates).next((t=>{a=t}))),!s.isEqual(Js.min())){const e=n.fs.getLastRemoteSnapshotVersion(t).next((e=>n.fs.setTargetsMetadata(t,t.currentSequenceNumber,s)));o.push(e)}return tu.waitFor(o).next((()=>i.apply(t))).next((()=>n.fi.Gs(t,a))).next((()=>a))})).then((t=>(n.ui=r,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const s=n.aa.get(e);s&&(Cs(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?s.na=!0:t.modifiedDocuments.size>0?Cs(s.na):t.removedDocuments.size>0&&(Cs(s.na),s.na=!1))})),await Gl(n,t,e)}catch(t){await lc(t)}}function Ml(t,e,n){const s=Ms(t);if(s.isPrimaryClient&&0===n||!s.isPrimaryClient&&1===n){const t=[];s.ia.forEach(((n,s)=>{const r=s.view.Pu(e);r.snapshot&&t.push(r.snapshot)})),function(t,e){const n=Ms(t);n.onlineState=e;let s=!1;n.queries.forEach(((t,n)=>{for(const t of n.listeners)t.Pu(e)&&(s=!0)})),s&&pl(n)}(s.eventManager,e),t.length&&s.sa.zo(t),s.onlineState=e,s.isPrimaryClient&&s.sharedClientState.setOnlineState(e)}}async function Rl(t,e,n){const s=Ms(t);s.sharedClientState.updateQueryState(e,"rejected",n);const r=s.aa.get(e),i=r&&r.key;if(i){let t=new ei(br.comparator);t=t.insert(i,$r.newNoDocument(i,Js.min()));const n=Oo().add(i),r=new Uo(Js.min(),new Map,new ri(Ws),t,n);await kl(s,r),s.ua=s.ua.remove(i),s.aa.delete(e),Kl(s)}else await Gc(s.localStore,e,!1).then((()=>Fl(s,e,n))).catch(lc)}async function Ll(t,e){const n=Ms(t),s=e.batch.batchId;try{const t=await function(t,e){const n=Ms(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const s=e.batch.keys(),r=n.hi.newChangeBuffer({trackRemovals:!0});return function(t,e,n,s){const r=n.batch,i=r.keys();let o=tu.resolve();return i.forEach((t=>{o=o.next((()=>s.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);Cs(null!==i),e.version.compareTo(i)<0&&(r.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),s.addEntry(e)))}))})),o.next((()=>t.Bs.removeMutationBatch(e,r)))}(n,t,e,r).next((()=>r.apply(t))).next((()=>n.Bs.performConsistencyCheck(t))).next((()=>n.fi.Ks(t,s)))}))}(n.localStore,e);Ol(n,s,null),Pl(n,s),n.sharedClientState.updateMutationState(s,"acknowledged"),await Gl(n,t)}catch(t){await lc(t)}}async function Vl(t,e,n){const s=Ms(t);try{const t=await function(t,e){const n=Ms(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let s;return n.Bs.lookupMutationBatch(t,e).next((e=>(Cs(null!==e),s=e.keys(),n.Bs.removeMutationBatch(t,e)))).next((()=>n.Bs.performConsistencyCheck(t))).next((()=>n.fi.Ks(t,s)))}))}(s.localStore,e);Ol(s,e,n),Pl(s,e),s.sharedClientState.updateMutationState(e,"rejected",n),await Gl(s,t)}catch(n){await lc(n)}}function Pl(t,e){(t.la.get(e)||[]).forEach((t=>{t.resolve()})),t.la.delete(e)}function Ol(t,e,n){const s=Ms(t);let r=s.ha[s.currentUser.toKey()];if(r){const t=r.get(e);t&&(n?t.reject(n):t.resolve(),r=r.remove(e)),s.ha[s.currentUser.toKey()]=r}}function Fl(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const s of t.ra.get(e))t.ia.delete(s),n&&t.sa.wa(s,n);t.ra.delete(e),t.isPrimaryClient&&t.ca.vi(e).forEach((e=>{t.ca.containsKey(e)||ql(t,e)}))}function ql(t,e){t.oa.delete(e.path.canonicalString());const n=t.ua.get(e);null!==n&&(Lh(t.remoteStore,n),t.ua=t.ua.remove(e),t.aa.delete(n),Kl(t))}function Ul(t,e,n){for(const s of n)s instanceof Tl?(t.ca.addReference(s.key,e),Bl(t,s)):s instanceof El?(_s("SyncEngine","Document no longer in limbo: "+s.key),t.ca.removeReference(s.key,e),t.ca.containsKey(s.key)||ql(t,s.key)):Ns()}function Bl(t,e){const n=e.key,s=n.path.canonicalString();t.ua.get(n)||t.oa.has(s)||(_s("SyncEngine","New document in limbo: "+n),t.oa.add(s),Kl(t))}function Kl(t){for(;t.oa.size>0&&t.ua.size<t.maxConcurrentLimboResolutions;){const e=t.oa.values().next().value;t.oa.delete(e);const n=new br(sr.fromString(e)),s=t.fa.next();t.aa.set(s,new Al(n)),t.ua=t.ua.insert(n,s),Rh(t.remoteStore,new gu(Pi(ki(n.path)),s,2,$s.A))}}async function Gl(t,e,n){const s=Ms(t),r=[],i=[],o=[];s.ia.isEmpty()||(s.ia.forEach(((t,a)=>{o.push(s._a(a,e,n).then((t=>{if(t){s.isPrimaryClient&&s.sharedClientState.updateQueryState(a.targetId,t.fromCache?"not-current":"current"),r.push(t);const e=Lc.Ys(a.targetId,t);i.push(e)}})))})),await Promise.all(o),s.sa.zo(r),await async function(t,e){const n=Ms(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>tu.forEach(e,(e=>tu.forEach(e.Hs,(s=>n.persistence.referenceDelegate.addReference(t,e.targetId,s))).next((()=>tu.forEach(e.Js,(s=>n.persistence.referenceDelegate.removeReference(t,e.targetId,s)))))))))}catch(t){if(!iu(t))throw t;_s("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.ui.get(e),s=t.snapshotVersion,r=t.withLastLimboFreeSnapshotVersion(s);n.ui=n.ui.insert(e,r)}}}(s.localStore,i))}async function jl(t,e){const n=Ms(t);if(!n.currentUser.isEqual(e)){_s("SyncEngine","User change. New user:",e.toKey());const t=await Fc(n.localStore,e);n.currentUser=e,function(t,e){t.la.forEach((t=>{t.forEach((t=>{t.reject(new Ls(Rs.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.la.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await Gl(n,t.di)}}function $l(t,e){const n=Ms(t),s=n.aa.get(e);if(s&&s.na)return Oo().add(s.key);{let t=Oo();const s=n.ra.get(e);if(!s)return t;for(const e of s){const s=n.ia.get(e);t=t.unionWith(s.view.ju)}return t}}async function zl(t,e){const n=Ms(t),s=await jc(n.localStore,e.query,!0),r=e.view.ta(s);return n.isPrimaryClient&&Ul(n,e.targetId,r.Xu),r}async function Ql(t,e){const n=Ms(t);return zc(n.localStore,e).then((t=>Gl(n,t)))}async function Wl(t,e,n,s){const r=Ms(t),i=await function(t,e){const n=Ms(t),s=Ms(n.Bs);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>s.fn(t,e).next((e=>e?n.fi.Ks(t,e):tu.resolve(null)))))}(r.localStore,e);null!==i?("pending"===n?await zh(r.remoteStore):"acknowledged"===n||"rejected"===n?(Ol(r,e,s||null),Pl(r,e),function(t,e){Ms(Ms(t).Bs)._n(e)}(r.localStore,e)):Ns(),await Gl(r,i)):_s("SyncEngine","Cannot apply mutation batch with id: "+e)}async function Hl(t,e,n){const s=Ms(t),r=[],i=[];for(const t of e){let e;const n=s.ra.get(t);if(n&&0!==n.length){e=await Kc(s.localStore,Pi(n[0]));for(const t of n){const e=s.ia.get(t),n=await zl(s,e);n.snapshot&&i.push(n.snapshot)}}else{const n=await $c(s.localStore,t);e=await Kc(s.localStore,n),await Nl(s,Yl(n),t,!1)}r.push(e)}return s.sa.zo(i),r}function Yl(t){return Ci(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function Xl(t){const e=Ms(t);return Ms(Ms(e.localStore).persistence).Fs()}async function Jl(t,e,n,s){const r=Ms(t);if(r.da)return void _s("SyncEngine","Ignoring unexpected query state notification.");const i=r.ra.get(e);if(i&&i.length>0)switch(n){case"current":case"not-current":{const t=await zc(r.localStore,Ki(i[0])),s=Uo.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await Gl(r,t,s);break}case"rejected":await Gc(r.localStore,e,!0),Fl(r,e,s);break;default:Ns()}}async function Zl(t,e,n){const s=td(t);if(s.da){for(const t of e){if(s.ra.has(t)){_s("SyncEngine","Adding an already active target "+t);continue}const e=await $c(s.localStore,t),n=await Kc(s.localStore,e);await Nl(s,Yl(e),n.targetId,!1),Rh(s.remoteStore,n)}for(const t of n)s.ra.has(t)&&await Gc(s.localStore,t,!1).then((()=>{Lh(s.remoteStore,t),Fl(s,t)})).catch(lc)}}function td(t){const e=Ms(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=kl.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=$l.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Rl.bind(null,e),e.sa.zo=ml.bind(null,e.eventManager),e.sa.wa=gl.bind(null,e.eventManager),e}function ed(t){const e=Ms(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Ll.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Vl.bind(null,e),e}class nd{constructor(){this.synchronizeTabs=!1}async initialize(t){this.M=Eh(t.databaseInfo.databaseId),this.sharedClientState=this.ga(t),this.persistence=this.ya(t),await this.persistence.start(),this.gcScheduler=this.pa(t),this.localStore=this.Ia(t)}pa(t){return null}Ia(t){return Oc(this.persistence,new Vc,t.initialUser,this.M)}ya(t){return new sh(ih.Yi,this.M)}ga(t){return new gh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class sd extends nd{constructor(t,e,n){super(),this.Ta=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.Ta.initialize(this,t),await ed(this.Ta.syncEngine),await zh(this.Ta.remoteStore),await this.persistence.Ts((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve())))}Ia(t){return Oc(this.persistence,new Vc,t.initialUser,this.M)}pa(t){const e=this.persistence.referenceDelegate.garbageCollector;return new mc(e,t.asyncQueue)}ya(t){const e=Mc(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Ju.withCacheSize(this.cacheSizeBytes):Ju.DEFAULT;return new Nc(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,bh(),Th(),this.M,this.sharedClientState,!!this.forceOwnership)}ga(t){return new gh}}class rd extends sd{constructor(t,e){super(t,e,!1),this.Ta=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.Ta.syncEngine;this.sharedClientState instanceof mh&&(this.sharedClientState.syncEngine={$r:Wl.bind(null,e),Br:Jl.bind(null,e),Lr:Zl.bind(null,e),Fs:Xl.bind(null,e),Fr:Ql.bind(null,e)},await this.sharedClientState.start()),await this.persistence.Ts((async t=>{await async function(t,e){const n=Ms(t);if(td(n),ed(n),!0===e&&!0!==n.da){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await Hl(n,t.toArray());n.da=!0,await nl(n.remoteStore,!0);for(const t of e)Rh(n.remoteStore,t)}else if(!1===e&&!1!==n.da){const t=[];let e=Promise.resolve();n.ra.forEach(((s,r)=>{n.sharedClientState.isLocalQueryTarget(r)?t.push(r):e=e.then((()=>(Fl(n,r),Gc(n.localStore,r,!0)))),Lh(n.remoteStore,r)})),await e,await Hl(n,t),function(t){const e=Ms(t);e.aa.forEach(((t,n)=>{Lh(e.remoteStore,n)})),e.ca.Si(),e.aa=new Map,e.ua=new ei(br.comparator)}(n),n.da=!1,await nl(n.remoteStore,!1)}}(this.Ta.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop())}))}ga(t){const e=bh();if(!mh.vt(e))throw new Ls(Rs.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Mc(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new mh(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class id{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Ml(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=jl.bind(null,this.syncEngine),await nl(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new ll}createDatastore(t){const e=Eh(t.databaseInfo.databaseId),n=(s=t.databaseInfo,new Ih(s));var s;return function(t,e,n,s){return new xh(t,e,n,s)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,s=t.asyncQueue,r=t=>Ml(this.syncEngine,t,0),i=yh.vt()?new yh:new ph,new Ch(e,n,s,r,i);var e,n,s,r,i}createSyncEngine(t,e){return function(t,e,n,s,r,i,o){const a=new Dl(t,e,n,s,r,i);return o&&(a.da=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=Ms(t);_s("RemoteStore","RemoteStore shutting down."),e.wu.add(5),await Mh(e),e.gu.shutdown(),e.yu.set("Unknown")}(this.remoteStore)}}function od(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const s={value:t.slice(n,n+e),done:!1};return n+=e,s}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class ad{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Ea(this.observer.next,t)}error(t){this.observer.error?this.Ea(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)}Aa(){this.muted=!0}Ea(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class ud{constructor(t,e){this.Ra=t,this.M=e,this.metadata=new Vs,this.buffer=new Uint8Array,this.ba=new TextDecoder("utf-8"),this.Pa().then((t=>{t&&t.Mu()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))}),(t=>this.metadata.reject(t)))}close(){return this.Ra.cancel()}async getMetadata(){return this.metadata.promise}async ma(){return await this.getMetadata(),this.Pa()}async Pa(){const t=await this.Va();if(null===t)return null;const e=this.ba.decode(t),n=Number(e);isNaN(n)&&this.va(`length string (${e}) is not valid number`);const s=await this.Sa(n);return new wl(JSON.parse(s),t.length+n)}Da(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async Va(){for(;this.Da()<0&&!await this.Ca(););if(0===this.buffer.length)return null;const t=this.Da();t<0&&this.va("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async Sa(t){for(;this.buffer.length<t;)await this.Ca()&&this.va("Reached the end of bundle when more is expected.");const e=this.ba.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}va(t){throw this.Ra.cancel(),new Error(`Invalid bundle format: ${t}`)}async Ca(){const t=await this.Ra.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class cd{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new Ls(Rs.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=Ms(t),s=ua(n.M)+"/documents",r={documents:e.map((t=>ra(n.M,t)))},i=await n._o("BatchGetDocuments",s,r),o=new Map;i.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){Cs(!!e.found),e.found.name,e.found.updateTime;const n=ia(t,e.found.name),s=ea(e.found.updateTime),r=new Gr({mapValue:{fields:e.found.fields}});return $r.newFoundDocument(n,s,r)}(t,e):"missing"in e?function(t,e){Cs(!!e.missing),Cs(!!e.readTime);const n=ia(t,e.missing),s=ea(e.readTime);return $r.newNoDocument(n,s)}(t,e):Ns()}(n.M,t);o.set(e.key.toString(),e)}));const a=[];return e.forEach((t=>{const e=o.get(t.toString());Cs(!!e),a.push(e)})),a}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new To(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=br.fromPath(e);this.mutations.push(new Eo(n,this.precondition(n)))})),await async function(t,e){const n=Ms(t),s=ua(n.M)+"/documents",r={writes:e.map((t=>da(n.M,t)))};await n.co("Commit",s,r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw Ns();e=Js.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new Ls(Rs.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?uo.updateTime(e):uo.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(Js.min()))throw new Ls(Rs.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return uo.updateTime(e)}return uo.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class hd{constructor(t,e,n,s,r){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=s,this.deferred=r,this.xa=n.maxAttempts,this.No=new Sh(this.asyncQueue,"transaction_retry")}run(){this.xa-=1,this.Na()}Na(){this.No.Ro((async()=>{const t=new cd(this.datastore),e=this.ka(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.Ma(t)}))))})).catch((t=>{this.Ma(t)}))}))}ka(t){try{const e=this.updateFunction(t);return!wr(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}Ma(t){this.xa>0&&this.Oa(t)?(this.xa-=1,this.asyncQueue.enqueueAndForget((()=>(this.Na(),Promise.resolve())))):this.deferred.reject(t)}Oa(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||!Do(e)}return!1}}class ld{constructor(t,e,n,s){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=s,this.user=Is.UNAUTHENTICATED,this.clientId=Qs.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{_s("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(_s("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Ls(Rs.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new Vs;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=ol(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function dd(t,e){t.asyncQueue.verifyOperationInProgress(),_s("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let s=n.initialUser;t.setCredentialChangeListener((async t=>{s.isEqual(t)||(await Fc(e.localStore,t),s=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t.offlineComponents=e}async function fd(t,e){t.asyncQueue.verifyOperationInProgress();const n=await md(t);_s("FirestoreClient","Initializing OnlineComponentProvider");const s=await t.getConfiguration();await e.initialize(n,s),t.setCredentialChangeListener((t=>el(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>el(e.remoteStore,n))),t.onlineComponents=e}async function md(t){return t.offlineComponents||(_s("FirestoreClient","Using default OfflineComponentProvider"),await dd(t,new nd)),t.offlineComponents}async function gd(t){return t.onlineComponents||(_s("FirestoreClient","Using default OnlineComponentProvider"),await fd(t,new id)),t.onlineComponents}function pd(t){return md(t).then((t=>t.persistence))}function yd(t){return md(t).then((t=>t.localStore))}function wd(t){return gd(t).then((t=>t.remoteStore))}function vd(t){return gd(t).then((t=>t.syncEngine))}async function Id(t){const e=await gd(t),n=e.eventManager;return n.onListen=xl.bind(null,e.syncEngine),n.onUnlisten=Cl.bind(null,e.syncEngine),n}function bd(t,e,n={}){const s=new Vs;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new ad({next:i=>{e.enqueueAndForget((()=>fl(t,o)));const a=i.docs.has(n);!a&&i.fromCache?r.reject(new Ls(Rs.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&s&&"server"===s.source?r.reject(new Ls(Rs.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):r.resolve(i)},error:t=>r.reject(t)}),o=new yl(ki(n.path),i,{includeMetadataChanges:!0,ku:!0});return dl(t,o)}(await Id(t),t.asyncQueue,e,n,s))),s.promise}function Td(t,e,n={}){const s=new Vs;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new ad({next:n=>{e.enqueueAndForget((()=>fl(t,o))),n.fromCache&&"server"===s.source?r.reject(new Ls(Rs.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(n)},error:t=>r.reject(t)}),o=new yl(n,i,{includeMetadataChanges:!0,ku:!0});return dl(t,o)}(await Id(t),t.asyncQueue,e,n,s))),s.promise}const Ed=new Map;function Sd(t,e,n){if(!n)throw new Ls(Rs.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function _d(t,e,n,s){if(!0===e&&!0===s)throw new Ls(Rs.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Ad(t){if(!br.isDocumentKey(t))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Dd(t){if(br.isDocumentKey(t))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function xd(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":Ns()}function Nd(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new Ls(Rs.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=xd(t);throw new Ls(Rs.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function Cd(t,e){if(e<=0)throw new Ls(Rs.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class kd{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new Ls(Rs.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Ls(Rs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,_d("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Md{constructor(t,e,n){this._authCredentials=e,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new kd({}),this._settingsFrozen=!1,t instanceof yr?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new Ls(Rs.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new yr(t.options.projectId)}(t))}get app(){if(!this._app)throw new Ls(Rs.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new Ls(Rs.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new kd(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new Os;switch(t.type){case"gapi":const e=t.client;return Cs(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new Bs(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new Ls(Rs.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Ed.get(t);e&&(_s("ComponentProvider","Removing Datastore"),Ed.delete(t),e.terminate())}(this),Promise.resolve()}}function Rd(t,e,n,s={}){var r;const i=(t=Nd(t,Md))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&Ds("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${n}`,ssl:!1})),s.mockUserToken){let e,n;if("string"==typeof s.mockUserToken)e=s.mockUserToken,n=Is.MOCK_USER;else{e=(0,a.Sg)(s.mockUserToken,null===(r=t._app)||void 0===r?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new Ls(Rs.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new Is(i)}t._authCredentials=new Fs(new Ps(e,n))}}class Ld{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Pd(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Ld(this.firestore,t,this._key)}}class Vd{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Vd(this.firestore,t,this._query)}}class Pd extends Vd{constructor(t,e,n){super(t,e,ki(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Ld(this.firestore,null,new br(t))}withConverter(t){return new Pd(this.firestore,t,this._path)}}function Od(t,e,...n){if(t=(0,a.m9)(t),Sd("collection","path",e),t instanceof Md){const s=sr.fromString(e,...n);return Dd(s),new Pd(t,null,s)}{if(!(t instanceof Ld||t instanceof Pd))throw new Ls(Rs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(sr.fromString(e,...n));return Dd(s),new Pd(t.firestore,null,s)}}function Fd(t,e){if(t=Nd(t,Md),Sd("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Vd(t,null,function(t){return new Ni(sr.emptyPath(),t)}(e))}function qd(t,e,...n){if(t=(0,a.m9)(t),1===arguments.length&&(e=Qs.R()),Sd("doc","path",e),t instanceof Md){const s=sr.fromString(e,...n);return Ad(s),new Ld(t,null,new br(s))}{if(!(t instanceof Ld||t instanceof Pd))throw new Ls(Rs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(sr.fromString(e,...n));return Ad(s),new Ld(t.firestore,t instanceof Pd?t.converter:null,new br(s))}}function Ud(t,e){return t=(0,a.m9)(t),e=(0,a.m9)(e),(t instanceof Ld||t instanceof Pd)&&(e instanceof Ld||e instanceof Pd)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Bd(t,e){return t=(0,a.m9)(t),e=(0,a.m9)(e),t instanceof Vd&&e instanceof Vd&&t.firestore===e.firestore&&Fi(t._query,e._query)&&t.converter===e.converter}class Kd{constructor(){this.Fa=Promise.resolve(),this.$a=[],this.Ba=!1,this.La=[],this.Ua=null,this.qa=!1,this.Ka=!1,this.Ga=[],this.No=new Sh(this,"async_queue_retry"),this.Qa=()=>{const t=Th();t&&_s("AsyncQueue","Visibility state changed to "+t.visibilityState),this.No.Po()};const t=Th();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Qa)}get isShuttingDown(){return this.Ba}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.ja(),this.Wa(t)}enterRestrictedMode(t){if(!this.Ba){this.Ba=!0,this.Ka=t||!1;const e=Th();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Qa)}}enqueue(t){if(this.ja(),this.Ba)return new Promise((()=>{}));const e=new Vs;return this.Wa((()=>this.Ba&&this.Ka?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.$a.push(t),this.za())))}async za(){if(0!==this.$a.length){try{await this.$a[0](),this.$a.shift(),this.No.reset()}catch(t){if(!iu(t))throw t;_s("AsyncQueue","Operation failed with retryable error: "+t)}this.$a.length>0&&this.No.Ro((()=>this.za()))}}Wa(t){const e=this.Fa.then((()=>(this.qa=!0,t().catch((t=>{this.Ua=t,this.qa=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw As("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.qa=!1,t))))));return this.Fa=e,e}enqueueAfterDelay(t,e,n){this.ja(),this.Ga.indexOf(t)>-1&&(e=0);const s=il.createAndSchedule(this,t,e,n,(t=>this.Ha(t)));return this.La.push(s),s}ja(){this.Ua&&Ns()}verifyOperationInProgress(){}async Ja(){let t;do{t=this.Fa,await t}while(t!==this.Fa)}Ya(t){for(const e of this.La)if(e.timerId===t)return!0;return!1}Xa(t){return this.Ja().then((()=>{this.La.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.La)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Ja()}))}Za(t){this.Ga.push(t)}Ha(t){const e=this.La.indexOf(t);this.La.splice(e,1)}}function Gd(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return!0;return!1}(t)}class jd{constructor(){this._progressObserver={},this._taskCompletionResolver=new Vs,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const $d=-1;class zd extends Md{constructor(t,e,n){super(t,e,n),this.type="firestore",this._queue=new Kd,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||Yd(this),this._firestoreClient.terminate()}}function Qd(t,e){const n=(0,r._getProvider)(t,"firestore");if(n.isInitialized()){const t=n.getImmediate(),s=n.getOptions();if((0,a.vZ)(s,e))return t;throw new Ls(Rs.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Ls(Rs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return n.initialize({options:e})}function Wd(t=(0,r.getApp)()){return(0,r._getProvider)(t,"firestore").getImmediate()}function Hd(t){return t._firestoreClient||Yd(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function Yd(t){var e;const n=t._freezeSettings(),s=function(t,e,n,s){return new pr(t,e,n,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,s.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new ld(t._authCredentials,t._appCheckCredentials,t._queue,s)}function Xd(t,e){uf(t=Nd(t,zd));const n=Hd(t),s=t._freezeSettings(),r=new id;return Zd(n,r,new sd(r,s.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function Jd(t){uf(t=Nd(t,zd));const e=Hd(t),n=t._freezeSettings(),s=new id;return Zd(e,s,new rd(s,n.cacheSizeBytes))}function Zd(t,e,n){const s=new Vs;return t.asyncQueue.enqueue((async()=>{try{await dd(t,n),await fd(t,e),s.resolve()}catch(t){if(!function(t){return"FirebaseError"===t.name?t.code===Rs.FAILED_PRECONDITION||t.code===Rs.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}(t))throw t;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),s.reject(t)}})).then((()=>s.promise))}function tf(t){if(t._initialized&&!t._terminated)throw new Ls(Rs.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Vs;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!nu.vt())return Promise.resolve();const e=t+"main";await nu.delete(e)}(Mc(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function ef(t){return function(t){const e=new Vs;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=Ms(t);qh(n.remoteStore)||_s("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=Ms(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.Bs.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const s=n.la.get(t)||[];s.push(e),n.la.set(t,s)}catch(t){const n=ol(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await vd(t),e))),e.promise}(Hd(t=Nd(t,zd)))}function nf(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await pd(t),n=await wd(t);return e.setNetworkEnabled(!0),function(t){const e=Ms(t);return e.wu.delete(0),kh(e)}(n)}))}(Hd(t=Nd(t,zd)))}function sf(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await pd(t),n=await wd(t);return e.setNetworkEnabled(!1),async function(t){const e=Ms(t);e.wu.add(0),await Mh(e),e.yu.set("Offline")}(n)}))}(Hd(t=Nd(t,zd)))}function rf(t){return(0,r._removeServiceInstance)(t.app,"firestore"),t._delete()}function of(t,e){const n=Hd(t=Nd(t,zd)),s=new jd;return function(t,e,n,s){const r=function(t,e){let n;return n="string"==typeof t?(new TextEncoder).encode(t):t,function(t,e){return new ud(t,e)}(function(t,e){if(t instanceof Uint8Array)return od(t,e);if(t instanceof ArrayBuffer)return od(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,Eh(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const s=Ms(t);(async function(t,e,n){try{const s=await e.getMetadata();if(await function(t,e){const n=Ms(t),s=ea(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n._s.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(s)>=0))}(t.localStore,s))return await e.close(),n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(s)),Promise.resolve(new Set);n._updateProgress(bl(s));const r=new Il(s,t.localStore,e.M);let i=await e.ma();for(;i;){const t=await r.Fu(i);t&&n._updateProgress(t),i=await e.ma()}const o=await r.complete();return await Gl(t,o.Lu,void 0),await function(t,e){const n=Ms(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n._s.saveBundleMetadata(t,e)))}(t.localStore,s),n._completeWith(o.progress),Promise.resolve(o.Bu)}catch(t){return Ds("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t),Promise.resolve(new Set)}})(s,e,n).then((t=>{s.sharedClientState.notifyBundleLoaded(t)}))}(await vd(t),r,s)}))}(n,t._databaseId,e,s),s}function af(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=Ms(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n._s.getNamedQuery(t,e)))}(await yd(t),e)))}(Hd(t=Nd(t,zd)),e).then((e=>e?new Vd(t,null,e.query):null))}function uf(t){if(t._initialized||t._terminated)throw new Ls(Rs.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class cf{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new Ls(Rs.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ir(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function hf(){return new cf("__name__")}class lf{constructor(t){this._byteString=t}static fromBase64String(t){try{return new lf(ur.fromBase64String(t))}catch(t){throw new Ls(Rs.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new lf(ur.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class df{constructor(t){this._methodName=t}}class ff{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new Ls(Rs.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new Ls(Rs.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return Ws(this._lat,t._lat)||Ws(this._long,t._long)}}const mf=/^__.*__$/;class gf{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new wo(t,this.data,this.fieldMask,e,this.fieldTransforms):new yo(t,this.data,e,this.fieldTransforms)}}class pf{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new wo(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function yf(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Ns()}}class wf{constructor(t,e,n,s,r,i){this.settings=t,this.databaseId=e,this.M=n,this.ignoreUndefinedProperties=s,void 0===r&&this.tc(),this.fieldTransforms=r||[],this.fieldMask=i||[]}get path(){return this.settings.path}get ec(){return this.settings.ec}nc(t){return new wf(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.M,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}sc(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.nc({path:n,ic:!1});return s.rc(t),s}oc(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.nc({path:n,ic:!1});return s.tc(),s}uc(t){return this.nc({path:void 0,ic:!0})}ac(t){return Ff(t,this.settings.methodName,this.settings.cc||!1,this.path,this.settings.hc)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}tc(){if(this.path)for(let t=0;t<this.path.length;t++)this.rc(this.path.get(t))}rc(t){if(0===t.length)throw this.ac("Document fields must not be empty");if(yf(this.ec)&&mf.test(t))throw this.ac('Document fields cannot begin and end with "__"')}}class vf{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.M=n||Eh(t)}lc(t,e,n,s=!1){return new wf({ec:t,methodName:e,hc:n,path:ir.emptyPath(),ic:!1,cc:s},this.databaseId,this.M,this.ignoreUndefinedProperties)}}function If(t){const e=t._freezeSettings(),n=Eh(t._databaseId);return new vf(t._databaseId,!!e.ignoreUndefinedProperties,n)}function bf(t,e,n,s,r,i={}){const o=t.lc(i.merge||i.mergeFields?2:0,e,n,r);Lf("Data must be an object, but it was:",o,s);const a=Mf(s,o);let u,c;if(i.merge)u=new or(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const s of i.mergeFields){const r=Vf(e,s,n);if(!o.contains(r))throw new Ls(Rs.INVALID_ARGUMENT,`Field '${r}' is specified in your field mask but missing from your input data.`);qf(t,r)||t.push(r)}u=new or(t),c=o.fieldTransforms.filter((t=>u.covers(t.field)))}else u=null,c=o.fieldTransforms;return new gf(new Gr(a),u,c)}class Tf extends df{_toFieldTransform(t){if(2!==t.ec)throw 1===t.ec?t.ac(`${this._methodName}() can only appear at the top level of your update data`):t.ac(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Tf}}function Ef(t,e,n){return new wf({ec:3,hc:e.settings.hc,methodName:t._methodName,ic:n},e.databaseId,e.M,e.ignoreUndefinedProperties)}class Sf extends df{_toFieldTransform(t){return new oo(t.path,new Ji)}isEqual(t){return t instanceof Sf}}class _f extends df{constructor(t,e){super(t),this.fc=e}_toFieldTransform(t){const e=Ef(this,t,!0),n=this.fc.map((t=>kf(t,e))),s=new Zi(n);return new oo(t.path,s)}isEqual(t){return this===t}}class Af extends df{constructor(t,e){super(t),this.fc=e}_toFieldTransform(t){const e=Ef(this,t,!0),n=this.fc.map((t=>kf(t,e))),s=new eo(n);return new oo(t.path,s)}isEqual(t){return this===t}}class Df extends df{constructor(t,e){super(t),this.dc=e}_toFieldTransform(t){const e=new so(t.M,Qi(t.M,this.dc));return new oo(t.path,e)}isEqual(t){return this===t}}function xf(t,e,n,s){const r=t.lc(1,e,n);Lf("Data must be an object, but it was:",r,s);const i=[],o=Gr.empty();tr(s,((t,s)=>{const u=Of(e,t,n);s=(0,a.m9)(s);const c=r.oc(u);if(s instanceof Tf)i.push(u);else{const t=kf(s,c);null!=t&&(i.push(u),o.set(u,t))}}));const u=new or(i);return new pf(o,u,r.fieldTransforms)}function Nf(t,e,n,s,r,i){const o=t.lc(1,e,n),u=[Vf(e,s,n)],c=[r];if(i.length%2!=0)throw new Ls(Rs.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)u.push(Vf(e,i[t])),c.push(i[t+1]);const h=[],l=Gr.empty();for(let t=u.length-1;t>=0;--t)if(!qf(h,u[t])){const e=u[t];let n=c[t];n=(0,a.m9)(n);const s=o.oc(e);if(n instanceof Tf)h.push(e);else{const t=kf(n,s);null!=t&&(h.push(e),l.set(e,t))}}const d=new or(h);return new pf(l,d,o.fieldTransforms)}function Cf(t,e,n,s=!1){return kf(n,t.lc(s?4:3,e))}function kf(t,e){if(Rf(t=(0,a.m9)(t)))return Lf("Unsupported field value:",e,t),Mf(t,e);if(t instanceof df)return function(t,e){if(!yf(e.ec))throw e.ac(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.ac(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.ic&&4!==e.ec)throw e.ac("Nested arrays are not supported");return function(t,e){const n=[];let s=0;for(const r of t){let t=kf(r,e.uc(s));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),s++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=(0,a.m9)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return Qi(e.M,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=Xs.fromDate(t);return{timestampValue:Jo(e.M,n)}}if(t instanceof Xs){const n=new Xs(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:Jo(e.M,n)}}if(t instanceof ff)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof lf)return{bytesValue:Zo(e.M,t._byteString)};if(t instanceof Ld){const n=e.databaseId,s=t.firestore._databaseId;if(!s.isEqual(n))throw e.ac(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:na(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.ac(`Unsupported field value: ${xd(t)}`)}(t,e)}function Mf(t,e){const n={};return er(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):tr(t,((t,s)=>{const r=kf(s,e.sc(t));null!=r&&(n[t]=r)})),{mapValue:{fields:n}}}function Rf(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof Xs||t instanceof ff||t instanceof lf||t instanceof Ld||t instanceof df)}function Lf(t,e,n){if(!Rf(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const s=xd(n);throw"an object"===s?e.ac(t+" a custom object"):e.ac(t+" "+s)}}function Vf(t,e,n){if((e=(0,a.m9)(e))instanceof cf)return e._internalPath;if("string"==typeof e)return Of(t,e);throw Ff("Field path arguments must be of type string or ",t,!1,void 0,n)}const Pf=new RegExp("[~\\*/\\[\\]]");function Of(t,e,n){if(e.search(Pf)>=0)throw Ff(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new cf(...e.split("."))._internalPath}catch(s){throw Ff(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Ff(t,e,n,s,r){const i=s&&!s.isEmpty(),o=void 0!==r;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${s}`),o&&(u+=` in document ${r}`),u+=")"),new Ls(Rs.INVALID_ARGUMENT,a+t+u)}function qf(t,e){return t.some((t=>t.isEqual(e)))}class Uf{constructor(t,e,n,s,r){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=s,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new Ld(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new Bf(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(Kf("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Bf extends Uf{data(){return super.data()}}function Kf(t,e){return"string"==typeof e?Of(t,e):e instanceof cf?e._internalPath:e._delegate._internalPath}class Gf{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class jf extends Uf{constructor(t,e,n,s,r,i){super(t,e,n,s,i),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new $f(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(Kf("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class $f extends jf{data(t={}){return super.data(t)}}class zf{constructor(t,e,n,s){this._firestore=t,this._userDataWriter=e,this._snapshot=s,this.metadata=new Gf(s.hasPendingWrites,s.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new $f(this._firestore,this._userDataWriter,n.key,n,new Gf(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Ls(Rs.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>({type:"added",doc:new $f(t._firestore,t._userDataWriter,n.doc.key,n.doc,new Gf(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter),oldIndex:-1,newIndex:e++})))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const s=new $f(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Gf(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let r=-1,i=-1;return 0!==e.type&&(r=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:Qf(e.type),doc:s,oldIndex:r,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Qf(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Ns()}}function Wf(t,e){return t instanceof jf&&e instanceof jf?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof zf&&e instanceof zf&&t._firestore===e._firestore&&Bd(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Hf(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new Ls(Rs.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Yf{}function Xf(t,...e){for(const n of e)t=n._apply(t);return t}class Jf extends Yf{constructor(t,e,n){super(),this._c=t,this.wc=e,this.mc=n,this.type="where"}_apply(t){const e=If(t.firestore),n=function(t,e,n,s,r,i,o){let a;if(r.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){fm(o,i);const e=[];for(const n of o)e.push(dm(s,t,n));a={arrayValue:{values:e}}}else a=dm(s,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||fm(o,i),a=Cf(n,"where",o,"in"===i||"not-in"===i);const u=gi.create(r,i,a);return function(t,e){if(e.S()){const n=Ri(t);if(null!==n&&!n.isEqual(e.field))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${e.field.toString()}'`);const s=Mi(t);null!==s&&mm(0,e.field,s)}const n=function(t,e){for(const n of t.filters)if(e.indexOf(n.op)>=0)return n.op;return null}(t,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new Ls(Rs.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Ls(Rs.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}(t,u),u}(t._query,0,e,t.firestore._databaseId,this._c,this.wc,this.mc);return new Vd(t.firestore,t.converter,function(t,e){const n=t.filters.concat([e]);return new Ni(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}(t._query,n))}}function Zf(t,e,n){const s=e,r=Kf("where",t);return new Jf(r,s,n)}class tm extends Yf{constructor(t,e){super(),this._c=t,this.gc=e,this.type="orderBy"}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new Ls(Rs.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new Ls(Rs.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const s=new _i(e,n);return function(t,e){if(null===Mi(t)){const n=Ri(t);null!==n&&mm(0,n,e.field)}}(t,s),s}(t._query,this._c,this.gc);return new Vd(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new Ni(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function em(t,e="asc"){const n=e,s=Kf("orderBy",t);return new tm(s,n)}class nm extends Yf{constructor(t,e,n){super(),this.type=t,this.yc=e,this.Ic=n}_apply(t){return new Vd(t.firestore,t.converter,Oi(t._query,this.yc,this.Ic))}}function sm(t){return Cd("limit",t),new nm("limit",t,"F")}function rm(t){return Cd("limitToLast",t),new nm("limitToLast",t,"L")}class im extends Yf{constructor(t,e,n){super(),this.type=t,this.Tc=e,this.Ec=n}_apply(t){const e=lm(t,this.type,this.Tc,this.Ec);return new Vd(t.firestore,t.converter,function(t,e){return new Ni(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function om(...t){return new im("startAt",t,!0)}function am(...t){return new im("startAfter",t,!1)}class um extends Yf{constructor(t,e,n){super(),this.type=t,this.Tc=e,this.Ec=n}_apply(t){const e=lm(t,this.type,this.Tc,this.Ec);return new Vd(t.firestore,t.converter,function(t,e){return new Ni(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function cm(...t){return new um("endBefore",t,!1)}function hm(...t){return new um("endAt",t,!0)}function lm(t,e,n,s){if(n[0]=(0,a.m9)(n[0]),n[0]instanceof Uf)return function(t,e,n,s,r){if(!s)throw new Ls(Rs.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Vi(t))if(n.field.isKeyField())i.push(kr(e,s.key));else{const t=s.data.field(n.field);if(fr(t))throw new Ls(Rs.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new Si(i,r)}(t._query,t.firestore._databaseId,e,n[0]._document,s);{const r=If(t.firestore);return function(t,e,n,s,r,i){const o=t.explicitOrderBy;if(r.length>o.length)throw new Ls(Rs.INVALID_ARGUMENT,`Too many arguments provided to ${s}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<r.length;i++){const u=r[i];if(o[i].field.isKeyField()){if("string"!=typeof u)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${s}(), but got a ${typeof u}`);if(!Li(t)&&-1!==u.indexOf("/"))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${s}() must be a plain document ID, but '${u}' contains a slash.`);const n=t.path.child(sr.fromString(u));if(!br.isDocumentKey(n))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${s}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const r=new br(n);a.push(kr(e,r))}else{const t=Cf(n,s,u);a.push(t)}}return new Si(a,i)}(t._query,t.firestore._databaseId,r,e,n,s)}}function dm(t,e,n){if("string"==typeof(n=(0,a.m9)(n))){if(""===n)throw new Ls(Rs.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Li(e)&&-1!==n.indexOf("/"))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const s=e.path.child(sr.fromString(n));if(!br.isDocumentKey(s))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${s}' is not because it has an odd number of segments (${s.length}).`);return kr(t,new br(s))}if(n instanceof Ld)return kr(t,n._key);throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${xd(n)}.`)}function fm(t,e){if(!Array.isArray(t)||0===t.length)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(t.length>10)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function mm(t,e,n){if(!n.isEqual(e))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}const gm={maxAttempts:5};class pm{convertValue(t,e="none"){switch(Sr(t)){case 0:return null;case 1:return t.booleanValue;case 2:return lr(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(dr(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw Ns()}}convertObject(t,e){const n={};return tr(t.fields,((t,s)=>{n[t]=this.convertValue(s,e)})),n}convertGeoPoint(t){return new ff(lr(t.latitude),lr(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=mr(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(gr(t));default:return null}}convertTimestamp(t){const e=hr(t);return new Xs(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=sr.fromString(t);Cs(_a(n));const s=new yr(n.get(1),n.get(3)),r=new br(n.popFirst(5));return s.isEqual(e)||As(`Document ${r} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}function ym(t,e,n){let s;return s=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,s}class wm extends pm{constructor(t){super(),this.firestore=t}convertBytes(t){return new lf(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Ld(this.firestore,null,e)}}class vm{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=If(t)}set(t,e,n){this._verifyNotCommitted();const s=Im(t,this._firestore),r=ym(s.converter,e,n),i=bf(this._dataReader,"WriteBatch.set",s._key,r,null!==s.converter,n);return this._mutations.push(i.toMutation(s._key,uo.none())),this}update(t,e,n,...s){this._verifyNotCommitted();const r=Im(t,this._firestore);let i;return i="string"==typeof(e=(0,a.m9)(e))||e instanceof cf?Nf(this._dataReader,"WriteBatch.update",r._key,e,n,s):xf(this._dataReader,"WriteBatch.update",r._key,e),this._mutations.push(i.toMutation(r._key,uo.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=Im(t,this._firestore);return this._mutations=this._mutations.concat(new To(e._key,uo.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Ls(Rs.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Im(t,e){if((t=(0,a.m9)(t)).firestore!==e)throw new Ls(Rs.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}function bm(t){t=Nd(t,Ld);const e=Nd(t.firestore,zd);return bd(Hd(e),t._key).then((n=>Vm(e,t,n)))}class Tm extends pm{constructor(t){super(),this.firestore=t}convertBytes(t){return new lf(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Ld(this.firestore,null,e)}}function Em(t){t=Nd(t,Ld);const e=Nd(t.firestore,zd),n=Hd(e),s=new Tm(e);return function(t,e){const n=new Vs;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await function(t,e){const n=Ms(t);return n.persistence.runTransaction("read document","readonly",(t=>n.fi.Ls(t,e)))}(t,e);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Ls(Rs.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const s=ol(t,`Failed to get document '${e} from cache`);n.reject(s)}}(await yd(t),e,n))),n.promise}(n,t._key).then((n=>new jf(e,s,t._key,n,new Gf(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Sm(t){t=Nd(t,Ld);const e=Nd(t.firestore,zd);return bd(Hd(e),t._key,{source:"server"}).then((n=>Vm(e,t,n)))}function _m(t){t=Nd(t,Vd);const e=Nd(t.firestore,zd),n=Hd(e),s=new Tm(e);return Hf(t._query),Td(n,t._query).then((n=>new zf(e,s,t,n)))}function Am(t){t=Nd(t,Vd);const e=Nd(t.firestore,zd),n=Hd(e),s=new Tm(e);return function(t,e){const n=new Vs;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await jc(t,e,!0),r=new Sl(e,s._i),i=r.Wu(s.documents),o=r.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const s=ol(t,`Failed to execute query '${e} against cache`);n.reject(s)}}(await yd(t),e,n))),n.promise}(n,t._query).then((n=>new zf(e,s,t,n)))}function Dm(t){t=Nd(t,Vd);const e=Nd(t.firestore,zd),n=Hd(e),s=new Tm(e);return Td(n,t._query,{source:"server"}).then((n=>new zf(e,s,t,n)))}function xm(t,e,n){t=Nd(t,Ld);const s=Nd(t.firestore,zd),r=ym(t.converter,e,n);return Lm(s,[bf(If(s),"setDoc",t._key,r,null!==t.converter,n).toMutation(t._key,uo.none())])}function Nm(t,e,n,...s){t=Nd(t,Ld);const r=Nd(t.firestore,zd),i=If(r);let o;return o="string"==typeof(e=(0,a.m9)(e))||e instanceof cf?Nf(i,"updateDoc",t._key,e,n,s):xf(i,"updateDoc",t._key,e),Lm(r,[o.toMutation(t._key,uo.exists(!0))])}function Cm(t){return Lm(Nd(t.firestore,zd),[new To(t._key,uo.none())])}function km(t,e){const n=Nd(t.firestore,zd),s=qd(t),r=ym(t.converter,e);return Lm(n,[bf(If(t.firestore),"addDoc",s._key,r,null!==t.converter,{}).toMutation(s._key,uo.exists(!1))]).then((()=>s))}function Mm(t,...e){var n,s,r;t=(0,a.m9)(t);let i={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||Gd(e[o])||(i=e[o],o++);const u={includeMetadataChanges:i.includeMetadataChanges};if(Gd(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(s=t.error)||void 0===s?void 0:s.bind(t),e[o+2]=null===(r=t.complete)||void 0===r?void 0:r.bind(t)}let c,h,l;if(t instanceof Ld)h=Nd(t.firestore,zd),l=ki(t._key.path),c={next:n=>{e[o]&&e[o](Vm(h,t,n))},error:e[o+1],complete:e[o+2]};else{const n=Nd(t,Vd);h=Nd(n.firestore,zd),l=n._query;const s=new Tm(h);c={next:t=>{e[o]&&e[o](new zf(h,s,n,t))},error:e[o+1],complete:e[o+2]},Hf(t._query)}return function(t,e,n,s){const r=new ad(s),i=new yl(e,r,n);return t.asyncQueue.enqueueAndForget((async()=>dl(await Id(t),i))),()=>{r.Aa(),t.asyncQueue.enqueueAndForget((async()=>fl(await Id(t),i)))}}(Hd(h),l,u,c)}function Rm(t,e){return function(t,e){const n=new ad(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){Ms(t).bu.add(e),e.next()}(await Id(t),n))),()=>{n.Aa(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){Ms(t).bu.delete(e)}(await Id(t),n)))}}(Hd(t=Nd(t,zd)),Gd(e)?e:{next:e})}function Lm(t,e){return function(t,e){const n=new Vs;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const s=ed(t);try{const t=await function(t,e){const n=Ms(t),s=Xs.now(),r=e.reduce(((t,e)=>t.add(e.key)),Oo());let i;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>n.fi.Ks(t,r).next((r=>{i=r;const o=[];for(const t of e){const e=mo(t,i.get(t.key));null!=e&&o.push(new wo(t.key,e,jr(e.value.mapValue),uo.exists(!0)))}return n.Bs.addMutationBatch(t,s,o,e)})))).then((t=>(t.applyToLocalDocumentSet(i),{batchId:t.batchId,changes:i})))}(s.localStore,e);s.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let s=t.ha[t.currentUser.toKey()];s||(s=new ei(Ws)),s=s.insert(e,n),t.ha[t.currentUser.toKey()]=s}(s,t.batchId,n),await Gl(s,t.changes),await zh(s.remoteStore)}catch(t){const e=ol(t,"Failed to persist write");n.reject(e)}}(await vd(t),e,n))),n.promise}(Hd(t),e)}function Vm(t,e,n){const s=n.docs.get(e._key),r=new Tm(t);return new jf(t,r,e._key,s,new Gf(n.hasPendingWrites,n.fromCache),e.converter)}class Pm extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=If(t)}get(t){const e=Im(t,this._firestore),n=new wm(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return Ns();const s=t[0];if(s.isFoundDocument())return new Uf(this._firestore,n,s.key,s,e.converter);if(s.isNoDocument())return new Uf(this._firestore,n,e._key,null,e.converter);throw Ns()}))}set(t,e,n){const s=Im(t,this._firestore),r=ym(s.converter,e,n),i=bf(this._dataReader,"Transaction.set",s._key,r,null!==s.converter,n);return this._transaction.set(s._key,i),this}update(t,e,n,...s){const r=Im(t,this._firestore);let i;return i="string"==typeof(e=(0,a.m9)(e))||e instanceof cf?Nf(this._dataReader,"Transaction.update",r._key,e,n,s):xf(this._dataReader,"Transaction.update",r._key,e),this._transaction.update(r._key,i),this}delete(t){const e=Im(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=Im(t,this._firestore),n=new Tm(this._firestore);return super.get(t).then((t=>new jf(this._firestore,n,e._key,t._document,new Gf(!1,!1),e.converter)))}}function Om(t,e,n){t=Nd(t,zd);const s=Object.assign(Object.assign({},gm),n);return function(t){if(t.maxAttempts<1)throw new Ls(Rs.INVALID_ARGUMENT,"Max attempts must be at least 1")}(s),function(t,e,n){const s=new Vs;return t.asyncQueue.enqueueAndForget((async()=>{const r=await function(t){return gd(t).then((t=>t.datastore))}(t);new hd(t.asyncQueue,r,n,e,s).run()})),s.promise}(Hd(t),(n=>e(new Pm(t,n))),s)}function Fm(){return new Tf("deleteField")}function qm(){return new Sf("serverTimestamp")}function Um(...t){return new _f("arrayUnion",t)}function Bm(...t){return new Af("arrayRemove",t)}function Km(t){return new Df("increment",t)}function Gm(t){return Hd(t=Nd(t,zd)),new vm(t,(e=>Lm(t,e)))}function jm(t,e){Hd(t=Nd(t,zd));const n="string"==typeof e?function(t){try{return JSON.parse(t)}catch(t){throw new Ls(Rs.INVALID_ARGUMENT,"Failed to parse JSON:"+t.message)}}(e):e,s=[];if(Array.isArray(n.indexes))for(const t of n.indexes){const e=$m(t,"collectionGroup"),n=[];if(Array.isArray(t.fields))for(const e of t.fields){const t=Of("setIndexConfiguration",$m(e,"fieldPath"));"CONTAINS"===e.arrayConfig?n.push(new Hr(t,2)):"ASCENDING"===e.order?n.push(new Hr(t,0)):"DESCENDING"===e.order&&n.push(new Hr(t,1))}s.push(new zr(zr.UNKNOWN_ID,e,n,Yr.empty()))}return Promise.resolve()}function $m(t,e){if("string"!=typeof t[e])throw new Ls(Rs.INVALID_ARGUMENT,"Missing string value for: "+e);return t[e]}!function(t,e=!0){!function(t){bs=t}(r.SDK_VERSION),(0,r._registerComponent)(new i.wA("firestore",((t,{options:n})=>{const s=t.getProvider("app").getImmediate(),r=new zd(s,new qs(t.getProvider("auth-internal")),new Gs(t.getProvider("app-check-internal")));return n=Object.assign({useFetchStreams:e},n),r._setSettings(n),r}),"PUBLIC")),(0,r.registerVersion)(vs,"3.4.9",t),(0,r.registerVersion)(vs,"3.4.9","esm2017")}()}}]);